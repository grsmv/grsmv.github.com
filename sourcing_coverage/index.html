<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Sourcing</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.7.1/application.js' type='text/javascript'></script>    
    <link href='./assets/0.7.1/application.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="./assets/0.7.1/favicon_red.png" />
    <link rel="icon" type="image/png" href="./assets/0.7.1/favicon.png" />
  </head>
  
  <body>
    <div id="loading">
      <img src="./assets/0.7.1/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" style="display:none;">
      <div class="timestamp">Generated <abbr class="timeago" title="2013-04-26T14:32:20+00:00">2013-04-26T14:32:20+00:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent"><span class="red">47.46%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         2.2
       </span>
    </span> hits/line)
  </h2>
  <a name="AllFiles"></a>
  <div>
    <b>44</b> files in total.
    <b>2693</b> relevant lines. 
    <span class="green"><b>1278</b> lines covered</span> and
    <span class="red"><b>1415</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#8683ea9203d9c60cde78e0f98a48e5e6a6be059f" class="src_link" title="app/controllers/quotes/base_controller.rb">app/controllers/quotes/base_controller.rb</a></td>
        <td class="red strong">31.25 %</td>
        <td>53</td>
        <td>32</td>
        <td>10</td>
        <td>22</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#adf56a0e29939e58eecd64d70940914bb67642fa" class="src_link" title="app/controllers/quotes/bidding_responses_bids_controller.rb">app/controllers/quotes/bidding_responses_bids_controller.rb</a></td>
        <td class="red strong">20.83 %</td>
        <td>166</td>
        <td>48</td>
        <td>10</td>
        <td>38</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c528d194fd296435eace146a1c49d7b570c782da" class="src_link" title="app/controllers/quotes/bidding_responses_controller.rb">app/controllers/quotes/bidding_responses_controller.rb</a></td>
        <td class="green strong">96.0 %</td>
        <td>44</td>
        <td>25</td>
        <td>24</td>
        <td>1</td>
        <td>3.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#203e521e39efad881090640c7ce2c73c991cd349" class="src_link" title="app/controllers/quotes/bidding_responses_graph_controller.rb">app/controllers/quotes/bidding_responses_graph_controller.rb</a></td>
        <td class="red strong">36.07 %</td>
        <td>346</td>
        <td>122</td>
        <td>44</td>
        <td>78</td>
        <td>1.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f5e71b7d5e714f1d0a44c3c62adb531fb372ef92" class="src_link" title="app/controllers/quotes/buyer_messages_controller.rb">app/controllers/quotes/buyer_messages_controller.rb</a></td>
        <td class="red strong">18.18 %</td>
        <td>65</td>
        <td>33</td>
        <td>6</td>
        <td>27</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#882ae31b8658e4727d62dba09269575a712a600b" class="src_link" title="app/controllers/quotes/complete_responses_controller.rb">app/controllers/quotes/complete_responses_controller.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>24</td>
        <td>15</td>
        <td>15</td>
        <td>0</td>
        <td>5.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#30b500396557cd6c8e33793e028d88a04fe96ea8" class="src_link" title="app/controllers/quotes/external_responses_bids_controller.rb">app/controllers/quotes/external_responses_bids_controller.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>102</td>
        <td>48</td>
        <td>48</td>
        <td>0</td>
        <td>4.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ef48241d5e98ce830c4e56372ad8bf7f2b92e051" class="src_link" title="app/controllers/quotes/external_responses_controller.rb">app/controllers/quotes/external_responses_controller.rb</a></td>
        <td class="red strong">55.71 %</td>
        <td>439</td>
        <td>210</td>
        <td>117</td>
        <td>93</td>
        <td>2.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0c0cf02bf8175642154b0170f98c7c9d848960c7" class="src_link" title="app/controllers/quotes/external_responses_graph_controller.rb">app/controllers/quotes/external_responses_graph_controller.rb</a></td>
        <td class="red strong">60.27 %</td>
        <td>225</td>
        <td>73</td>
        <td>44</td>
        <td>29</td>
        <td>3.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ad775ebe73f7c1e7b322c0e802a74f4f6de8aaed" class="src_link" title="app/controllers/quotes/prebidding_responses_controller.rb">app/controllers/quotes/prebidding_responses_controller.rb</a></td>
        <td class="red strong">26.47 %</td>
        <td>58</td>
        <td>34</td>
        <td>9</td>
        <td>25</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#fc8106423bf2d339eca1faec7eb0eb2e0ea53cd2" class="src_link" title="app/controllers/quotes/related_persons_controller.rb">app/controllers/quotes/related_persons_controller.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>50</td>
        <td>19</td>
        <td>19</td>
        <td>0</td>
        <td>3.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#deb3c31f544bfd7d7fa27e34bb590853ca42352c" class="src_link" title="app/controllers/quotes/request_attachments_controller.rb">app/controllers/quotes/request_attachments_controller.rb</a></td>
        <td class="green strong">92.86 %</td>
        <td>29</td>
        <td>14</td>
        <td>13</td>
        <td>1</td>
        <td>2.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#016c3d899118abd582abbd791d56c2c4a30b9db1" class="src_link" title="app/controllers/quotes/requests_controller.rb">app/controllers/quotes/requests_controller.rb</a></td>
        <td class="red strong">29.02 %</td>
        <td>1092</td>
        <td>579</td>
        <td>168</td>
        <td>411</td>
        <td>2.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#bf81a295d985af7788f6bfbdf3c528e71dafa9bf" class="src_link" title="app/controllers/quotes/requests_lines_controller.rb">app/controllers/quotes/requests_lines_controller.rb</a></td>
        <td class="red strong">24.44 %</td>
        <td>127</td>
        <td>45</td>
        <td>11</td>
        <td>34</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7d08401f07bae00bfe8930faeac78cd9f11cc6e1" class="src_link" title="app/controllers/quotes/requests_lots_controller.rb">app/controllers/quotes/requests_lots_controller.rb</a></td>
        <td class="red strong">32.53 %</td>
        <td>240</td>
        <td>83</td>
        <td>27</td>
        <td>56</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f43a632a658418a6764cad0efbdacd13565ddaeb" class="src_link" title="app/controllers/quotes/responses_lines_controller.rb">app/controllers/quotes/responses_lines_controller.rb</a></td>
        <td class="red strong">16.67 %</td>
        <td>101</td>
        <td>42</td>
        <td>7</td>
        <td>35</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3d71351d3207499075fd8a9e455bd551059dbb22" class="src_link" title="app/controllers/quotes/responses_lots_controller.rb">app/controllers/quotes/responses_lots_controller.rb</a></td>
        <td class="red strong">20.0 %</td>
        <td>127</td>
        <td>50</td>
        <td>10</td>
        <td>40</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#42e3046b2b19609b71ea48d75e928315f2773ac2" class="src_link" title="app/controllers/quotes/supplier_items_controller.rb">app/controllers/quotes/supplier_items_controller.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>9</td>
        <td>6</td>
        <td>6</td>
        <td>0</td>
        <td>3.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3f2a758245a954e8939eeb958a05ccb88d260bd8" class="src_link" title="app/controllers/quotes/supplier_messages_controller.rb">app/controllers/quotes/supplier_messages_controller.rb</a></td>
        <td class="red strong">21.43 %</td>
        <td>60</td>
        <td>28</td>
        <td>6</td>
        <td>22</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#be16c9293a588f85ed59e1f49c1e67ac4ecc6b6c" class="src_link" title="app/controllers/quotes/suppliers_controller.rb">app/controllers/quotes/suppliers_controller.rb</a></td>
        <td class="red strong">48.28 %</td>
        <td>115</td>
        <td>58</td>
        <td>28</td>
        <td>30</td>
        <td>1.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#94af28d525a074966fc3f55dc6cffcc7ed651cbd" class="src_link" title="app/models/bid.rb">app/models/bid.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#78668c3b184544aaabe70811f383eb9d02899d16" class="src_link" title="app/models/bid_amount_line.rb">app/models/bid_amount_line.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>5</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#17f669229bed678ae92155e5fa2d609beba245b4" class="src_link" title="app/models/bid_quantity_line.rb">app/models/bid_quantity_line.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>5</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f68b4032435d81283bf318fcf9a2a2b1a216ce20" class="src_link" title="app/models/buyer_message.rb">app/models/buyer_message.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>3</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2bcb4dae50305d873e0e19060ed9f1d9bcc05d9a" class="src_link" title="app/models/pre_bid.rb">app/models/pre_bid.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1f9c6ed91ba38514c3c393bb0d7036f227ed08cc" class="src_link" title="app/models/pre_bid_amount_line.rb">app/models/pre_bid_amount_line.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>5</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#abce4b4a61d1dc318d6ad97a00d0d65f06a1ad5b" class="src_link" title="app/models/pre_bid_quantity_line.rb">app/models/pre_bid_quantity_line.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>5</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1f311080e81461ef182f855ba7a02398fbad4c29" class="src_link" title="app/models/quote_message.rb">app/models/quote_message.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>9</td>
        <td>7</td>
        <td>7</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0d91401fd9ef356fb9cef98887f3987236cfab7f" class="src_link" title="app/models/quote_message_body.rb">app/models/quote_message_body.rb</a></td>
        <td class="red strong">75.0 %</td>
        <td>8</td>
        <td>4</td>
        <td>3</td>
        <td>1</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#51f910ebc7e579ba8d5a4ab407bca18c7f6ad04e" class="src_link" title="app/models/quote_request.rb">app/models/quote_request.rb</a></td>
        <td class="red strong">65.36 %</td>
        <td>834</td>
        <td>459</td>
        <td>300</td>
        <td>159</td>
        <td>29.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ec6007caaf4fcb5392f50e5af7651012f2097bac" class="src_link" title="app/models/quote_request_amount_line.rb">app/models/quote_request_amount_line.rb</a></td>
        <td class="red strong">45.45 %</td>
        <td>47</td>
        <td>22</td>
        <td>10</td>
        <td>12</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a3579a1dfc1b506f257e801eea6af3ba786a323e" class="src_link" title="app/models/quote_request_attachment.rb">app/models/quote_request_attachment.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>14</td>
        <td>10</td>
        <td>10</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5c6f8b6339ea5c1eb81aba4a9bb16a74a01a5611" class="src_link" title="app/models/quote_request_attachment_response.rb">app/models/quote_request_attachment_response.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>9</td>
        <td>7</td>
        <td>7</td>
        <td>0</td>
        <td>1.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#395924abfc4454d50032491208c5ad3a8154ba06" class="src_link" title="app/models/quote_request_line.rb">app/models/quote_request_line.rb</a></td>
        <td class="red strong">66.67 %</td>
        <td>108</td>
        <td>54</td>
        <td>36</td>
        <td>18</td>
        <td>1.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0beb5a0addc9c34ea87ff49f37cc88ea41cf825f" class="src_link" title="app/models/quote_request_quantity_line.rb">app/models/quote_request_quantity_line.rb</a></td>
        <td class="red strong">50.0 %</td>
        <td>34</td>
        <td>14</td>
        <td>7</td>
        <td>7</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#220ac86663a72f30dcb35041b7791b513a181ce1" class="src_link" title="app/models/quote_requests_lot.rb">app/models/quote_requests_lot.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>7</td>
        <td>5</td>
        <td>5</td>
        <td>0</td>
        <td>2.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5dae0fd76a6bcc2af7f8017b3dfac9b5238050cc" class="src_link" title="app/models/quote_requests_user.rb">app/models/quote_requests_user.rb</a></td>
        <td class="yellow strong">85.71 %</td>
        <td>29</td>
        <td>14</td>
        <td>12</td>
        <td>2</td>
        <td>1.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#bcfff50cf2f37f68ccb70a76e529cf50735e4784" class="src_link" title="app/models/quote_response.rb">app/models/quote_response.rb</a></td>
        <td class="red strong">44.03 %</td>
        <td>607</td>
        <td>318</td>
        <td>140</td>
        <td>178</td>
        <td>2.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#32b141e6594075511222309aa9d915cb1a06b7fe" class="src_link" title="app/models/quote_response_amount_line.rb">app/models/quote_response_amount_line.rb</a></td>
        <td class="red strong">52.63 %</td>
        <td>38</td>
        <td>19</td>
        <td>10</td>
        <td>9</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#24c371991cc6b919505cc2fe3e76daaed924b6b7" class="src_link" title="app/models/quote_response_line.rb">app/models/quote_response_line.rb</a></td>
        <td class="red strong">52.88 %</td>
        <td>195</td>
        <td>104</td>
        <td>55</td>
        <td>49</td>
        <td>2.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e195501446d1d182b8ed8504af7a0c5909a92efa" class="src_link" title="app/models/quote_response_lot.rb">app/models/quote_response_lot.rb</a></td>
        <td class="red strong">12.5 %</td>
        <td>25</td>
        <td>16</td>
        <td>2</td>
        <td>14</td>
        <td>0.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e063ac2c26295640ae27ff9675d8c6a579e3d8e7" class="src_link" title="app/models/quote_response_quantity_line.rb">app/models/quote_response_quantity_line.rb</a></td>
        <td class="red strong">53.85 %</td>
        <td>25</td>
        <td>13</td>
        <td>7</td>
        <td>6</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4f94c8e7088807404067fe2b179cc409d1da545a" class="src_link" title="app/models/quote_supplier.rb">app/models/quote_supplier.rb</a></td>
        <td class="red strong">66.67 %</td>
        <td>98</td>
        <td>54</td>
        <td>36</td>
        <td>18</td>
        <td>6.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b24902708fee803d50fddb92c02ef188b4c7a786" class="src_link" title="app/models/supplier_message.rb">app/models/supplier_message.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>3</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
    </tbody>
  </table>
</div>


        
          <div class="file_list_container" id="Controllers">
  <h2>
    <span class="group_name">Controllers</span>
    (<span class="covered_percent"><span class="red">39.77%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         1.83
       </span>
    </span> hits/line)
  </h2>
  <a name="Controllers"></a>
  <div>
    <b>20</b> files in total.
    <b>1564</b> relevant lines. 
    <span class="green"><b>622</b> lines covered</span> and
    <span class="red"><b>942</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#8683ea9203d9c60cde78e0f98a48e5e6a6be059f" class="src_link" title="app/controllers/quotes/base_controller.rb">app/controllers/quotes/base_controller.rb</a></td>
        <td class="red strong">31.25 %</td>
        <td>53</td>
        <td>32</td>
        <td>10</td>
        <td>22</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#adf56a0e29939e58eecd64d70940914bb67642fa" class="src_link" title="app/controllers/quotes/bidding_responses_bids_controller.rb">app/controllers/quotes/bidding_responses_bids_controller.rb</a></td>
        <td class="red strong">20.83 %</td>
        <td>166</td>
        <td>48</td>
        <td>10</td>
        <td>38</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c528d194fd296435eace146a1c49d7b570c782da" class="src_link" title="app/controllers/quotes/bidding_responses_controller.rb">app/controllers/quotes/bidding_responses_controller.rb</a></td>
        <td class="green strong">96.0 %</td>
        <td>44</td>
        <td>25</td>
        <td>24</td>
        <td>1</td>
        <td>3.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#203e521e39efad881090640c7ce2c73c991cd349" class="src_link" title="app/controllers/quotes/bidding_responses_graph_controller.rb">app/controllers/quotes/bidding_responses_graph_controller.rb</a></td>
        <td class="red strong">36.07 %</td>
        <td>346</td>
        <td>122</td>
        <td>44</td>
        <td>78</td>
        <td>1.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f5e71b7d5e714f1d0a44c3c62adb531fb372ef92" class="src_link" title="app/controllers/quotes/buyer_messages_controller.rb">app/controllers/quotes/buyer_messages_controller.rb</a></td>
        <td class="red strong">18.18 %</td>
        <td>65</td>
        <td>33</td>
        <td>6</td>
        <td>27</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#882ae31b8658e4727d62dba09269575a712a600b" class="src_link" title="app/controllers/quotes/complete_responses_controller.rb">app/controllers/quotes/complete_responses_controller.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>24</td>
        <td>15</td>
        <td>15</td>
        <td>0</td>
        <td>5.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#30b500396557cd6c8e33793e028d88a04fe96ea8" class="src_link" title="app/controllers/quotes/external_responses_bids_controller.rb">app/controllers/quotes/external_responses_bids_controller.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>102</td>
        <td>48</td>
        <td>48</td>
        <td>0</td>
        <td>4.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ef48241d5e98ce830c4e56372ad8bf7f2b92e051" class="src_link" title="app/controllers/quotes/external_responses_controller.rb">app/controllers/quotes/external_responses_controller.rb</a></td>
        <td class="red strong">55.71 %</td>
        <td>439</td>
        <td>210</td>
        <td>117</td>
        <td>93</td>
        <td>2.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0c0cf02bf8175642154b0170f98c7c9d848960c7" class="src_link" title="app/controllers/quotes/external_responses_graph_controller.rb">app/controllers/quotes/external_responses_graph_controller.rb</a></td>
        <td class="red strong">60.27 %</td>
        <td>225</td>
        <td>73</td>
        <td>44</td>
        <td>29</td>
        <td>3.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ad775ebe73f7c1e7b322c0e802a74f4f6de8aaed" class="src_link" title="app/controllers/quotes/prebidding_responses_controller.rb">app/controllers/quotes/prebidding_responses_controller.rb</a></td>
        <td class="red strong">26.47 %</td>
        <td>58</td>
        <td>34</td>
        <td>9</td>
        <td>25</td>
        <td>0.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#fc8106423bf2d339eca1faec7eb0eb2e0ea53cd2" class="src_link" title="app/controllers/quotes/related_persons_controller.rb">app/controllers/quotes/related_persons_controller.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>50</td>
        <td>19</td>
        <td>19</td>
        <td>0</td>
        <td>3.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#deb3c31f544bfd7d7fa27e34bb590853ca42352c" class="src_link" title="app/controllers/quotes/request_attachments_controller.rb">app/controllers/quotes/request_attachments_controller.rb</a></td>
        <td class="green strong">92.86 %</td>
        <td>29</td>
        <td>14</td>
        <td>13</td>
        <td>1</td>
        <td>2.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#016c3d899118abd582abbd791d56c2c4a30b9db1" class="src_link" title="app/controllers/quotes/requests_controller.rb">app/controllers/quotes/requests_controller.rb</a></td>
        <td class="red strong">29.02 %</td>
        <td>1092</td>
        <td>579</td>
        <td>168</td>
        <td>411</td>
        <td>2.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#bf81a295d985af7788f6bfbdf3c528e71dafa9bf" class="src_link" title="app/controllers/quotes/requests_lines_controller.rb">app/controllers/quotes/requests_lines_controller.rb</a></td>
        <td class="red strong">24.44 %</td>
        <td>127</td>
        <td>45</td>
        <td>11</td>
        <td>34</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7d08401f07bae00bfe8930faeac78cd9f11cc6e1" class="src_link" title="app/controllers/quotes/requests_lots_controller.rb">app/controllers/quotes/requests_lots_controller.rb</a></td>
        <td class="red strong">32.53 %</td>
        <td>240</td>
        <td>83</td>
        <td>27</td>
        <td>56</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f43a632a658418a6764cad0efbdacd13565ddaeb" class="src_link" title="app/controllers/quotes/responses_lines_controller.rb">app/controllers/quotes/responses_lines_controller.rb</a></td>
        <td class="red strong">16.67 %</td>
        <td>101</td>
        <td>42</td>
        <td>7</td>
        <td>35</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3d71351d3207499075fd8a9e455bd551059dbb22" class="src_link" title="app/controllers/quotes/responses_lots_controller.rb">app/controllers/quotes/responses_lots_controller.rb</a></td>
        <td class="red strong">20.0 %</td>
        <td>127</td>
        <td>50</td>
        <td>10</td>
        <td>40</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#42e3046b2b19609b71ea48d75e928315f2773ac2" class="src_link" title="app/controllers/quotes/supplier_items_controller.rb">app/controllers/quotes/supplier_items_controller.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>9</td>
        <td>6</td>
        <td>6</td>
        <td>0</td>
        <td>3.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#3f2a758245a954e8939eeb958a05ccb88d260bd8" class="src_link" title="app/controllers/quotes/supplier_messages_controller.rb">app/controllers/quotes/supplier_messages_controller.rb</a></td>
        <td class="red strong">21.43 %</td>
        <td>60</td>
        <td>28</td>
        <td>6</td>
        <td>22</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#be16c9293a588f85ed59e1f49c1e67ac4ecc6b6c" class="src_link" title="app/controllers/quotes/suppliers_controller.rb">app/controllers/quotes/suppliers_controller.rb</a></td>
        <td class="red strong">48.28 %</td>
        <td>115</td>
        <td>58</td>
        <td>28</td>
        <td>30</td>
        <td>1.9</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
          <div class="file_list_container" id="Models">
  <h2>
    <span class="group_name">Models</span>
    (<span class="covered_percent"><span class="red">58.1%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         2.5
       </span>
    </span> hits/line)
  </h2>
  <a name="Models"></a>
  <div>
    <b>24</b> files in total.
    <b>1129</b> relevant lines. 
    <span class="green"><b>656</b> lines covered</span> and
    <span class="red"><b>473</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#94af28d525a074966fc3f55dc6cffcc7ed651cbd" class="src_link" title="app/models/bid.rb">app/models/bid.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#78668c3b184544aaabe70811f383eb9d02899d16" class="src_link" title="app/models/bid_amount_line.rb">app/models/bid_amount_line.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>5</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#17f669229bed678ae92155e5fa2d609beba245b4" class="src_link" title="app/models/bid_quantity_line.rb">app/models/bid_quantity_line.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>5</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f68b4032435d81283bf318fcf9a2a2b1a216ce20" class="src_link" title="app/models/buyer_message.rb">app/models/buyer_message.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>3</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#2bcb4dae50305d873e0e19060ed9f1d9bcc05d9a" class="src_link" title="app/models/pre_bid.rb">app/models/pre_bid.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>4</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1f9c6ed91ba38514c3c393bb0d7036f227ed08cc" class="src_link" title="app/models/pre_bid_amount_line.rb">app/models/pre_bid_amount_line.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>5</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#abce4b4a61d1dc318d6ad97a00d0d65f06a1ad5b" class="src_link" title="app/models/pre_bid_quantity_line.rb">app/models/pre_bid_quantity_line.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>5</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1f311080e81461ef182f855ba7a02398fbad4c29" class="src_link" title="app/models/quote_message.rb">app/models/quote_message.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>9</td>
        <td>7</td>
        <td>7</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0d91401fd9ef356fb9cef98887f3987236cfab7f" class="src_link" title="app/models/quote_message_body.rb">app/models/quote_message_body.rb</a></td>
        <td class="red strong">75.0 %</td>
        <td>8</td>
        <td>4</td>
        <td>3</td>
        <td>1</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#51f910ebc7e579ba8d5a4ab407bca18c7f6ad04e" class="src_link" title="app/models/quote_request.rb">app/models/quote_request.rb</a></td>
        <td class="red strong">65.36 %</td>
        <td>834</td>
        <td>459</td>
        <td>300</td>
        <td>159</td>
        <td>29.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ec6007caaf4fcb5392f50e5af7651012f2097bac" class="src_link" title="app/models/quote_request_amount_line.rb">app/models/quote_request_amount_line.rb</a></td>
        <td class="red strong">45.45 %</td>
        <td>47</td>
        <td>22</td>
        <td>10</td>
        <td>12</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a3579a1dfc1b506f257e801eea6af3ba786a323e" class="src_link" title="app/models/quote_request_attachment.rb">app/models/quote_request_attachment.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>14</td>
        <td>10</td>
        <td>10</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5c6f8b6339ea5c1eb81aba4a9bb16a74a01a5611" class="src_link" title="app/models/quote_request_attachment_response.rb">app/models/quote_request_attachment_response.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>9</td>
        <td>7</td>
        <td>7</td>
        <td>0</td>
        <td>1.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#395924abfc4454d50032491208c5ad3a8154ba06" class="src_link" title="app/models/quote_request_line.rb">app/models/quote_request_line.rb</a></td>
        <td class="red strong">66.67 %</td>
        <td>108</td>
        <td>54</td>
        <td>36</td>
        <td>18</td>
        <td>1.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0beb5a0addc9c34ea87ff49f37cc88ea41cf825f" class="src_link" title="app/models/quote_request_quantity_line.rb">app/models/quote_request_quantity_line.rb</a></td>
        <td class="red strong">50.0 %</td>
        <td>34</td>
        <td>14</td>
        <td>7</td>
        <td>7</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#220ac86663a72f30dcb35041b7791b513a181ce1" class="src_link" title="app/models/quote_requests_lot.rb">app/models/quote_requests_lot.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>7</td>
        <td>5</td>
        <td>5</td>
        <td>0</td>
        <td>2.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5dae0fd76a6bcc2af7f8017b3dfac9b5238050cc" class="src_link" title="app/models/quote_requests_user.rb">app/models/quote_requests_user.rb</a></td>
        <td class="yellow strong">85.71 %</td>
        <td>29</td>
        <td>14</td>
        <td>12</td>
        <td>2</td>
        <td>1.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#bcfff50cf2f37f68ccb70a76e529cf50735e4784" class="src_link" title="app/models/quote_response.rb">app/models/quote_response.rb</a></td>
        <td class="red strong">44.03 %</td>
        <td>607</td>
        <td>318</td>
        <td>140</td>
        <td>178</td>
        <td>2.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#32b141e6594075511222309aa9d915cb1a06b7fe" class="src_link" title="app/models/quote_response_amount_line.rb">app/models/quote_response_amount_line.rb</a></td>
        <td class="red strong">52.63 %</td>
        <td>38</td>
        <td>19</td>
        <td>10</td>
        <td>9</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#24c371991cc6b919505cc2fe3e76daaed924b6b7" class="src_link" title="app/models/quote_response_line.rb">app/models/quote_response_line.rb</a></td>
        <td class="red strong">52.88 %</td>
        <td>195</td>
        <td>104</td>
        <td>55</td>
        <td>49</td>
        <td>2.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e195501446d1d182b8ed8504af7a0c5909a92efa" class="src_link" title="app/models/quote_response_lot.rb">app/models/quote_response_lot.rb</a></td>
        <td class="red strong">12.5 %</td>
        <td>25</td>
        <td>16</td>
        <td>2</td>
        <td>14</td>
        <td>0.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e063ac2c26295640ae27ff9675d8c6a579e3d8e7" class="src_link" title="app/models/quote_response_quantity_line.rb">app/models/quote_response_quantity_line.rb</a></td>
        <td class="red strong">53.85 %</td>
        <td>25</td>
        <td>13</td>
        <td>7</td>
        <td>6</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#4f94c8e7088807404067fe2b179cc409d1da545a" class="src_link" title="app/models/quote_supplier.rb">app/models/quote_supplier.rb</a></td>
        <td class="red strong">66.67 %</td>
        <td>98</td>
        <td>54</td>
        <td>36</td>
        <td>18</td>
        <td>6.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b24902708fee803d50fddb92c02ef188b4c7a786" class="src_link" title="app/models/supplier_message.rb">app/models/supplier_message.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>3</td>
        <td>1</td>
        <td>1</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
    </tbody>
  </table>
</div>

        
      </div>
    
      <div id="footer">
        Generated by <a href="http://github.com/colszowka/simplecov">simplecov</a> v0.7.1 
        and simplecov-html v0.7.1<br/>
        using RSpec
      </div>
    
      <div class="source_files">
      
        <div class="source_table" id="8683ea9203d9c60cde78e0f98a48e5e6a6be059f">
  <div class="header">
    <h3>app/controllers/quotes/base_controller.rb</h3>
    <h4><span class="red">31.25 %</span> covered</h4>
    <div>
      <b>32</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>22</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># -*- coding: utf-8 -*-</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"># Copyright (C) 2007  Coupa Software Incorporated http://www.coupa.com</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">class Quotes::BaseController &lt; ApplicationController</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  @@max_rfq_lines = 100</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_reader :max_rfq_lines</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  helper :addresses, :suppliers, :requisition_headers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  verify :method =&gt; :get, :only =&gt; [:rtf, :transfer_to_requisition]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  verify :method =&gt; :post, :only =&gt; [:order_from_quote]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    redirect_to quotes_requests_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  def rtf</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    headers['Content-Type'] = 'application/rtf'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    headers['Content-Disposition'] = &quot;attachment; filename=RFQ_#{@quote_request.id}.rtf&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    render :layout =&gt; false, :inline =&gt; @quote_request.to_rtf</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  def order_from_quote</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    quote_response = QuoteResponse.find_in_state(params[:id], :awarded)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    requisition_header = RequisitionHeader.create_from_quote_response(quote_response)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    requisition_header.save(:validate =&gt; false)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    flash[:notice] = translate('quotes_controller.requisition_id_created_from', :id =&gt; requisition_header.id, :position =&gt; quote_response.position, :quote_request =&gt; quote_response.quote_request.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    redirect_to :controller =&gt; 'requisition_headers', :action =&gt; 'edit', :id =&gt; requisition_header</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  # TODO: should be a POST because update_from_quote_request_line does an update_attributes</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  def transfer_to_requisition</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    quote_response = QuoteResponse.find_in_state(params[:id], :awarded)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    requisition_header = quote_response.quote_request.requisition_header</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    unless requisition_header.pending_buyer_action?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      flash[:warning] = translate('quotes_controller.quotes_can_only_be')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      redirect_to :back</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    quote_response.lines.each do |quote_line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      if quote_line.quote_request_line &amp;&amp; quote_line.quote_request_line.requisition_line</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">        quote_line.quote_request_line.requisition_line.update_from_quote_response_line(quote_line)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">        requisition_header.requisition_lines &lt;&lt; RequisitionLine.build_from_quote_response_line(quote_line)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    flash[:notice] = translate('quotes_controller.quote_lines_have_been')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    redirect_to :controller =&gt; 'buying', :action =&gt; 'edit', :id =&gt; requisition_header</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="adf56a0e29939e58eecd64d70940914bb67642fa">
  <div class="header">
    <h3>app/controllers/quotes/bidding_responses_bids_controller.rb</h3>
    <h4><span class="red">20.83 %</span> covered</h4>
    <div>
      <b>48</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>38</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby">##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">#  This class serve for getting data for getting data about best bids. </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">class Quotes::BiddingResponsesBidsController &lt; Quotes::RequestsController</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  layout false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :variables, :except =&gt; [:bids]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # TODO: enable after debug</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # verify :xhr =&gt; true </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  #  Fetching best bids for each lot in event</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  #  TODO: make it only for bids!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  def lots</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    render :json =&gt; -&gt;() do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      common_price_in_bid = -&gt;(supplier, lot) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">        @quote_request.quote_suppliers.where(:id =&gt; supplier.id).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">                      .quote_responses.submitted.order(:id).last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">                      .lines.where(:lot_id =&gt; lot)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">                      .map { |line| line.price_amount * (line.quantity || 1).to_i }.compact.reduce(&amp;:+) rescue nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      @quote_request.lots.map(&amp;:id).concat([0]).map { |lot|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        if lot == 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">          {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">            :id =&gt; lot,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">            :suppliers =&gt; -&gt;() {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">              [{:items =&gt; items_not_in_lots.map { |el|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">                  el[:suppliers].map { |supplier| supplier.merge(:id =&gt; el[:id]) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">                }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">              }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">            }.call</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">          { </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">            :id =&gt; lot,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">            :suppliers =&gt; -&gt;() {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">              prices = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">              @quote_request.quote_suppliers.each { |supplier|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">                prices[supplier.id] = common_price_in_bid.call(supplier, lot) </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">              }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">              best_suppliers(prices, true, lot)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">            }.call</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    end.call</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  # TODO: remove this method after Andrew's approve</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">  def items_not_in_lots</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">    price_in_bid = -&gt;(supplier, line) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      @quote_request.quote_suppliers.where(:id =&gt; supplier.id).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">                    .quote_responses.submitted.order(:id).last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">                    .lines.where(:quote_request_line_id =&gt; line.id, :lot_id =&gt; 0)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">                    .first.price_amount rescue nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">    @quote_request.lines.where(:lot_id =&gt; 0).map { |line|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">        :id =&gt; line.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">        :suppliers =&gt; -&gt;() {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">          prices = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">          </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">          @quote_request.quote_suppliers.each { |supplier|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">            price = price_in_bid.call(supplier, line)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">            prices[supplier.id] = price unless price.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">          best_suppliers(prices)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">        }.call</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">  #  Calculating total price for differrent cases</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">  def weighted_total quote_request = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">    suppliers ||= -&gt;() do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">      (quote_request || @quote_request).quote_suppliers.map { |supplier|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">        supplier_data = (quote_request || @quote_request).quote_suppliers.find(supplier.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">          :id =&gt; supplier.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">          :name =&gt; supplier_data.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">          :logo =&gt; supplier_data.logo.url,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">          :total =&gt; ( supplier.quote_responses.submitted.order(:submitted_at).last.lines.map { |line| </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">            (line.price_amount * (line.quantity || 1).to_i) * (@quote_request.lots.find(line.lot_id).expected_quantity rescue 1) </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">          }.compact.reduce(&amp;:+) rescue nil )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">      }.map { |s| s[:total].nil? ? next : s }.compact</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">    end.call</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    render :json =&gt; { </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">      :best_supplier =&gt; suppliers.delete_if { |k, _| </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        k[:total] != suppliers.map { |a, _|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">          a[:total] </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">        }.sort.first </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">  # NOTE: method that invokes push server to send callback and grab updated data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">  # about best bids on items and lots</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">  def fetch</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">  #  Finding one or more best suppliers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">  def best_suppliers prices, items = false, lot_id = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">    prices.delete_if { |k, v| v.nil? }.map { |id, common_price|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">      if common_price == prices.values.sort[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">        { </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">          :id =&gt; id, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">          :price =&gt; common_price,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">          :name =&gt; @quote_request.quote_suppliers.find(id).name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">          :logo =&gt; @quote_request.quote_suppliers.find(id).logo.url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">        }.merge(items ? {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">          :items =&gt; ( @quote_request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">                      .quote_suppliers.find(id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">                      .quote_responses.submitted.last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">                      .lines.where(:lot_id =&gt; lot_id).map { |line| </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">                        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">                          :id =&gt; line.quote_request_line_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">                          :price =&gt; line.price_amount</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">                        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">                      } rescue {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">        } : {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">    }.compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">  #  Setting common-used variables</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="162">
          <span class="hits">1</span>
          
          <code class="ruby">  def variables</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find params[:id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="c528d194fd296435eace146a1c49d7b570c782da">
  <div class="header">
    <h3>app/controllers/quotes/bidding_responses_controller.rb</h3>
    <h4><span class="green">96.0 %</span> covered</h4>
    <div>
      <b>25</b> relevant lines. 
      <span class="green"><b>24</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Quotes::BiddingResponsesController &lt; Quotes::RequestsController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :load_params, :state_redirect, :only =&gt; [:show, :edit, :update]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :check_suppliers_message, :only =&gt; [:edit]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def edit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="13">
          <span class="hits">3</span>
          
          <code class="ruby">    @quote_request.edit_quote_suppliers(params)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="14">
          <span class="hits">4</span>
          
          <code class="ruby">    exists_before_suppliers = @quote_request.quote_suppliers.map{|s| s.id}</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="15">
          <span class="hits">3</span>
          
          <code class="ruby">    if @quote_request.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      # Send an email each new supplier</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">      @quote_request.quote_suppliers.each do |s|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">        unless exists_before_suppliers.include?(s.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">          s.deliver_mail</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">      redirect_to action: :show</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="24">
          <span class="hits">2</span>
          
          <code class="ruby">      flash[:message] = @quote_request.errors.values.join(&quot;\n&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="25">
          <span class="hits">2</span>
          
          <code class="ruby">      render action: :edit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  def load_params</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="32">
          <span class="hits">11</span>
          
          <code class="ruby">    @quote_request = QuoteRequest.includes(:quote_suppliers).find(params[:id])</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="33">
          <span class="hits">11</span>
          
          <code class="ruby">    @sections_settings ||= sections_settings @quote_request.id</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="34">
          <span class="hits">11</span>
          
          <code class="ruby">    @event_name_title = @quote_request.description.blank? ? t('quotes_controller.request_for_sourcing_event') : @quote_request.description.truncate(25).to_s</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="35">
          <span class="hits">11</span>
          
          <code class="ruby">    @title = t(&quot;quotes_controller.request_for_quote_number&quot;, :event_description =&gt; @event_name_title, :num =&gt; @quote_request.id)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="36">
          <span class="hits">11</span>
          
          <code class="ruby">    @title_modifier = &quot;&lt;span class='smaller'&gt;#{t'quotes_controller.bidding_in_progress'}&lt;/span&gt;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  def state_redirect</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="40">
          <span class="hits">5</span>
          
          <code class="ruby">    if @quote_request.closed?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">      redirect_to quotes_complete_response_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="203e521e39efad881090640c7ce2c73c991cd349">
  <div class="header">
    <h3>app/controllers/quotes/bidding_responses_graph_controller.rb</h3>
    <h4><span class="red">36.07 %</span> covered</h4>
    <div>
      <b>122</b> relevant lines. 
      <span class="green"><b>44</b> lines covered</span> and
      <span class="red"><b>78</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby">##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">#  This class serve for getting data for graph at the bidding responses</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">#  page, visible for Buyer. For save functionality for Suppliers please</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">#  look at app/quotes/bidding_requests_graph_controller.rb</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">#</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">class Quotes::BiddingResponsesGraphController &lt; Quotes::RequestsController</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  skip_before_filter :authorize_action, :only =&gt; [:items_and_lots]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  layout false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :variables, :except =&gt; [:bids, :supplier]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :lists_to_display, :only =&gt; [:linear_history]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # TODO: enable after debug</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  verify :xhr =&gt; true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  #  Returning Event settings</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  #  (start and stop dates, base price)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def settings</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="23">
          <span class="hits">5</span>
          
          <code class="ruby">    format_time = -&gt;(time) { time.strftime(&quot;%a, %d %b %Y %T&quot;) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    render :json =&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        :start      =&gt; format_time.call(@quote_request.start_time),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">        :bidding    =&gt; format_time.call(@quote_request.bidding_time),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">        :end        =&gt; format_time.call(@quote_request.end_time),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">        :servertime =&gt; format_time.call(Time.zone.now),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">        :currency   =&gt; Currency.find(@quote_request.currency_id).code,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">        :finished   =&gt; @quote_request.finished? ? 1 : 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">      } rescue empty_object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  #  List of suppliers, involved in Event</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  def suppliers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    render :json =&gt; suppliers_and_bids</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  #  List of Items and Lots, acquisition of which planned</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  #  is a target of Event</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  def items_and_lots</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    render :json =&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      @quote_request.lots.map { |lot|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">          :id        =&gt; lot.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">          :isLot     =&gt; true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">          :parentLot =&gt; -1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">          :label     =&gt; lot.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">          :currency  =&gt; Currency.find(lot.lines.map(&amp;:price_currency_id).uniq.first).code,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">          :selected  =&gt; true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">          :price     =&gt; lot.lines.inject(0) { |summ, r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">                          summ + ((r.quantity || 1).to_i * (r.price_amount || 0))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">                        }.to_i * lot.expected_quantity</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      } + @quote_request.lines.where(:lot_id =&gt; 0).map { |line|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">          :id        =&gt; line.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">          :isLot     =&gt; false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">          :parentLot =&gt; line.lot_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">          :label     =&gt; line.description,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">          :price     =&gt; ((line.quantity || 1).to_i * (line.price_amount || 0)).to_i,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">          :selected  =&gt; true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">          :currency  =&gt; Currency.find(line.price_currency_id).code</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">      } rescue empty_object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  #  Bridge to Faye channel. It sends all bids of suppliers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">  #  every time when each supplier make bid.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">  def bids id</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="82">
          <span class="hits">6</span>
          
          <code class="ruby">    @quote_request = QuoteRequest.find id</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="83">
          <span class="hits">6</span>
          
          <code class="ruby">    PushMessenger.push(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      &quot;/quotes/bidding_responses/#{@quote_request.id}/graph/bids&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">      suppliers_and_bids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  #  Bridge to Faye channel. It sends information about added supplier</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">  #  every time when owner of Event adds new one.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">  #    @param &lt;Integer&gt; id - quote_request_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  #    @param &lt;Integer&gt; supplier_id - added supplier id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">  def supplier id, supplier_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">    PushMessenger.push(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      &quot;/quote/bidding_responses/#{@quote_request.id}/graph/supplier&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">      suppliers_and_bids.delete_if { |supplier|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">        supplier[:id] != supplier_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">  #  Fetching event's bidding history basing on bid's timestamps</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">  def linear_history</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    render :json =&gt; -&gt;() do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">      -&gt;() do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">        responses = @quote_request.quote_suppliers.map { |supplier|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">          supplier.quote_responses.submitted.map { |response| response }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">        }.flatten.sort_by { |resp| resp.submitted_at }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">        responses.map(&amp;:submitted_at).uniq.map { |time|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">          {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">            time.strftime(&quot;%a, %d %b %Y %T&quot;) =&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">              responses.map(&amp;:quote_supplier_id).uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">                       .map { |supplier_id|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">                {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">                  supplier_id =&gt; -&gt;() do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">                    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">                      response = responses.select { |resp|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">                                    resp.submitted_at.to_i &lt;= time.to_i &amp;&amp;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">                                    resp.quote_supplier.id == supplier_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">                                 }.last</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">                      lines = response.lines</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">                      lines.map(&amp;:lot_id).uniq.delete_if { |lot_id| lot_id.zero? }.map { |lot_id|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">                        if @lots_to_display.include? lot_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">                          {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">                            :id =&gt; lot_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">                            :isLot =&gt; true,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">                            :price =&gt; lines.clone.delete_if { |line| line.lot_id != lot_id }.map { |line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">                                        ((line.price_amount || 0) * (line.quantity || 1).to_i rescue 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">                                      }.reduce(&amp;:+) * QuoteRequestsLot.find(lot_id).expected_quantity</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">                          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">                        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">                      }.compact.concat(</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">                        lines.clone.delete_if { |line| not line.lot_id.zero? }.map { |line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">                          if @items_to_display.include? line.quote_request_line_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">                            {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">                              :id =&gt; line.quote_request_line_id,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">                              :price =&gt; ((line.price_amount || 0) * (line.quantity || 1).to_i rescue 0),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">                              :isLot =&gt; false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">                            }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">                          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">                        }.compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">                      )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">                    rescue</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">                      nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">                    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">                  end.call</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">                }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">              }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">      end.call</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">    end.call</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">  #  Fetching history</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="166">
          <span class="hits">1</span>
          
          <code class="ruby">  def history</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">    make_array = -&gt;(str) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">      str.gsub(/\[|\]/, &quot;&quot;).split(&quot;,&quot;).map(&amp;:to_i) rescue nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">    lots = make_array.call(params[:lots])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">    items = make_array.call(params[:items])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">    render :json =&gt; (@quote_request.quote_suppliers.map do |supplier|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">      { :id =&gt; supplier.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">        :history =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">          :lots =&gt; -&gt;() do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">            _lots = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">            supplier.quote_responses.submitted.each do |response|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">              conditions = lots ? [&quot;lot_id in (?)&quot;, lots] : nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">              response.lines.where(conditions).where(&quot;lot_id &gt; 0&quot;).each do |line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">                (_lots[line.lot_id] ||= {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">                (_lots[line.lot_id][line.quote_response.submitted_at.to_i] ||= []) &lt;&lt;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">                  (line.price_amount || 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">            _lots.map { |id, updates|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">              { id =&gt; updates.map { |date, prices|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">                        { date =&gt; prices.compact.reduce(:+) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">                      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">              }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">          end.call,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">          :items =&gt; -&gt;() do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">            _items = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">            supplier.quote_responses.submitted.each do |response|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">              conditions = items ? [&quot;quote_request_line_id in (?)&quot;, items] : nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">              response.lines.where(conditions).where(&quot;lot_id = 0&quot;).each do |line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">                (_items[line.quote_request_line_id] ||= []) &lt;&lt;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">                  { line.quote_response.submitted_at.to_i =&gt; (line.price_amount || 0) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">            _items</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">          end.call</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">    end)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="211">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">  #  List of suppliers, involved in Event. Also includes all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">  #  current bids</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">  #    @param &lt;Boolean&gt; fetch_history - requirement to give away all bids history</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="219">
          <span class="hits">1</span>
          
          <code class="ruby">  def suppliers_and_bids fetch_history = false</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="220">
          <span class="hits">6</span>
          
          <code class="ruby">    currency = Currency.find_by_id(@quote_request.currency_id).code</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="221">
          <span class="hits">6</span>
          
          <code class="ruby">    @quote_request.quote_suppliers.map do |supplier|</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="222">
          <span class="hits">6</span>
          
          <code class="ruby">      _current_bids = current_bids(supplier)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="223">
          <span class="hits">6</span>
          
          <code class="ruby">      current_bid = _current_bids.map do |type, lines|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="224">
          <span class="hits">12</span>
          
          <code class="ruby">                      lines.map { |line| line.map { |id, bid| bid.to_f } }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">                    end.flatten.compact.reduce(:+) || 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">        :id    =&gt; supplier.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">        :title =&gt; supplier.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">        :currentBids =&gt; _current_bids,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">        :currentBid =&gt; current_bid,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">        :currency =&gt; currency,</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="233">
          <span class="hits">6</span>
          
          <code class="ruby">        :logo =&gt; (supplier.logo.url(:small) == &quot;na.png&quot; ? &quot;&quot; : supplier.logo.url(:small)),</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="234">
          <span class="hits">6</span>
          
          <code class="ruby">        :edit_response_link =&gt; (edit_quotes_internal_response_path(supplier.id) rescue &quot;&quot;)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="235">
          <span class="hits">6</span>
          
          <code class="ruby">      }.merge(fetch_history ? bidding_history_for(supplier) : {})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">    end </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">  #  Grabbing bidding history for supplier</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">  #    @param &lt;Object&gt; supplier</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">  #    @return &lt;Hash&gt; history</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="245">
          <span class="hits">1</span>
          
          <code class="ruby">  def bidding_history_for supplier</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="246">
          
          
          <code class="ruby">    response_lines = -&gt;(id) do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="247">
          
          
          <code class="ruby">      QuoteResponseLine.where(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">        [&quot;quote_response_id in (?) and lot_id #{id}&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">          QuoteResponse.where(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">            :quote_request_id =&gt; @quote_request.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">            :quote_supplier_id =&gt; supplier.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">          ).map { |response| response.id }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">        ]).order(:updated_at)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="256">
          
          
          <code class="ruby">    lines, lots = {}, {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">      :history =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">        :items =&gt; proc {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">          response_lines.call(&quot;= 0&quot;).each do |line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="262">
          
          
          <code class="ruby">            (lines[line.quote_request_line_id] ||= []) &lt;&lt;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="263">
          
          
          <code class="ruby">              { line.quote_response.submitted_at.to_i =&gt; (line.price_amount || 0) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="265">
          
          
          <code class="ruby">          lines</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">        }.call,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">        :lots =&gt; proc {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="268">
          
          
          <code class="ruby">          response_lines.call(&quot;&gt; 0&quot;).each do |line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="269">
          
          
          <code class="ruby">            lots[line.lot_id] ||= {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="270">
          
          
          <code class="ruby">            (lots[line.lot_id][line.quote_response.submitted_at.to_i] ||= []) &lt;&lt;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="271">
          
          
          <code class="ruby">              (line.price_amount || 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="273">
          
          
          <code class="ruby">          lots.map { |id, updates|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">            { id =&gt; updates.map { |date, prices|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">                      { date =&gt; prices.compact.reduce(:+) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">                    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">        }.call</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="281">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">  #  Getting most recent bids for supplier</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">  #    @param &lt;Object&gt; supplier</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="289">
          <span class="hits">1</span>
          
          <code class="ruby">  def current_bids supplier</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="290">
          <span class="hits">6</span>
          
          <code class="ruby">    lines = -&gt;(lot) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">      QuoteResponseLine.where([&quot;lot_id #{lot}&quot;]).where(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">        :quote_response_id =&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">          @quote_request.responses.submitted.select { |r|</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="294">
          <span class="hits">8</span>
          
          <code class="ruby">            r.quote_supplier_id == supplier.id</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="295">
          <span class="hits">8</span>
          
          <code class="ruby">          }.sort_by { |r| r.created_at }.last.id</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="296">
          <span class="hits">12</span>
          
          <code class="ruby">      ) rescue {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">      :items =&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">        lines.call(&quot;= 0&quot;).map { |line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="302">
          
          
          <code class="ruby">          { line.quote_request_line_id =&gt; (line.price_amount || 0) * (line.quantity || 1).to_i }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">        },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">      :lots =&gt; -&gt;() do</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="305">
          <span class="hits">6</span>
          
          <code class="ruby">        lots = {}</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="306">
          <span class="hits">6</span>
          
          <code class="ruby">        lines.call(&quot;&gt; 0&quot;).each do |line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="307">
          
          
          <code class="ruby">          (lots[line.lot_id] ||= []) &lt;&lt;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="308">
          
          
          <code class="ruby">            ((line.price_amount || 0) * (line.quantity || 1).to_i) * line.quote_request_line.lot.expected_quantity</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="310">
          <span class="hits">6</span>
          
          <code class="ruby">        lots.map { |id, prices| { id =&gt; prices.compact.reduce(:+)}}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">      end.call</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="312">
          <span class="hits">6</span>
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">  #  Setting common used variables</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="319">
          <span class="hits">1</span>
          
          <code class="ruby">  def variables</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="320">
          <span class="hits">2</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="321">
          <span class="hits">2</span>
          
          <code class="ruby">      @quote_request = QuoteRequest.find params[:id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby">    rescue</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="323">
          <span class="hits">1</span>
          
          <code class="ruby">      empty_object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">  # Defining lists of default or selected IDs to display</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="331">
          <span class="hits">1</span>
          
          <code class="ruby">  def lists_to_display</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="332">
          
          
          <code class="ruby">    _a = -&gt;(str) { str.gsub(/\[|\]/, &quot;&quot;).split(&quot;,&quot;).map(&amp;:to_i) rescue nil }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="334">
          
          
          <code class="ruby">    @lots_to_display, @items_to_display =</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="335">
          
          
          <code class="ruby">      (_a.call(params[:lots]) || @quote_request.lots.map(&amp;:id)),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="336">
          
          
          <code class="ruby">      (_a.call(params[:items]) || @quote_request.lines.where(:lot_id =&gt; 0).map(&amp;:id))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby">  # Outputting nothing on error occurred</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="343">
          <span class="hits">1</span>
          
          <code class="ruby">  def empty_object</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="344">
          <span class="hits">1</span>
          
          <code class="ruby">    render :json =&gt; {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f5e71b7d5e714f1d0a44c3c62adb531fb372ef92">
  <div class="header">
    <h3>app/controllers/quotes/buyer_messages_controller.rb</h3>
    <h4><span class="red">18.18 %</span> covered</h4>
    <div>
      <b>33</b> relevant lines. 
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>27</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Quotes::BuyerMessagesController &lt; Quotes::BaseController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  respond_to :json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    quote_request = QuoteRequest.find(params[:request_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">    respond_with({ </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      messages:  quote_request.quote_messages.all_messages.map{ | message | render_msg_json(message) },</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      suppliers: quote_request.quote_suppliers.map{ |supp| {id: supp.id, name: supp.name} }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    quote_request = QuoteRequest.find(params[:request_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    msg_body      = QuoteMessageBody.new(body: params[:body])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    suppliers     = QuoteSupplier.find params[:supplier_ids]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    submitted_message = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    suppliers.each do |supplier|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      message = BuyerMessage.new( quote_request: quote_request,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">                                  quote_requests_user: quote_request.business_partners.creator.first,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">                                  quote_supplier: supplier, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">                                  quote_message_body: msg_body </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">                                )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      if message.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        submitted_message ||= message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">        PushMessenger.push(&quot;/quotes/messages/#{supplier.external_responses_key(quote_request)}&quot;, render_msg_json(message))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    PushMessenger.push(&quot;/quotes/messages/#{quote_request.id}&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      render_msg_json(submitted_message)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    # Deliver mail to suppliers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    from_buyer = quote_request.business_partners.creator.first.user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    suppliers.each do |to_supplier|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      MessageBoardMailer.new_buyer_message from_buyer, to_supplier, quote_request, submitted_message.quote_message_body.formatted_body</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    # Deliver mail to creator and owners</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    to_suppliers = BuyerMessage.recipients(submitted_message.quote_message_body_id).map{|msg| msg.quote_supplier.name}.join(', ')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    quote_request.business_partners.select { |u| %w(creator owner).include? u.attitude }.each do |quote_user|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      MessageBoardMailer.new_buyer_message_copy_to_bussiness_partners from_buyer, quote_user.user, quote_request,  submitted_message.quote_message_body.formatted_body, to_suppliers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    render :nothing =&gt; true, :status =&gt; 204</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">    def render_msg_json message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">        msg_id: message.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">        body: message.quote_message_body.body,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">        type: message.type,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">        buyer: message.quote_requests_user.user.name, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">        suppliers: BuyerMessage.recipients(message.quote_message_body_id).map{|msg| msg.quote_supplier.name},</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">        supplier_name: (message.quote_supplier.name rescue ''),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">        supplier_logo: (message.quote_supplier.try(:logo).try(:url) rescue ''),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">        supplier_id: (message.quote_supplier.id rescue ''),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">        time: (message.created_at || Time.now).strftime(&quot;%m/%d/%y, %I:%M %p&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="882ae31b8658e4727d62dba09269575a712a600b">
  <div class="header">
    <h3>app/controllers/quotes/complete_responses_controller.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>15</b> relevant lines. 
      <span class="green"><b>15</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Quotes::CompleteResponsesController &lt; Quotes::RequestsController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :load_params, :only =&gt; [:show]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="5">
          <span class="hits">6</span>
          
          <code class="ruby">    @quote_request = QuoteRequest.find(params[:id])</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="6">
          <span class="hits">6</span>
          
          <code class="ruby">    if @quote_request.finished? || @quote_request.test_complete? || @quote_request.complete?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="7">
          <span class="hits">3</span>
          
          <code class="ruby">      @quote_request.complete!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="9">
          <span class="hits">3</span>
          
          <code class="ruby">      flash[:notice] = &quot;not completed&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="10">
          <span class="hits">3</span>
          
          <code class="ruby">      redirect_to quotes_responses_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  def load_params</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="18">
          <span class="hits">12</span>
          
          <code class="ruby">    @quote_request = QuoteRequest.includes(:quote_suppliers).find(params[:id])</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="19">
          <span class="hits">12</span>
          
          <code class="ruby">    @sections_settings ||= sections_settings @quote_request.id</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="20">
          <span class="hits">12</span>
          
          <code class="ruby">    @event_name_title = @quote_request.description.blank? ? t('quotes_controller.request_for_sourcing_event') : @quote_request.description.truncate(25).to_s</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="21">
          <span class="hits">12</span>
          
          <code class="ruby">    @title = t(&quot;quotes_controller.request_for_quote_number&quot;, :event_description =&gt; @event_name_title, :num =&gt; @quote_request.id)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="22">
          <span class="hits">12</span>
          
          <code class="ruby">    @title_modifier = &quot;&lt;span class='smaller'&gt;#{t'quotes_controller.in_completed'}&lt;/span&gt;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="30b500396557cd6c8e33793e028d88a04fe96ea8">
  <div class="header">
    <h3>app/controllers/quotes/external_responses_bids_controller.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>48</b> relevant lines. 
      <span class="green"><b>48</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># -*- coding: utf-8 -*-</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class Quotes::ExternalResponsesBidsController &lt; Quotes::ExternalResponsesController</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  skip_before_filter :authorize_action, :only =&gt; [:lots, :weighted_total]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  layout false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # TODO: make it only for Bids!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def lots</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    render :json =&gt; -&gt;() do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="15">
          <span class="hits">3</span>
          
          <code class="ruby">      suppliers_in_lots = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="17">
          <span class="hits">3</span>
          
          <code class="ruby">      @quote_request.lots.map(&amp;:id).concat([0]).map { |lot|</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="18">
          <span class="hits">6</span>
          
          <code class="ruby">        -&gt;() do</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="19">
          <span class="hits">6</span>
          
          <code class="ruby">          suppliers_in_lots[lot] ||= -&gt;(lot_id) do</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="20">
          <span class="hits">6</span>
          
          <code class="ruby">            Hash[@quote_request.quote_suppliers.map { |supplier|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="21">
          <span class="hits">12</span>
          
          <code class="ruby">              [ supplier.id, ( supplier.quote_responses.order(:id).last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">                               .lines.where(:lot_id =&gt; lot_id).map { |line|</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="23">
          <span class="hits">3</span>
          
          <code class="ruby">                                 next if line.price_amount.nil?;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="24">
          <span class="hits">3</span>
          
          <code class="ruby">                                 line.price_amount * (line.quantity || 1).to_i</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="25">
          <span class="hits">12</span>
          
          <code class="ruby">                               }.compact.reduce(&amp;:+) rescue nil ) ]</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="26">
          <span class="hits">12</span>
          
          <code class="ruby">            }].delete_if { |_, v| v.nil? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">          end.call(lot)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">          {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">            :id =&gt; lot,</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="31">
          <span class="hits">9</span>
          
          <code class="ruby">            :best_price =&gt; (( memo ||= suppliers_in_lots[lot].sort_by { |_, v| v }.first )[1] rescue nil),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">            :supplier_price =&gt; suppliers_in_lots[lot][@quote_supplier.id],</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="33">
          <span class="hits">6</span>
          
          <code class="ruby">            :me =&gt; (memo[1] == suppliers_in_lots[lot][@quote_supplier.id] rescue nil),</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="34">
          <span class="hits">6</span>
          
          <code class="ruby">            :rank =&gt; (&quot;#{suppliers_in_lots[lot].values.uniq.sort.index(suppliers_in_lots[lot][@quote_supplier.id]) + 1} of #{suppliers_in_lots[lot].size}&quot; rescue nil),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">            :items =&gt; -&gt;() do</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="36">
          <span class="hits">6</span>
          
          <code class="ruby">              suppliers_in_lines = {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="38">
          <span class="hits">6</span>
          
          <code class="ruby">              @quote_request.quote_suppliers</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="39">
          <span class="hits">12</span>
          
          <code class="ruby">                .delete_if { |supplier| supplier.quote_responses.size.zero? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">                .each { |supplier|</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="41">
          <span class="hits">6</span>
          
          <code class="ruby">                  supplier.quote_responses.order(:id).last.lines.where(:lot_id =&gt; lot).each { |line|</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="42">
          <span class="hits">3</span>
          
          <code class="ruby">                    (suppliers_in_lines[line.quote_request_line_id] ||= []) &lt;&lt;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="43">
          <span class="hits">3</span>
          
          <code class="ruby">                      { supplier.id =&gt; line.price_amount } unless line.price_amount.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">                }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">              }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="47">
          <span class="hits">6</span>
          
          <code class="ruby">              suppliers_in_lines.map { |id, suppliers|</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="48">
          <span class="hits">3</span>
          
          <code class="ruby">                arr = {};</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="49">
          <span class="hits">3</span>
          
          <code class="ruby">                suppliers.each { |e|</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="50">
          <span class="hits">3</span>
          
          <code class="ruby">                  arr[e.keys.first] = e.values.first.to_f</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">                };</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="52">
          <span class="hits">6</span>
          
          <code class="ruby">                memo = arr.select { |k, v| arr.values.min == v.to_f };</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">                {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">                  :id =&gt; id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">                  :best_price =&gt; memo.values.first,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">                  :supplier_price =&gt; arr[@quote_supplier.id],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">                  :me =&gt; memo.values.first == arr[@quote_supplier.id],</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="58">
          <span class="hits">3</span>
          
          <code class="ruby">                  :rank =&gt; (&quot;#{arr.values.sort!.index(arr[@quote_supplier.id]) + 1} of #{arr.size}&quot; rescue false)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="59">
          <span class="hits">3</span>
          
          <code class="ruby">                }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">              }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">            end.call</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="62">
          <span class="hits">6</span>
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">        end.call</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="65">
          <span class="hits">3</span>
          
          <code class="ruby">    end.call</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  #  Calculating total price for differrent cases</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">  def weighted_total quote_request = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    suppliers ||= -&gt;() do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="76">
          <span class="hits">3</span>
          
          <code class="ruby">      (quote_request || @quote_request).quote_suppliers.map { |supplier|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">          :id =&gt; supplier.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">          :total =&gt; ( supplier.quote_responses.submitted.order(:submitted_at).last.lines.map { |line| </code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="80">
          <span class="hits">3</span>
          
          <code class="ruby">            (line.price_amount * (line.quantity || 1).to_i) * (@quote_request.lots.find(line.lot_id).expected_quantity rescue 1) </code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="81">
          <span class="hits">9</span>
          
          <code class="ruby">          }.compact.reduce(&amp;:+) rescue nil )</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="82">
          <span class="hits">9</span>
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="83">
          <span class="hits">9</span>
          
          <code class="ruby">      }.map { |s| s[:total].nil? ? next : s }.compact</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="84">
          <span class="hits">3</span>
          
          <code class="ruby">    end.call</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="85">
          <span class="hits">3</span>
          
          <code class="ruby">    total_prices = {}</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="86">
          <span class="hits">3</span>
          
          <code class="ruby">    suppliers.each { |supplier|</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="87">
          <span class="hits">3</span>
          
          <code class="ruby">      total_prices[supplier[:id]] = supplier[:total]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="90">
          <span class="hits">3</span>
          
          <code class="ruby">    best_total = (suppliers.delete_if { |k, _|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">        k[:total] != suppliers.map { |a, _|</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="92">
          <span class="hits">3</span>
          
          <code class="ruby">          a[:total]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="93">
          <span class="hits">3</span>
          
          <code class="ruby">        }.sort.first</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="94">
          <span class="hits">3</span>
          
          <code class="ruby">      }.first[:total] rescue 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">    render :json =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">      :best_total =&gt; best_total,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      :me =&gt; best_total == total_prices[@quote_supplier.id],</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="99">
          <span class="hits">3</span>
          
          <code class="ruby">      :rank =&gt; (&quot;#{total_prices.values.sort!.index(total_prices[@quote_supplier.id]) + 1} of #{total_prices.size}&quot; rescue false)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="100">
          <span class="hits">3</span>
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="ef48241d5e98ce830c4e56372ad8bf7f2b92e051">
  <div class="header">
    <h3>app/controllers/quotes/external_responses_controller.rb</h3>
    <h4><span class="red">55.71 %</span> covered</h4>
    <div>
      <b>210</b> relevant lines. 
      <span class="green"><b>117</b> lines covered</span> and
      <span class="red"><b>93</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># -*- coding: utf-8 -*-</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class Quotes::ExternalResponsesController &lt; Quotes::BaseController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  skip_before_filter :authorize_action, :only =&gt; [:index, :terms, :event_info, :edit, :show, :new, :create, :update, :sorry, :save_quest, :quest_popup, :update_popup]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :auth_supplier, :only =&gt; [:show, :terms, :event_info, :edit, :new, :create, :update, :lots, :weighted_total, :bid, :bids, :settings, :items_and_lots, :push]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :redirect_to_show,  :only =&gt; [:terms, :edit]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :redirect_to_terms, :only =&gt; [:show, :edit, :event_info]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :redirect_to_edit,  :only =&gt; [:terms, :show]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :responses_access</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :check_edit_permission, :only =&gt; [:edit, :new, :create, :update]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :check_view_permission, :only =&gt; [:terms, :show, :event_info]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  verify :method =&gt; :get, :only =&gt; [:new, :show]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  verify :method =&gt; :post, :only =&gt; [:create]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  verify :method =&gt; :put, :only =&gt; [:update]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  verify :xhr =&gt; true, :only =&gt; [ :save_quest, :quest_popup, :update_popup ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  # No Index Action</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    render :action =&gt; :sorry</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  # Supplier must accept Terms, create the response if Terms accepted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  def terms</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    if @quote_request.bidding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      @quote_response = Bid.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      @quote_response = PreBid.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    init_company_info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  # Show Page</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="42">
          <span class="hits">5</span>
          
          <code class="ruby">    if params[:type] == &quot;internal&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">      @show_edit_button = @quote_request.can_edit_responses?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="45">
          <span class="hits">4</span>
          
          <code class="ruby">      @show_edit_button = !@quote_request.closed?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="47">
          <span class="hits">5</span>
          
          <code class="ruby">    @edit = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="49">
          <span class="hits">5</span>
          
          <code class="ruby">    if @quote_request.bidding?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="50">
          <span class="hits">4</span>
          
          <code class="ruby">      render 'show_bidding'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">      render 'show_prebidding'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  # Edit Page</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  def edit</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="60">
          <span class="hits">5</span>
          
          <code class="ruby">    flash[:notice] = params[:flash_message]</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="61">
          <span class="hits">5</span>
          
          <code class="ruby">    if params[:type] == &quot;internal&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">      @edit = @quote_response.working? &amp;&amp; @quote_request.has_access_to_edit_event?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="64">
          <span class="hits">4</span>
          
          <code class="ruby">      @edit = @quote_response.working?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="67">
          <span class="hits">5</span>
          
          <code class="ruby">    if @quote_request.bidding?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">      render 'edit_bidding'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="70">
          <span class="hits">4</span>
          
          <code class="ruby">      render 'edit_prebidding'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">  # Show Event Info Page (Terms accepted)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">  def event_info</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">    init_company_info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">  # Create new response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="85">
          <span class="hits">9</span>
          
          <code class="ruby">    if @quote_response &amp;&amp; @quote_response.submitted?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">      @quote_response = @quote_response.clone_response @quote_supplier</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="88">
          <span class="hits">8</span>
          
          <code class="ruby">      if @quote_request.bidding?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">        @quote_response = Bid.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="91">
          <span class="hits">7</span>
          
          <code class="ruby">        @quote_response = PreBid.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="93">
          <span class="hits">8</span>
          
          <code class="ruby">      @quote_response.quote_request = @quote_request</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="94">
          <span class="hits">8</span>
          
          <code class="ruby">      @quote_response.quote_supplier = @quote_supplier</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="95">
          <span class="hits">8</span>
          
          <code class="ruby">      @quote_response.add_quote_response_lines(:for_supplier =&gt; true)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="96">
          <span class="hits">8</span>
          
          <code class="ruby">      @quote_response.initialize_form_responses :true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="99">
          <span class="hits">9</span>
          
          <code class="ruby">    @quote_response.save(:validate =&gt; false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="101">
          <span class="hits">9</span>
          
          <code class="ruby">    redirect_to @type == &quot;external&quot; ? quotes_external_response_url(@key) : quotes_internal_response_url(@key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">  # Update existing response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="107">
          <span class="hits">1</span>
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="108">
          <span class="hits">17</span>
          
          <code class="ruby">    QuoteResponseLine.update_image(params[:lines]) if params[:lines]</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="109">
          <span class="hits">17</span>
          
          <code class="ruby">    QuoteResponseLine.remove_image(params[:lines_remove]) if params[:lines_remove]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="111">
          <span class="hits">17</span>
          
          <code class="ruby">    @quote_response.updated_at = Time.zone.now</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="112">
          <span class="hits">17</span>
          
          <code class="ruby">    @quote_response.quote_request = @quote_request</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="113">
          <span class="hits">17</span>
          
          <code class="ruby">    @quote_response.quote_supplier = @quote_supplier</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="114">
          <span class="hits">17</span>
          
          <code class="ruby">    @quote_response.attributes = params[:quote_response]</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="115">
          <span class="hits">17</span>
          
          <code class="ruby">    @quote_response.update_quote_request_attachments_by_user params[:quote_request_attachment], @quote_supplier</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">    # if !@quote_response.errors[:base].empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">    #   error_msg = @quote_response.errors[:base].join(&quot;,&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">    # TODO: move to def form_response_attributes= ?????</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="121">
          <span class="hits">17</span>
          
          <code class="ruby">    @quote_response.form_responses.each do |f|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">      f.attributes = params[:form_responses][f.id.to_s]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">      f.form.widgets.each do |v|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">        # if Widget is_internal re-define method respondable? and terurn false to slip validation</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">        v.define_singleton_method(:respondable?){ false } if v.is_internal</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="129">
          <span class="hits">17</span>
          
          <code class="ruby">    @quote_response.response_line_attributes = params[:response_line_attributes]</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="130">
          <span class="hits">17</span>
          
          <code class="ruby">    @quote_response.quote_supplier.update_logo params</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="132">
          <span class="hits">17</span>
          
          <code class="ruby">    validation_needed = (params[:set_state] == 'submitted')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="134">
          <span class="hits">17</span>
          
          <code class="ruby">    if validation_needed  # If we are going SUBMIT Response (instead of SAVE it till prebidding)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="135">
          <span class="hits">7</span>
          
          <code class="ruby">      @quote_response.state = 'submitted'</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="136">
          <span class="hits">7</span>
          
          <code class="ruby">      @quote_response.submitted_at = Time.zone.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="139">
          <span class="hits">17</span>
          
          <code class="ruby">    if @quote_response.save(:validate =&gt; validation_needed)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="141">
          <span class="hits">11</span>
          
          <code class="ruby">      if @quote_request.bidding?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="142">
          <span class="hits">2</span>
          
          <code class="ruby">        QuoteResponseLine.update_price params[:items] unless params[:items].nil?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="143">
          <span class="hits">2</span>
          
          <code class="ruby">        @quote_response.reload</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="144">
          <span class="hits">2</span>
          
          <code class="ruby">        if @quote_response.instance_of?(PreBid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">          @quote_response.type = 'Bid'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">          @quote_response.save(:validate =&gt; false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="150">
          <span class="hits">11</span>
          
          <code class="ruby">      if @quote_response.state == 'submitted'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">        # Send data to Faye and deliver emails</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="152">
          <span class="hits">6</span>
          
          <code class="ruby">        @quote_response.push_bids</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="153">
          <span class="hits">6</span>
          
          <code class="ruby">        if @quote_response.extend_timeline?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">          flash[:notice] = t &quot;quotes.external_response_form.time_line_extended&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="156">
          <span class="hits">6</span>
          
          <code class="ruby">        @quote_response.deliver_mails</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="159">
          <span class="hits">11</span>
          
          <code class="ruby">      if @quote_request.bidding?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="160">
          <span class="hits">2</span>
          
          <code class="ruby">        @quote_response = @quote_response.clone_response @quote_supplier</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="161">
          <span class="hits">2</span>
          
          <code class="ruby">        @quote_response.save(:validate =&gt; false)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="162">
          <span class="hits">2</span>
          
          <code class="ruby">        redirect_to(:action =&gt; :edit, :id =&gt; @key, :flash_message =&gt; flash[:notice])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="164">
          <span class="hits">9</span>
          
          <code class="ruby">        redirect_to(:action =&gt; :show, :id =&gt; @key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="167">
          <span class="hits">6</span>
          
          <code class="ruby">      @quote_response.state = 'working'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="169">
          <span class="hits">6</span>
          
          <code class="ruby">      if params[:type] == &quot;internal&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="170">
          <span class="hits">1</span>
          
          <code class="ruby">        @edit = @quote_response.working? &amp;&amp; @quote_request.has_access_to_edit_event?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="172">
          <span class="hits">5</span>
          
          <code class="ruby">        @edit = @quote_response.working?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="175">
          <span class="hits">6</span>
          
          <code class="ruby">      if @quote_request.bidding?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="176">
          <span class="hits">1</span>
          
          <code class="ruby">        render 'edit_bidding'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="178">
          <span class="hits">5</span>
          
          <code class="ruby">        render 'edit_prebidding'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">  # Save Questionnaire</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="187">
          <span class="hits">1</span>
          
          <code class="ruby">  def save_quest</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="188">
          <span class="hits">3</span>
          
          <code class="ruby">    form_response_id = params[:form_responses].first[0]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="189">
          <span class="hits">3</span>
          
          <code class="ruby">    form_response_attr = params[:form_responses].first[1]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="190">
          <span class="hits">3</span>
          
          <code class="ruby">    count = params[:count].to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="192">
          <span class="hits">3</span>
          
          <code class="ruby">    @form_response = FormResponse.find(form_response_id, :include =&gt; { :form =&gt; :widgets })</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="193">
          <span class="hits">3</span>
          
          <code class="ruby">    @quote_response = @form_response.quote_response</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="194">
          <span class="hits">3</span>
          
          <code class="ruby">    @form_response.attributes = form_response_attr</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="195">
          <span class="hits">3</span>
          
          <code class="ruby">    @form_response_validator = @form_response.form.validator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="197">
          <span class="hits">3</span>
          
          <code class="ruby">    @form_response.form.widgets.each do |v|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">      # if Widget is_internal re-define method respondable? and terurn false to slip validation</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">      v.define_singleton_method(:respondable?){ false } if v.is_internal</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="202">
          <span class="hits">3</span>
          
          <code class="ruby">    @form_response.save</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="203">
          <span class="hits">3</span>
          
          <code class="ruby">    render :update do |page|</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="204">
          <span class="hits">3</span>
          
          <code class="ruby">      page.replace_html &quot;#form_response_#{@form_response.id}_form&quot;, :partial =&gt; 'quest_form', :locals =&gt; { :form_response =&gt; @form_response, :editable =&gt; true, :count =&gt; count }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">  # Save Questionnaire in popup</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="211">
          <span class="hits">1</span>
          
          <code class="ruby">  def process_update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="212">
          
          
          <code class="ruby">    @form_response = FormResponse.find(params[:id], :include =&gt; { :form =&gt; :widgets })</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">    @form_response.attributes = params[:form_response]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">    @form_response_validator = @form_response.form.validator</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">    @form_response.form.widgets.each do |v|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">      # if Widget is_internal re-define method respondable? and terurn false to slip validation</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">      v.define_singleton_method(:respondable?){ false } if v.is_internal</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">    @form_response.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">  # Render Questionnaire Popup</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="225">
          <span class="hits">1</span>
          
          <code class="ruby">  def quest_popup</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="226">
          <span class="hits">1</span>
          
          <code class="ruby">    q_popup</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="227">
          <span class="hits">1</span>
          
          <code class="ruby">    render :partial =&gt; 'quest_popup.html'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">  # re-render Questionnaire popup</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="233">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_popup</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="234">
          <span class="hits">2</span>
          
          <code class="ruby">    if process_update</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="235">
          <span class="hits">1</span>
          
          <code class="ruby">      render :update do |page|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="236">
          <span class="hits">1</span>
          
          <code class="ruby">        page &lt;&lt; &quot;$('#form_response_#{@form_response.id}').trigger('dialogclose');&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="239">
          <span class="hits">1</span>
          
          <code class="ruby">      render :update do |page|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="240">
          <span class="hits">1</span>
          
          <code class="ruby">        page.replace_html &quot;form_response_#{@form_response.id}_form&quot;, :partial =&gt; 'quest_popup_form', :locals =&gt; { :form_response =&gt; @form_response, :editable =&gt; true }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="246">
          <span class="hits">1</span>
          
          <code class="ruby">private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">  # Check URL:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">  #    - supplier exists?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">  #    - quote_request exists?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">  #    - supplier belongs to quore request?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">  #    - event state not draft?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="255">
          <span class="hits">1</span>
          
          <code class="ruby">  def auth_supplier</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="256">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">      init_info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">    rescue Exception =&gt; err</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="259">
          
          
          <code class="ruby">      logger.error(err)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="260">
          
          
          <code class="ruby">      logger.error(err.backtrace.join(&quot;\n&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">      render :action =&gt; :sorry</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="262">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="264">
          
          
          <code class="ruby">    if auth_failed?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">      # Auth failed</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="266">
          
          
          <code class="ruby">      render :action =&gt; :sorry</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">    elsif !@quote_request.started?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">      # Event not started ..</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="269">
          
          
          <code class="ruby">      render :action =&gt; :event_not_started</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">    elsif @quote_request.closed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="271">
          
          
          <code class="ruby">      @edit = @show_edit_button = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="273">
          
          
          <code class="ruby">      if @quote_response &amp;&amp; @quote_response.working?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">        @quote_response.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">        @quote_response = @quote_request.responses.where(:quote_supplier_id =&gt; @quote_supplier.id).last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="278">
          
          
          <code class="ruby">      if params[:action] == 'event_info'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="279">
          
          
          <code class="ruby">        init_additional_info</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="280">
          
          
          <code class="ruby">        init_company_info</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="281">
          
          
          <code class="ruby">        render 'event_info'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">      elsif %w[show edit].include? params[:action]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="283">
          
          
          <code class="ruby">        if @quote_response &amp;&amp; @quote_request.closed_at_state == 'bidding'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="284">
          
          
          <code class="ruby">          init_additional_info</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="285">
          
          
          <code class="ruby">          render 'show_bidding'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">        elsif @quote_response &amp;&amp; @quote_request.closed_at_state == 'prebidding'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="287">
          
          
          <code class="ruby">          init_additional_info</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="288">
          
          
          <code class="ruby">          render 'show_prebidding'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="290">
          
          
          <code class="ruby">          render 'event_closed'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">    init_additional_info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">  # check related data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="301">
          <span class="hits">1</span>
          
          <code class="ruby">  def auth_failed?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">    @key.nil? ||</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="303">
          
          
          <code class="ruby">    @quote_supplier.nil?  ||</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">    @quote_request.nil? ||</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby">    @quote_request.draft? ||</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">    !@quote_request.quote_suppliers.include?(@quote_supplier)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby">  # Collect Info eg.: key, quote_supplier, quote_request, quote_response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="312">
          <span class="hits">1</span>
          
          <code class="ruby">  def init_info</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="313">
          
          
          <code class="ruby">    @key = params[:id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">    @type = params[:type]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="315">
          
          
          <code class="ruby">    if @key</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="316">
          
          
          <code class="ruby">      if @type == &quot;external&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="317">
          
          
          <code class="ruby">        @quote_supplier ||= QuoteSupplier.find_by_quote_supplier_key @key[40..80] # TODO: fix this after fixing external_responses url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="318">
          
          
          <code class="ruby">        @quote_request  ||= @quote_supplier.quote_request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="319">
          
          
          <code class="ruby">        @quote_response ||= @quote_request.responses.where(:quote_supplier_id =&gt; @quote_supplier.id).last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="321">
          
          
          <code class="ruby">        @quote_supplier ||= QuoteSupplier.find_by_id @key</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="322">
          
          
          <code class="ruby">        @quote_request  ||= @quote_supplier.quote_request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="323">
          
          
          <code class="ruby">        @quote_response ||= @quote_request.responses.where(:quote_supplier_id =&gt; @quote_supplier.id, :state =&gt; 'working', :created_by =&gt; User.current_user.id).last || @quote_request.responses.where(:quote_supplier_id =&gt; @quote_supplier.id, :state =&gt; 'submitted').last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">  # Collect Info eg.: Title, TitleModifier, line_types..</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="331">
          <span class="hits">1</span>
          
          <code class="ruby">  def init_additional_info</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="332">
          
          
          <code class="ruby">    @event_name_title = @quote_request.description.blank? ? t('quotes_controller.request_for_sourcing_event') : @quote_request.description.truncate(25).to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="333">
          
          
          <code class="ruby">    @title = t(&quot;quotes_controller.request_for_quote_number&quot;, :event_description =&gt; @event_name_title, :num =&gt; @quote_request.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="334">
          
          
          <code class="ruby">    translation =</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby">    if @quote_request.competitive_bidding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="336">
          
          
          <code class="ruby">      if @quote_request.closed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="337">
          
          
          <code class="ruby">        t('quotes_controller.in_completed')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby">      elsif @quote_request.bidding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="339">
          
          
          <code class="ruby">        t('quotes_controller.bidding_in_progress')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby">      elsif @quote_request.prebidding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="341">
          
          
          <code class="ruby">        t('quotes_controller.prebid_in_progress')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="344">
          
          
          <code class="ruby">      if @quote_request.closed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="345">
          
          
          <code class="ruby">        t('quotes_controller.in_completed')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="347">
          
          
          <code class="ruby">        t('quotes_controller.in_active')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="349">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="350">
          
          
          <code class="ruby">    @title_modifier = &quot; &lt;span class='smaller'&gt;#{ translation }&lt;/span&gt; &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby">    #---- TODO: temp link 'acts as supplier'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="352">
          
          
          <code class="ruby">    if internal_view?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="353">
          
          
          <code class="ruby">      @title_modifier += &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="354">
          
          
          <code class="ruby">        &lt;span class='smaller'&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="355">
          
          
          <code class="ruby">          &lt;a href='#{quotes_external_response_url(@quote_supplier.external_responses_key(@quote_request))}' target='blank'&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="356">
          
          
          <code class="ruby">            [act as supplier]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="357">
          
          
          <code class="ruby">          &lt;/a&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="358">
          
          
          <code class="ruby">        &lt;/span&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby">      &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby">    #---- TODO: temp</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="362">
          
          
          <code class="ruby">    @line_types ||= Quotes::RequestsController.types  # TODO: needed?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="366">
          
          
          <code class="ruby">  # Collect Info eg.: company_name, company_logo, terms_accepted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="368">
          <span class="hits">1</span>
          
          <code class="ruby">  def init_company_info</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="369">
          
          
          <code class="ruby">    @company_name = Setup.lookup('company name')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="370">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="371">
          
          
          <code class="ruby">    if @quote_request.buyers_logo</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="372">
          
          
          <code class="ruby">      @company_logo = @quote_request.buyers_logo.url(:small)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="373">
          
          
          <code class="ruby">      @company_logo_large = @quote_request.buyers_logo.url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="375">
          
          
          <code class="ruby">      @company_logo = 'coupa-logo.png'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="376">
          
          
          <code class="ruby">      @company_logo_large = 'coupa-logo.png'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="377">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="378">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="381">
          
          
          <code class="ruby">  # Show mode if Request Submitted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="382">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="383">
          <span class="hits">1</span>
          
          <code class="ruby">  def redirect_to_show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="384">
          
          
          <code class="ruby">    redirect_to(:action =&gt; :show, :id =&gt; @key) if @quote_response &amp;&amp; @quote_response.submitted?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="385">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="386">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby">  # Terms mode if Response Doesn't Exists</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="389">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="390">
          <span class="hits">1</span>
          
          <code class="ruby">  def redirect_to_terms</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="391">
          
          
          <code class="ruby">    redirect_to(:action =&gt; :terms, :id =&gt; @key) unless @quote_response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="392">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="393">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="394">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">  # Edit mode if Request in Working state</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="397">
          <span class="hits">1</span>
          
          <code class="ruby">  def redirect_to_edit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="398">
          
          
          <code class="ruby">    redirect_to(:action =&gt; :edit, :id =&gt; @key) if @quote_response &amp;&amp; @quote_response.working? &amp;&amp; !@quote_response.quote_request.is_only_feedback_user?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="399">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="400">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="401">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="402">
          
          
          <code class="ruby">  # prepare data for questionnaire popup</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="403">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="404">
          <span class="hits">1</span>
          
          <code class="ruby">  def q_popup</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="405">
          
          
          <code class="ruby">    if !params[:id].blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="406">
          
          
          <code class="ruby">      @editable = params[:editable] == 'true'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="407">
          
          
          <code class="ruby">      @form_response = FormResponse.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="408">
          
          
          <code class="ruby">      @form_response_validator = @form_response.form.validator</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="409">
          
          
          <code class="ruby">    elsif !params[:form_id].blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="410">
          
          
          <code class="ruby">      @editable = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="411">
          
          
          <code class="ruby">      form = Form.find(params[:form_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="412">
          
          
          <code class="ruby">      @form_response = form.form_responses.create</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="413">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="414">
          
          
          <code class="ruby">      render :nothing =&gt; true, :status =&gt; 500</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="416">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="418">
          <span class="hits">1</span>
          
          <code class="ruby">  def responses_access</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="419">
          
          
          <code class="ruby">    authorize_action if params[:type] == &quot;internal&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="420">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="421">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="422">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_view_permission</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="423">
          
          
          <code class="ruby">    if params[:type] == &quot;internal&quot; &amp;&amp; !@quote_request.has_access_to_view_event?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="424">
          
          
          <code class="ruby">      flash[:warning] = t &quot;quotes_controller.permission_denied&quot;, quote_request: @quote_request.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="425">
          
          
          <code class="ruby">      redirect_to quotes_requests_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="426">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="427">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="428">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="429">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_edit_permission</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="430">
          
          
          <code class="ruby">    if params[:type] == &quot;internal&quot; &amp;&amp; !@quote_request.has_access_to_edit_event?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="431">
          
          
          <code class="ruby">      flash[:warning] = t &quot;quotes_controller.permission_edit_denied&quot;, quote_request: @quote_request.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="432">
          
          
          <code class="ruby">      redirect_to quotes_requests_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="433">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="434">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="435">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="436">
          <span class="hits">1</span>
          
          <code class="ruby">  def internal_view?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="437">
          
          
          <code class="ruby">    User.current_user.present? &amp;&amp; @type != &quot;external&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="438">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="439">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="0c0cf02bf8175642154b0170f98c7c9d848960c7">
  <div class="header">
    <h3>app/controllers/quotes/external_responses_graph_controller.rb</h3>
    <h4><span class="red">60.27 %</span> covered</h4>
    <div>
      <b>73</b> relevant lines. 
      <span class="green"><b>44</b> lines covered</span> and
      <span class="red"><b>29</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># -*- coding: utf-8 -*-</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class Quotes::ExternalResponsesGraphController &lt; Quotes::ExternalResponsesController</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  skip_before_filter :authorize_action, :only =&gt; [:bids, :bid, :settings, :items_and_lots, :push]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :lists_to_display, :only =&gt; [:bids, :bid, :push]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  layout false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  #  Getting latest bid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def bid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    render :json =&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      ranked_responses(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">        @quote_supplier.quote_responses.order(:submitted_at).last</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">      ) # rescue empty_object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  #  Getting bid's history for current supplier</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  def bids</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    render :json =&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      ranked_responses(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        @quote_request.responses.order(:submitted_at).all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      ) # rescue empty_object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  #  Init data for chart</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  def settings</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    render :json =&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">        :start           =&gt; format_time(@quote_supplier.quote_request.start_time),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        :bidding         =&gt; format_time(@quote_supplier.quote_request.bidding_time),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">        :end             =&gt; format_time(@quote_supplier.quote_request.end_time),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">        :supplierAddedAt =&gt; format_time(@quote_supplier.created_at),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">        :servertime      =&gt; format_time(Time.zone.now),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">        :chartType       =&gt; (@quote_supplier.quote_request.suppliers_see == &quot;competitive_ranking&quot; ? &quot;rank&quot; : &quot;bid&quot;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">        :currency        =&gt; Currency.find(@quote_request.currency_id).code,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">        :logo            =&gt; (@quote_supplier.logo.url(:small) == &quot;na.png&quot; ? &quot;&quot; : @quote_supplier.logo.url(:small)),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">        :name            =&gt; @quote_supplier.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">        :finished        =&gt; @quote_request.complete? ? 1 : 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      } # rescue empty_object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  #  List of Items and Lots, acquisition of which planned</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  #  is a target of Event</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">  def items_and_lots</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    @selected_lots_ids  = @quote_response.lines.where(&quot;price_amount &gt; 0&quot;).map(&amp;:lot_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    @selected_items_ids = @quote_response.lines.where(lot_id: 0).where(&quot;price_amount &gt; 0&quot;).map(&amp;:quote_request_line_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    render :json =&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      @quote_request.lots.map { |lot|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">          :id        =&gt; lot.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">          :isLot     =&gt; true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">          :parentLot =&gt; -1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">          :label     =&gt; lot.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">          :currency  =&gt; Currency.find(lot.lines.map(&amp;:price_currency_id).uniq.first).code,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">          :selected  =&gt; @selected_lots_ids.include?(lot.id),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">          :price     =&gt; lot.lines.inject(0) { |summ, r|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">                          summ + (r.quantity.to_i * r.price_amount)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">                        }.to_i * lot.expected_quantity</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      } + @quote_request.lines.where(:lot_id =&gt; 0).map { |line|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">          :id        =&gt; line.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">          :isLot     =&gt; false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">          :parentLot =&gt; line.lot_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">          :label     =&gt; line.description,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">          :price     =&gt; (line.quantity.to_i * line.price_amount).to_i,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">          :currency  =&gt; Currency.find(line.price_currency_id).code,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">          :selected  =&gt; @selected_items_ids.include?(line.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">      } rescue empty_object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">  #  Prepearing and sending data to supplier's chart</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">  #  on every each bid comes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">  def push quote_request = @quote_request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="93">
          <span class="hits">6</span>
          
          <code class="ruby">    @lots_to_display, @items_to_display  =</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">      quote_request.lots.map(&amp;:id),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">      quote_request.lines.where(:lot_id =&gt; 0).map(&amp;:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="97">
          <span class="hits">6</span>
          
          <code class="ruby">    last_bid = quote_request.responses.order(&quot;submitted_at desc&quot;).limit(1).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="99">
          <span class="hits">6</span>
          
          <code class="ruby">    ranked_responses(last_bid, true).merge(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">      :suppliersMap =&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">        ranked_responses(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">          quote_request.quote_suppliers.map { |supplier|</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="103">
          <span class="hits">6</span>
          
          <code class="ruby">            if supplier.id != last_bid.quote_supplier.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">              supplier.quote_responses.where(['submitted_at &lt;= ?', last_bid.submitted_at]).last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">          }.compact, true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  #  Getting all response-related data for selected response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">  def response_summary response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="119">
          <span class="hits">6</span>
          
          <code class="ruby">    lines_by_lot = {}</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="120">
          <span class="hits">6</span>
          
          <code class="ruby">    response.lines.each do |line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">      (lines_by_lot[line.lot_id] ||= []) &lt;&lt; line</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="124">
          <span class="hits">6</span>
          
          <code class="ruby">    instances_summaries = { lines: {}, lots: {} }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    # collecting common price for all lots (including 0)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="127">
          <span class="hits">6</span>
          
          <code class="ruby">    lines_by_lot.each do |lot_id, lines|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">      if lot_id.zero?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">        lines.each do |line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">          if @items_to_display.include? line.quote_request_line_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">            instances_summaries[:lines][line.quote_request_line_id] =</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">              (line.price_amount || 0) * (line.quantity || 1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">        if @lots_to_display.include?(lot_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">          instances_summaries[:lots][lot_id] =</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">            lines.map { |line| (line.price_amount || 0) * (line.quantity || 1) rescue 0 }.reduce(&amp;:+) *</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">            (QuoteRequestsLot.find(lot_id).expected_quantity rescue 1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">    # computing common price for all Event's items and lots</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="145">
          <span class="hits">6</span>
          
          <code class="ruby">    instances_summaries.map { |type, ids|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="146">
          <span class="hits">12</span>
          
          <code class="ruby">      ids.map { |id, price| price }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">    }.flatten.reduce(&amp;:+)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">  #  Getting formatted data for current response or response's history.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">  #  First and only param of this method can be has Object or Array type.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">  def ranked_responses responses, common = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">    # formatting output of computed and collected data for</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">    # each selected response</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="159">
          <span class="hits">12</span>
          
          <code class="ruby">    response_output = -&gt;(resp) do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">      all_resps ||=</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">        -&gt;(_response) do</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="162">
          <span class="hits">6</span>
          
          <code class="ruby">          Hash[</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">            _response.quote_request.quote_suppliers.map { |supplier|</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="164">
          <span class="hits">6</span>
          
          <code class="ruby">              response = supplier.quote_responses.where(['submitted_at &lt;= ?', _response.submitted_at]).last</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="165">
          <span class="hits">6</span>
          
          <code class="ruby">              [supplier.id, (response_summary(response) || 0)] unless response.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">            }.compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">          ]</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="168">
          <span class="hits">6</span>
          
          <code class="ruby">        end.call(resp)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">      # we group suppliers by the price they proposed for the purpose of</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">      # giving equal rank to suppliers with equal price</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="172">
          <span class="hits">6</span>
          
          <code class="ruby">      suppliers_by_price = all_resps.inject({}) do |a, i|</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="173">
          <span class="hits">6</span>
          
          <code class="ruby">        price, supplier_id = i[1], i[0]</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="174">
          <span class="hits">6</span>
          
          <code class="ruby">        (a[price] ||= []) &lt;&lt; supplier_id</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="175">
          <span class="hits">6</span>
          
          <code class="ruby">        a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="177">
          <span class="hits">6</span>
          
          <code class="ruby">      suppliers_ordered_by_price = Hash[suppliers_by_price.to_a.sort{|a, b| a[0] &lt;=&gt; b[0] }]</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="178">
          <span class="hits">12</span>
          
          <code class="ruby">      rank = suppliers_ordered_by_price.find_index{|k, v| v.include? @quote_supplier.id } + 1 rescue 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="180">
          <span class="hits">12</span>
          
          <code class="ruby">      best_price = all_resps.count &gt; 0 ? all_resps.sort_by {|k, v| v}[0][1] : nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="183">
          <span class="hits">6</span>
          
          <code class="ruby">        :bid         =&gt; all_resps[(common ? resp.quote_supplier.id : @quote_supplier.id)],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">        :bestPrice   =&gt; best_price,</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="185">
          <span class="hits">6</span>
          
          <code class="ruby">        :isBestBid   =&gt; best_price &amp;&amp; (all_resps[(common ? resp.quote_supplier.id : @quote_supplier.id)] == best_price),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">        :rank        =&gt; I18n.t(&quot;rank_human._#{rank}&quot;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">        :rankNumeric =&gt; rank,</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="188">
          <span class="hits">6</span>
          
          <code class="ruby">        :submittedAt =&gt; (format_time(resp.submitted_at) rescue nil),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">        :id          =&gt; resp.quote_supplier.id</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="190">
          <span class="hits">6</span>
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="193">
          <span class="hits">12</span>
          
          <code class="ruby">    responses.class == Array ?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">      responses.map { |_resp| response_output.call(_resp) unless _resp.quote_supplier.nil? }.compact :</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="195">
          <span class="hits">6</span>
          
          <code class="ruby">      response_output.call(responses)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">  #  Formatting time to JS-applayable string</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="202">
          <span class="hits">1</span>
          
          <code class="ruby">  def format_time time</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="203">
          <span class="hits">6</span>
          
          <code class="ruby">    time.strftime(&quot;%a, %d %b %Y %T&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">  # Defining lists of default or selected IDs to display</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="210">
          <span class="hits">1</span>
          
          <code class="ruby">  def lists_to_display</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="211">
          
          
          <code class="ruby">    _a = -&gt;(str) { str.gsub(/\[|\]/, &quot;&quot;).split(&quot;,&quot;).map(&amp;:to_i) rescue nil }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">    @lots_to_display, @items_to_display  =</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">      (_a.call(params[:lots]) || @quote_request.lots.map(&amp;:id)),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">      (_a.call(params[:items]) || @quote_request.lines.where(:lot_id =&gt; 0).map(&amp;:id))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">  #  Wrapping errors to empty object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="222">
          <span class="hits">1</span>
          
          <code class="ruby">  def empty_object</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">    render :json =&gt; {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="ad775ebe73f7c1e7b322c0e802a74f4f6de8aaed">
  <div class="header">
    <h3>app/controllers/quotes/prebidding_responses_controller.rb</h3>
    <h4><span class="red">26.47 %</span> covered</h4>
    <div>
      <b>34</b> relevant lines. 
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>25</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class  Quotes::PrebiddingResponsesController &lt; Quotes::RequestsController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :load_params, :state_redirect, :only =&gt; [:show, :edit, :update]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :check_suppliers_message, :only =&gt; [:edit]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    @quote_suppliers = @quote_request.quote_suppliers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    quote_responses = @quote_suppliers.map{|qs| qs.last_quote_request_response(@quote_request)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    @questionnaires_data = QuoteResponse.questionnaire_data_lines(quote_responses)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    @lines_data = QuoteResponse.bid_data_lines(quote_responses)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def edit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    exists_before_suppliers = @quote_request.quote_suppliers.map{|s| s.id}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    @quote_request.edit_quote_suppliers(params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    if @quote_request.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      # Send an email each new supplier</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      @quote_request.quote_suppliers.each do |s|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        unless exists_before_suppliers.include?(s.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">          s.deliver_mail</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      redirect_to action: :show</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      flash[:message] = @quote_request.errors.values.join(&quot;\n&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      render action: :edit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  def load_params</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.includes(:quote_suppliers).find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    @sections_settings ||= sections_settings @quote_request.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    @event_name_title = @quote_request.description.blank? ? t('quotes_controller.request_for_sourcing_event') : @quote_request.description.truncate(25).to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    @title = t(&quot;quotes_controller.request_for_quote_number&quot;, :event_description =&gt; @event_name_title, :num =&gt; @quote_request.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    translate = if @quote_request.competitive_bidding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      @quote_request.preprebidding_period? ? t('quotes_controller.in_preprebidding') : t('quotes_controller.prebid_in_progress')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      t('quotes_controller.in_active')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">    @title_modifier =  &quot;&lt;span class='smaller'&gt;#{translate}&lt;/span&gt;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  def state_redirect</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    if @quote_request.bidding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      redirect_to quotes_bidding_response_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    elsif @quote_request.closed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      redirect_to quotes_complete_response_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="fc8106423bf2d339eca1faec7eb0eb2e0ea53cd2">
  <div class="header">
    <h3>app/controllers/quotes/related_persons_controller.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>19</b> relevant lines. 
      <span class="green"><b>19</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># -*- coding: utf-8 -*-</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class Quotes::RelatedPersonsController &lt; Quotes::BaseController</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  verify :xhr =&gt; true, :only =&gt; [:autocomplete, :create, :destroy]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  helper :addresses, :suppliers, :requisition_headers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  #  Addition of QuoteRequest related person by Ajax request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="12">
          <span class="hits">4</span>
          
          <code class="ruby">    user = User.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    business_partner = QuoteRequest.find(params[:quote_request_id]).business_partners.create(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      :user_id =&gt; params[:id],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      :attitude =&gt; params[:attitude]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="16">
          <span class="hits">4</span>
          
          <code class="ruby">    ) if user.name == params[:name]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="17">
          <span class="hits">4</span>
          
          <code class="ruby">    render :json =&gt; business_partner ? {:id =&gt; business_partner.id, :status =&gt; &quot;ok&quot;} : {:status =&gt; &quot;fail&quot;}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  #  Outputting matched related users for Ajax request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  def autocomplete</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="25">
          <span class="hits">4</span>
          
          <code class="ruby">    quote_request = QuoteRequest.find(params[:quote_request_id])</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="26">
          <span class="hits">4</span>
          
          <code class="ruby">    matched_users =</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    if params[:type] == &quot;owner&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="28">
          <span class="hits">2</span>
          
          <code class="ruby">      User.owners.appropriate_users(params[:term])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    elsif params[:type] == &quot;watcher&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="30">
          <span class="hits">2</span>
          
          <code class="ruby">      User.watchers.appropriate_users(params[:term])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="32">
          <span class="hits">4</span>
          
          <code class="ruby">    matched_users -= quote_request.related_users</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    render :json =&gt; matched_users.map {|user|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">       id: user.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">       label: &quot;#{user.firstname} #{user.lastname}&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">       value: &quot;#{user.firstname} #{user.lastname}&quot;</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="38">
          <span class="hits">4</span>
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="39">
          <span class="hits">4</span>
          
          <code class="ruby">     }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  #  Removing of QuoteRequest related person by Ajax request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  def destroy</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="46">
          <span class="hits">6</span>
          
          <code class="ruby">    partner = QuoteRequest.find(params[:quote_request_id]).business_partners.find(params[:id])</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="47">
          <span class="hits">6</span>
          
          <code class="ruby">    destroy_partner = partner.destroy if partner.try(:attitude) != &quot;creator&quot;</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="48">
          <span class="hits">6</span>
          
          <code class="ruby">    render :json =&gt; destroy_partner ? {:status =&gt; &quot;ok&quot;} : {:status =&gt; &quot;fail&quot;}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="deb3c31f544bfd7d7fa27e34bb590853ca42352c">
  <div class="header">
    <h3>app/controllers/quotes/request_attachments_controller.rb</h3>
    <h4><span class="green">92.86 %</span> covered</h4>
    <div>
      <b>14</b> relevant lines. 
      <span class="green"><b>13</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">class Quotes::RequestAttachmentsController &lt; Quotes::BaseController</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def new</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="5">
          <span class="hits">4</span>
          
          <code class="ruby">    @quote_request = QuoteRequest.find(params[:request_id])</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="6">
          <span class="hits">4</span>
          
          <code class="ruby">    @attachment = @quote_request.quote_request_attachments.build</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="7">
          <span class="hits">4</span>
          
          <code class="ruby">    respond_to do |format|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="8">
          <span class="hits">4</span>
          
          <code class="ruby">      format.js</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="9">
          <span class="hits">5</span>
          
          <code class="ruby">      format.html {render nothing: true}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  # def destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  #   @attachment = QuoteRequestAttachment.find params[:id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  #   @attachment.mark_delete = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  #   render nothing: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  def destroy_file</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="20">
          <span class="hits">4</span>
          
          <code class="ruby">    @attachment = QuoteRequestAttachment.find params[:id]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="21">
          <span class="hits">4</span>
          
          <code class="ruby">    if !@attachment.nil? &amp;&amp; @attachment.file.exists?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">      @attachment.file.destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">      @attachment.file = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      @attachment.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">    render nothing: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="016c3d899118abd582abbd791d56c2c4a30b9db1">
  <div class="header">
    <h3>app/controllers/quotes/requests_controller.rb</h3>
    <h4><span class="red">29.02 %</span> covered</h4>
    <div>
      <b>579</b> relevant lines. 
      <span class="green"><b>168</b> lines covered</span> and
      <span class="red"><b>411</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Quotes::RequestsController &lt; Quotes::BaseController</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  @@types = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">    ['Qty', 'QuoteRequestQuantityLine'],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">    ['Amt', 'QuoteRequestAmountLine']]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  cattr_reader :types</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  verify :method =&gt; :get, :only =&gt; [:edit, :show, :rfq_manager, :auto_complete]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  verify :method =&gt; :put, :only =&gt; [:update]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  verify :method =&gt; :post, :only =&gt; [:new, :remove_questionarrie, :copy_questionarrie]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  verify :method =&gt; :delete, :only =&gt; [:destroy]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_reader :types</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :check_event_type_and_id, :only =&gt; [ :new ]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :check_view_permission, :only =&gt; [ :show ]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :check_edit_permission, :only =&gt; [ :edit ]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :initialize_graph_variables, :only =&gt; [ :index, :search_quote_request_table, :destroy ]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  before_filter :check_suppliers, :only =&gt; [ :show ]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  skip_before_filter :authorize_action, :only =&gt; [:provide_feedback, :submit_feedback, :finish_feedback]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  data_table(</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    :quote_request, [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      { :key =&gt; :id, :label =&gt; &quot;Event #&quot;, :alignment =&gt; &quot;center&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">        :render_text =&gt; &quot;&lt;%= User.current_user.authorized?('quotes/requests', :show) ? link_if_authorized(content_tag('span', value, :class =&gt; 'dt_open_link') , { :controller=&gt;'quotes/requests', :action =&gt; 'show', :id =&gt; value }, :title =&gt; 'View' ) : value %&gt;&quot;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      { :key =&gt; :description, :label =&gt; &quot;Event Name&quot; },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      { :key =&gt; :created_by, :label =&gt; &quot;Creator&quot;, :alignment =&gt; &quot;center&quot; },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">        :key =&gt; &quot;tags.name&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">        :label =&gt; &quot;Project Tags&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">        :method =&gt; :self,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">        :render_text =&gt; &quot;&lt;%= value.tags.join(', ') %&gt;&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">        :export_text =&gt; &quot;&lt;%= value.tags.blank? ? 'No Tags' : value.tags.join(', ') %&gt;&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">        :include  =&gt; [], #okay so this hard to explain.  We wanted to do a different kind of join for the tags</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">        #than rails defaultly does.  Unfortunately, weird joins have to be done on the datatable find options.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">        #you can't specify them in the column here.  I set the include to nothing here to stop the default datatable include</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">        #from happening.  Normally this wouldn't be a problem, but since the include generated here happens to be the second</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">        #include for the taggings table (the first one being the one below in the find options) squeel aliases it funny/uniquely</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        #and when the association applies or hacked association specifications from acts_as_taggable_extenstions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">        #(has_many :taggings, :as =&gt; :taggable, :conditions =&gt; 'taggings.is_private = 0 OR taggings.created_by = #{User.current_user_id}')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">        #it was blowing up b/c taggings alias was not correct in that context.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">        #TLDR: I blew away the include in this column to fix an issue with default association conditions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      { :key =&gt; &quot;commodity&quot;, :label =&gt; &quot;Commodity&quot; },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      { :key =&gt; :start_time, :method =&gt; :self, :label =&gt; &quot;Start Date&quot;, :alignment =&gt; &quot;center&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">        :render_text =&gt; '&lt;%= render_attribute(value.local_start_time) if value %&gt;', :export_text =&gt; '&lt;%= value.local_start_time if value %&gt;' },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">      { :key =&gt; :end_time,   :method =&gt; :self, :label =&gt; &quot;End Date&quot;,   :alignment =&gt; &quot;center&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">        :render_text =&gt; '&lt;%= render_attribute(value.local_end_time) %&gt;',   :export_text =&gt; '&lt;%= value.local_end_time %&gt;' },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      { :key =&gt; :state, :label =&gt; &quot;Status&quot;, :alignment =&gt; &quot;center&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">        :render_text =&gt; &quot;&lt;%= value.humanize %&gt;&quot;, :export_text =&gt; '&lt;%= value.humanize %&gt;'},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      { :key =&gt; :event_type, :label =&gt; &quot;Type&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">        :render_text =&gt; '&lt;%= value.to_s.humanize %&gt;', :export_text =&gt; '&lt;%= value.to_s.humanize %&gt;'},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      { :key =&gt; :calc_responses, :label =&gt; 'Responses', :method =&gt; :self, :alignment =&gt; &quot;center&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">        :render_text =&gt; &quot;&lt;%= value.suppliers_which_responded.size %&gt;&quot;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      #  TODO - Support multiple joins to the same table</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      { :key =&gt; 'quote_new_suppliers.name', :label =&gt; 'New Supplier', :display =&gt; false, :searchable =&gt; false},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      { :key =&gt; 'quote_existing_suppliers.supplier.name', :label =&gt; 'Existing Supplier', :display =&gt; false, :searchable =&gt; false},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      { :key =&gt; :created_at, :display =&gt; false, :method =&gt; :self, :render_text =&gt; '&lt;%= render_attribute(value.local_created_at) %&gt;'},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      { :key =&gt; :updated_by, :display =&gt; false },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      { :key =&gt; :updated_at, :display =&gt; false, :method =&gt; :self, :render_text =&gt; '&lt;%= render_attribute(value.local_updated_at) %&gt;'},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      { :key =&gt; :form,:display =&gt; false},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      { :key =&gt; :urgent, :display =&gt; false},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      { :key =&gt; :comments, :display =&gt; false},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">      { :key =&gt; 'requisition_header_id', :display =&gt; false, :render_text =&gt; '&lt;%= r value.to_s %&gt;', :label =&gt; 'Req #'},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      { :key =&gt; :invited_suppliers, :method =&gt; :self, :display =&gt; false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">        :render_text =&gt; &quot;&lt;%= render_attribute(value.quote_suppliers.collect(&amp;:name).join(',')) %&gt;&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">        :export_text =&gt; &quot;&lt;%= value.quote_suppliers.collect(&amp;:name).join(',') %&gt;&quot;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      { :key =&gt; :actions, :method =&gt; :self, :alignment =&gt; &quot;center&quot;, :render_text =&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">       &quot;&lt;%= link_if_authorized(edit_icon, {:controller =&gt; 'quotes/requests', :action =&gt; 'edit', :id =&gt; value.id }) if value.editable? %&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">        &lt;%= link_if_authorized(edit_icon, {:controller =&gt; 'quotes/requests', :action =&gt; 'show', :id =&gt; value.id }) if (value.prod? || value.test? || value.auction? || value.test_auction? ) %&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">        &lt;%= bop = value.bidding_or_prebidding</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">            if (value.prod? || value.test? || value.auction? || value.test_auction? )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">              if bop == :bidding</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">                link_if_authorized(image_tag('icons/page_add', :title =&gt; translate('quotes_controller.enter_response')), {:controller =&gt; 'quotes/bidding_responses', :action =&gt; 'show', :id =&gt; value.id })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">              elsif bop == :prebidding</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">                link_if_authorized(image_tag('icons/page_add', :title =&gt; translate('quotes_controller.enter_response')), {:controller =&gt; 'quotes/prebidding_responses', :action =&gt; 'show', :id =&gt; value.id })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">            end %&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">        &lt;%= link_if_authorized(icon_button('delete', translate('defaults.delete')), {:controller =&gt; 'quotes/requests', :action =&gt; 'destroy', :id =&gt; value.id }, :confirm =&gt; t('defaults.are_you_sure'), :method =&gt; :delete, :remote =&gt; true) if value.inactive?%&gt;&quot;}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">      :find_options =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">        :order  =&gt; 'quote_requests.id DESC',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">        :joins  =&gt; &quot;LEFT OUTER JOIN `taggings` ON `taggings`.`taggable_id` = `quote_requests`.`id`</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">          AND `taggings`.`taggable_type` = 'QuoteRequest'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">          AND (`taggings`.`is_private` = 0 OR `taggings`.`created_by` = #{User.current_user_id})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">          LEFT OUTER JOIN `tags` ON `tags`.`id` = `taggings`.`tag_id`&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">      },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">      :filters =&gt; [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">          :label =&gt; 'Prod',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">          :conditions =&gt; [&quot;quote_requests.state in ('prod')&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">        },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">          :label =&gt; 'Test',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">          :conditions =&gt; [&quot;quote_requests.state in ('test')&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">        },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">          :label =&gt; 'Active',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">          :conditions =&gt; [&quot;quote_requests.state in ('prod', 'auction')&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">        },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">          :label =&gt; 'RFI',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">          :conditions =&gt; [&quot;quote_requests.event_type in ('rfi')&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">        },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">          :label =&gt; 'RFP',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">          :conditions =&gt; [&quot;quote_requests.event_type in ('rfp')&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">          :label =&gt; 'RFQ',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">          :conditions =&gt; [&quot;quote_requests.event_type in ('rfq')&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">      ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">      :title =&gt; 'quotes_controller.sourcing_manager',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">      :actions_top =&gt; [ 'new_template', 'new'],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">      :actions_top_options =&gt; { 'new' =&gt; { :action =&gt; 'popup' }, 'new_template' =&gt; {:action =&gt; 'template_popup'}},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">      :actions_top_html_options =&gt; { 'new' =&gt; {'data-remote-dialog' =&gt; true }, 'new_template' =&gt; {'data-remote-dialog' =&gt; true }},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">      :summary =&gt; :opportunities_summary</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">    }) # data_table</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">  def rfq_manager</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="125">
          <span class="hits">1</span>
          
          <code class="ruby">    @title = translate('quotes_controller.sourcing_manager')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="126">
          <span class="hits">1</span>
          
          <code class="ruby">    @tstr = render_quote_request_table</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="129">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">    rfq_manager</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">    render :action =&gt; 'rfq_manager'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="135">
          <span class="hits">31</span>
          
          <code class="ruby">    @quote_request = QuoteRequest.find(params[:id])</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="136">
          <span class="hits">31</span>
          
          <code class="ruby">    unless @quote_request</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="137">
          <span class="hits">2</span>
          
          <code class="ruby">      flash[:warning] = translate('quotes_controller.rfq_id_does_not', :id =&gt; params[:id])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="138">
          <span class="hits">2</span>
          
          <code class="ruby">      redirect_to :action =&gt; 'index'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="140">
          <span class="hits">31</span>
          
          <code class="ruby">    @quote_attachments =  @quote_request.quote_request_attachments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="142">
          <span class="hits">29</span>
          
          <code class="ruby">    @sections_settings ||= sections_settings @quote_request.id</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="143">
          <span class="hits">29</span>
          
          <code class="ruby">    @line_types = types</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="144">
          <span class="hits">29</span>
          
          <code class="ruby">    @event_name_title = @quote_request.description.blank? ? t('quotes_controller.request_for_sourcing_event') : @quote_request.description.truncate(25).to_s</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="145">
          <span class="hits">29</span>
          
          <code class="ruby">    @title = t(&quot;quotes_controller.request_for_quote_number&quot;, :event_description =&gt; @event_name_title, :num =&gt; @quote_request.id)</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="146">
          <span class="hits">29</span>
          
          <code class="ruby">    @title_modifier = &quot; &lt;span class='smaller'&gt;#{@quote_request.aasm_current_state.to_s.humanize}&lt;/span&gt; &quot;</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="147">
          <span class="hits">29</span>
          
          <code class="ruby">    unless @quote_request.inactive?</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="148">
          <span class="hits">28</span>
          
          <code class="ruby">      redirect_to :action =&gt; :show_active, :id =&gt; @quote_request.id</code>
        </li>
      
        <li class="covered" data-hits="28" data-linenumber="149">
          <span class="hits">28</span>
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="151">
          <span class="hits">1</span>
          
          <code class="ruby">    render action: :show</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">  def templatify</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">    @quote_request.templatify!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">    flash[:notice] = &quot;This event is now a template&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">    redirect_to quotes_request_path @quote_request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="161">
          <span class="hits">1</span>
          
          <code class="ruby">  def new_template</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.create(:event_type =&gt; QuoteRequest::EVENT_TYPES.first, :currency_id =&gt; User.current_user.default_currency.id, :automatic_bid_extensions =&gt; true)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">    QuoteRequestsUser.new({ :user_id =&gt; User.current_user.id, :quote_request_id =&gt; @quote_request.id, :attitude =&gt; &quot;creator&quot; }).save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">    @quote_request.templatify!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">    populate_logo</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">    redirect_to edit_quotes_request_path @quote_request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="170">
          <span class="hits">1</span>
          
          <code class="ruby">  def new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">    if params[:type_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">      @quote_request = QuoteRequest.create(:event_type =&gt; params[:type_id], :currency_id =&gt; User.current_user.default_currency.id, :automatic_bid_extensions =&gt; true)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">      QuoteRequestsUser.new({ :user_id =&gt; User.current_user.id,  :quote_request_id =&gt; @quote_request.id,  :attitude =&gt; &quot;creator&quot; }).save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">    elsif params[:event_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">      @quote_request = QuoteRequest.find(params[:event_id]).clone_request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">      @quote_request.find_or_create_creator</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">      @quote_request.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">      event_id = /#(?&lt;id&gt;\d+)/.match(params[:event_name_with_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">      if event_id.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">        flash[:warning] = I18n.t('quotes.request_form.no_event', :name =&gt; params[:event_name_with_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">        redirect_to :action =&gt; 'index'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">        return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">      @quote_request = QuoteRequest.find(event_id[:id]).clone_request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">      @quote_request.set_draft!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">      @quote_request.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">      @quote_request.find_or_create_creator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">    # Fill in logo from company logo</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">    populate_logo</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">    redirect_to edit_quotes_request_path @quote_request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="196">
          <span class="hits">1</span>
          
          <code class="ruby">  def edit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">    @quote_request ||= QuoteRequest.find_by_id(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">    if @quote_request &amp;&amp; @quote_request.editable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">      @quote_attachments = @quote_request.quote_request_attachments</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">      @sections_settings ||= sections_settings @quote_request.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">      @event_type = (@quote_request.event_type || params[:type_id] || 'rfq').to_sym</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">      @quote_request.local_start_time ||= Time.zone.today</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">      @line_types = types</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">      @event_name_title = @quote_request.description.blank? ? t('quotes_controller.request_for_sourcing_event') : @quote_request.description.truncate(25).to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">      @title = t(&quot;quotes_controller.request_for_quote_number&quot;, :event_description =&gt; @event_name_title, :num =&gt; @quote_request.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">      @title_modifier = &quot; &lt;span class='smaller'&gt;#{I18n.translate('defaults.edit')}&lt;/span&gt; &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">      flash[:warning] = translate('quotes_controller.rfq_id_is_not', :id =&gt; params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">      redirect_to :action =&gt; 'index'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="214">
          <span class="hits">1</span>
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.includes(:quote_suppliers).find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">    @quote_attachments = @quote_request.quote_request_attachments</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">    @sections_settings ||= sections_settings @quote_request.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">    @quote_request.edit_quote_suppliers(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">    @quote_request.create_quote_request_attachments params[:quote_request_attachments]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">    @quote_request.update_quote_request_attachments params[:edit_quote_request_attachments]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">    @quote_request.automatic_bid_extensions = params[:quote_request][:automatic_bid_extensions] || false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">    @quote_request.start_on_submit = params[:quote_request][:start_on_submit] || false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">    @quote_request.bid_on_start = params[:quote_request][:bin_on_start] || false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">    # Section: Timeline</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">    # TODO: temporary workaround incorrect date format (y-m-d)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">    params[:quote_request][:start_time] = DateTime.strptime(params[:quote_request][:start_time], &quot;%m/%d/%y %I:%M %p %z&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">    params[:quote_request][:bidding_time] = DateTime.strptime(params[:quote_request][:bidding_time], &quot;%m/%d/%y %I:%M %P %z&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="231">
          
          
          <code class="ruby">    params[:quote_request][:end_time] = DateTime.strptime(params[:quote_request][:end_time], &quot;%m/%d/%y %I:%M %p %z&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">    params[:quote_request][:incremental_bidding_options] = @quote_request.process_incremental_bidding_options(params[:quote_request][:incremental_bidding_options])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="235">
          
          
          <code class="ruby">    params[:quote_request][:buyers_logo] = nil if params[:quote_request_clear_logo].to_i == 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="237">
          
          
          <code class="ruby">    params[:quote_request][:closed_at_state] = (params[:quote_request][:competitive_bidding] == 'true' || params[:quote_request][:event_type] == 'auction') ? 'bidding' : 'prebidding'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">    if @quote_request.update_attributes(params[:quote_request])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="240">
          
          
          <code class="ruby">      if params['event_state'] == 'set_test'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="241">
          
          
          <code class="ruby">        prev_as_test_validate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="242">
          
          
          <code class="ruby">        return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="244">
          
          
          <code class="ruby">      if (params['event_state'] == 'set_prod')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="245">
          
          
          <code class="ruby">        prev_as_prod_validate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="246">
          
          
          <code class="ruby">        return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="248">
          
          
          <code class="ruby">      flash[:notice] = if @quote_request.prod?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">        if params[:open_to_csn_suppliers]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">          translate('quotes_controller.rfq_id_issued_and', :id =&gt; @quote_request.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">         translate('quotes_controller.rfq_id_issued', :id =&gt; @quote_request.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">         translate('quotes_controller.rfq_id_saved', :id =&gt; @quote_request.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">       end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">      redirect_to :action =&gt; 'index'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="259">
          
          
          <code class="ruby">      @line_types = types</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="260">
          
          
          <code class="ruby">      @event_name_title = @quote_request.description.blank? ? t('quotes_controller.request_for_sourcing_event') : @quote_request.description.truncate(25).to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">      @title = t(&quot;quotes_controller.request_for_quote_number&quot;, :event_description =&gt; @event_name_title, :num =&gt; @quote_request.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="262">
          
          
          <code class="ruby">      @title_modifier = &quot; &lt;span class='smaller'&gt;#{I18n.translate('defaults.create')}&lt;/span&gt; &quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="263">
          
          
          <code class="ruby">      render :action =&gt; 'edit', :id =&gt; params[:id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="267">
          <span class="hits">1</span>
          
          <code class="ruby">  def destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="268">
          
          
          <code class="ruby">    @qr = QuoteRequest.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="269">
          
          
          <code class="ruby">    if @qr.destroyable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="270">
          
          
          <code class="ruby">      @qr.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="271">
          
          
          <code class="ruby">      if params[:rfq_is_new]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="272">
          
          
          <code class="ruby">        redirect_to quotes_requests_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">        respond_to do |wants|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">          wants.js {</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">            @tstr = render_quote_request_table</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">            flash.now[:notice] = translate('quotes_controller.sourcing_event_deleted', :id =&gt; params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="278">
          
          
          <code class="ruby">            render :update do |page|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="279">
          
          
          <code class="ruby">              page.reload_flash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="280">
          
          
          <code class="ruby">              page.replace('quote_request_data_table_form',@tstr)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="283">
          
          
          <code class="ruby">          wants.html{redirect_to :back}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="289">
          <span class="hits">1</span>
          
          <code class="ruby">  def prev_as_test_validate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="290">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="291">
          
          
          <code class="ruby">    if @quote_request.can_be_saved_as_test_prod?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">      @quote_request.fill_banner_with_defaults</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="293">
          
          
          <code class="ruby">      redirect_to prev_as_test_quotes_request_url(@quote_request.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">      @line_types = types</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="296">
          
          
          <code class="ruby">      @event_name_title = @quote_request.description.blank? ? t('quotes_controller.request_for_sourcing_event') : @quote_request.description.truncate(25).to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="297">
          
          
          <code class="ruby">      @title = t(&quot;quotes_controller.request_for_quote_number&quot;, :event_description =&gt; @event_name_title, :num =&gt; @quote_request.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">      @title_modifier = &quot; &lt;span class='smaller'&gt;#{I18n.translate('defaults.edit')}&lt;/span&gt; &quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">      render :action =&gt; 'edit'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="303">
          <span class="hits">1</span>
          
          <code class="ruby">  def prev_as_prod_validate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="304">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="305">
          
          
          <code class="ruby">    if @quote_request.can_be_saved_as_test_prod?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="306">
          
          
          <code class="ruby">      @quote_request.fill_banner_with_defaults</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="307">
          
          
          <code class="ruby">      quote_suppliers = params[&quot;quote_suppliers&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="308">
          
          
          <code class="ruby">      unless quote_suppliers.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="309">
          
          
          <code class="ruby">        @fill_suppliers_responses_id = quote_suppliers.reject{ |id, values| values[&quot;followed_from&quot;].nil? }.keys.collect{|k| k.to_i}.join(&quot; &quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="311">
          
          
          <code class="ruby">      redirect_to prev_as_prod_quotes_request_url(@quote_request.id, :fill_suppliiers_responses =&gt; @fill_suppliers_responses_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="313">
          
          
          <code class="ruby">      @line_types = types</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">      @event_name_title = @quote_request.description.blank? ? t('quotes_controller.request_for_sourcing_event') : @quote_request.description.truncate(25).to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="315">
          
          
          <code class="ruby">      @title = t(&quot;quotes_controller.request_for_quote_number&quot;, :event_description =&gt; @event_name_title, :num =&gt; @quote_request.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="316">
          
          
          <code class="ruby">      @title_modifier = &quot; &lt;span class='smaller'&gt;#{I18n.translate('defaults.edit')}&lt;/span&gt; &quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="317">
          
          
          <code class="ruby">      render :action =&gt; 'edit'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="321">
          <span class="hits">1</span>
          
          <code class="ruby">  def prev_as_test</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="322">
          
          
          <code class="ruby">    @errors ||= []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="323">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="324">
          
          
          <code class="ruby">    @quote_time_line = @quote_request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="325">
          
          
          <code class="ruby">    @quote_suppliers = @quote_request.quote_suppliers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="326">
          
          
          <code class="ruby">    @mode = :prev_as_test</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="329">
          <span class="hits">1</span>
          
          <code class="ruby">  def prev_as_prod</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="330">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="331">
          
          
          <code class="ruby">    @fill_suppliiers_responses = params[:fill_suppliiers_responses]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="334">
          <span class="hits">1</span>
          
          <code class="ruby">  def save_prev_as_test</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="335">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find(params[:id]).clone_request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="336">
          
          
          <code class="ruby">    @quote_request.edit_quote_suppliers(params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="337">
          
          
          <code class="ruby">    @quote_request.start_on_submit = params[:quote_request][:start_on_submit] || false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="338">
          
          
          <code class="ruby">    @quote_request.bid_on_start = params[:quote_request][:bin_on_start] || false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="340">
          
          
          <code class="ruby">    @quote_request.banner_title = params[:quote_request][:banner_title]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="341">
          
          
          <code class="ruby">    @quote_request.banner_text = params[:quote_request][:banner_text]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="343">
          
          
          <code class="ruby">    params[:quote_request][:start_time] = DateTime.strptime(params[:quote_request][:start_time], &quot;%m/%d/%y %I:%M %p %z&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="344">
          
          
          <code class="ruby">    params[:quote_request][:bidding_time] = DateTime.strptime(params[:quote_request][:bidding_time], &quot;%m/%d/%y %I:%M %P %z&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="345">
          
          
          <code class="ruby">    params[:quote_request][:end_time] = DateTime.strptime(params[:quote_request][:end_time], &quot;%m/%d/%y %I:%M %p %z&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="346">
          
          
          <code class="ruby">    if @quote_request.update_attributes(params[:quote_request]) &amp;&amp; @quote_request.can_be_saved_as_test_prod?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="347">
          
          
          <code class="ruby">      @quote_request.set_test!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="348">
          
          
          <code class="ruby">      flash[:notice] = translate('quotes_controller.quote_position_test_saved', :position =&gt; @quote_request.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="349">
          
          
          <code class="ruby">      redirect_to :action =&gt; 'index'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="350">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="351">
          
          
          <code class="ruby">      @errors = @quote_request.errors.values</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="352">
          
          
          <code class="ruby">      @quote_suppliers = @quote_request.quote_suppliers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="353">
          
          
          <code class="ruby">      @quote_time_line = @quote_request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="354">
          
          
          <code class="ruby">      @quote_request.delete</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="355">
          
          
          <code class="ruby">      @quote_request = QuoteRequest.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="356">
          
          
          <code class="ruby">      @mode = :save_prev_as_test</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="357">
          
          
          <code class="ruby">      render :action =&gt; :prev_as_test</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="358">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="361">
          <span class="hits">1</span>
          
          <code class="ruby">   def save_as_prod</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="362">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="363">
          
          
          <code class="ruby">    if @quote_request.update_attributes(params[:quote_request]) &amp;&amp; @quote_request.can_be_saved_as_test_prod?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="364">
          
          
          <code class="ruby">      @quote_request.set_prod!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby">      </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="366">
          
          
          <code class="ruby">      @quote_request.fill_suppliiers_responses params[:fill_suppliiers_responses].split(&quot; &quot;).collect{ |k| k.to_i }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="367">
          
          
          <code class="ruby">      flash[:notice] = translate('quotes_controller.quote_position_prod_saved', :position =&gt; @quote_request.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="368">
          
          
          <code class="ruby">      redirect_to :action =&gt; 'index'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="370">
          
          
          <code class="ruby">      @line_types = types</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="371">
          
          
          <code class="ruby">      @event_name_title = @quote_request.description.blank? ? t('quotes_controller.request_for_sourcing_event') : @quote_request.description.truncate(25).to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="372">
          
          
          <code class="ruby">      @title = t(&quot;quotes_controller.request_for_quote_number&quot;, :event_description =&gt; @event_name_title, :num =&gt; @quote_request.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="373">
          
          
          <code class="ruby">      @title_modifier = &quot; &lt;span class='smaller'&gt;#{I18n.translate('defaults.edit')}&lt;/span&gt; &quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="374">
          
          
          <code class="ruby">      render :action =&gt; 'edit'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="376">
          
          
          <code class="ruby">   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="377">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="378">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby">  #  Remind to supplier</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="381">
          <span class="hits">1</span>
          
          <code class="ruby">  def remind_to_supplier</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="382">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find_by_id(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="383">
          
          
          <code class="ruby">    @quote_supplier = QuoteSupplier.find_by_id(params[:supplier])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="384">
          
          
          <code class="ruby">    QuotesMailer.remind_to_supplier(@quote_request, @quote_supplier)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">    render :update do |page|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="386">
          
          
          <code class="ruby">      flash.now[:notice] = translate('quotes.request_form.remind_letter_notification')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="387">
          
          
          <code class="ruby">      page.replace_html &quot;#flash_container.sticky&quot;, :partial =&gt; &quot;layouts/flash_container&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="388">
          
          
          <code class="ruby">      page &lt;&lt; &quot;shiftCountDown();&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="389">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="390">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="391">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="392">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="393">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="394">
          
          
          <code class="ruby">  #  Popup window for new event creation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="396">
          <span class="hits">1</span>
          
          <code class="ruby">  def popup</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="397">
          
          
          <code class="ruby">    @recent_events = QuoteRequest.select([:id, :description, :state]).order(:created_at).last(5)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="398">
          
          
          <code class="ruby">    event_type_struct = Struct.new(:id, :translated_title)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="399">
          
          
          <code class="ruby">    @event_types = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="400">
          
          
          <code class="ruby">    QuoteRequest::EVENT_TYPES.each do |type|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="401">
          
          
          <code class="ruby">      event_type = event_type_struct.new(type, I18n.t(type, :scope =&gt; 'quotes_controller'))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="402">
          
          
          <code class="ruby">      @event_types.push(event_type)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="403">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="404">
          
          
          <code class="ruby">    render :popup, :layout =&gt; false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="405">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="407">
          <span class="hits">1</span>
          
          <code class="ruby">  def template_popup</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="408">
          
          
          <code class="ruby">    @template = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="409">
          
          
          <code class="ruby">    popup</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="410">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="411">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="412">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="413">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="414">
          
          
          <code class="ruby">  #  Memorizing user's choise of selection collapsed state</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby">  #  TODO: Rewrite this with `first_or_create` after switching to Rails 3.1 or upper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="416">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="417">
          <span class="hits">1</span>
          
          <code class="ruby">  def switch_section_state</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="418">
          
          
          <code class="ruby">    options = { :user_id =&gt; User.current_user.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="419">
          
          
          <code class="ruby">                :key =&gt; &quot;event_request_section_#{params[:quote_request_id]}_#{params[:section]}&quot;}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="420">
          
          
          <code class="ruby">    setting = UserAttribute.where options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="421">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="422">
          
          
          <code class="ruby">    render :text =&gt; setting.exists? ?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="423">
          
          
          <code class="ruby">      (setting.first.update_attribute(:value, params[:collapsed]) ? &quot;ok&quot; : &quot;fail&quot;) :</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="424">
          
          
          <code class="ruby">      (UserAttribute.create(options.merge({:value =&gt; params[:collapsed]})) ? &quot;ok&quot; : &quot;fail&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="425">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="426">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="427">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="428">
          
          
          <code class="ruby">  #  Copy by popup</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="429">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="430">
          <span class="hits">1</span>
          
          <code class="ruby">  def copy_in_popup</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="431">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find params[:quote_request]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="432">
          
          
          <code class="ruby">    render :partial =&gt; 'copy_in_popup'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="433">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="434">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="435">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="436">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="437">
          
          
          <code class="ruby">  #  Copy questionnaries from event by popup</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="438">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="439">
          <span class="hits">1</span>
          
          <code class="ruby">  def copy_questionnaries_from_event</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="440">
          
          
          <code class="ruby">    @template = params[:template] == &quot;true&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="441">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find params[:quote_request]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="442">
          
          
          <code class="ruby">    render :partial =&gt; 'copy_questionnaries_from_event'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="443">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="444">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="445">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="446">
          
          
          <code class="ruby">  #  Copy questionnarie</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="447">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="448">
          <span class="hits">1</span>
          
          <code class="ruby">  def copy_questionarrie</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="449">
          
          
          <code class="ruby">    unless QuoteRequest.find(params[:quote_request_id]).any_submitted_responses?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="450">
          
          
          <code class="ruby">      forms = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="451">
          
          
          <code class="ruby">      if params[:event_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="452">
          
          
          <code class="ruby">        forms += QuoteRequest.find(params[:event_id]).forms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="453">
          
          
          <code class="ruby">      elsif params[:event_name]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="454">
          
          
          <code class="ruby">        event_id = /#(?&lt;id&gt;\d+)/.match(params[:event_name])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="455">
          
          
          <code class="ruby">        if event_id.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="456">
          
          
          <code class="ruby">          render :update do |page|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="457">
          
          
          <code class="ruby">            flash.now[:warning] = I18n.t('quotes.request_form.no_event', :name =&gt; params[:event_name])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="458">
          
          
          <code class="ruby">            page.replace_html &quot;#flash_container.sticky&quot;, :partial =&gt; &quot;layouts/flash_container&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="459">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="460">
          
          
          <code class="ruby">          return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="461">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="462">
          
          
          <code class="ruby">        forms += QuoteRequest.find(event_id[:id]).forms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="463">
          
          
          <code class="ruby">      elsif params[:form_name]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="464">
          
          
          <code class="ruby">        form = Form.find_by_name(params[:form_name])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="465">
          
          
          <code class="ruby">        unless form</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="466">
          
          
          <code class="ruby">          render :update do |page|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="467">
          
          
          <code class="ruby">            flash.now[:warning] = I18n.t('quotes.request_form.no_quest', :name =&gt; params[:form_name])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="468">
          
          
          <code class="ruby">            page.replace_html &quot;#flash_container.sticky&quot;, :partial =&gt; &quot;layouts/flash_container&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="469">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="470">
          
          
          <code class="ruby">          return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="471">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="472">
          
          
          <code class="ruby">        forms &lt;&lt; form</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="473">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="474">
          
          
          <code class="ruby">        forms &lt;&lt; Form.find(params[:form_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="475">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="476">
          
          
          <code class="ruby">      if params[:quote_request_id] &amp;&amp; (quote = QuoteRequest.find(params[:quote_request_id]))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="477">
          
          
          <code class="ruby">        forms -= quote.forms</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="478">
          
          
          <code class="ruby">        quote.forms &lt;&lt; forms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="479">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="480">
          
          
          <code class="ruby">        render :update do |page|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="481">
          
          
          <code class="ruby">          html = ''</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="482">
          
          
          <code class="ruby">          forms.each do |form|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="483">
          
          
          <code class="ruby">            html &lt;&lt; &quot;&lt;li class='questionarrie' id ='question_#{form.id}'&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="484">
          
          
          <code class="ruby">            html &lt;&lt; &quot;&lt;span&gt;&quot; + rollover_link_to_remote(&quot;&lt;img alt='Delete' class='icon icon_button sprite-delete' src='/images/blank.gif' title='Delete'&gt;&quot;, :url=&gt;{ :controller =&gt; '/quotes/requests', :action =&gt; 'remove_questionarrie', :form_id =&gt; form.id, :quote_request_id =&gt; quote.id }, :loading =&gt; &quot;$('spinner').show()&quot;,  :loaded =&gt; &quot;$('spinner').hide();$('#question_#{form.id}').fadeOut().remove();&quot;) + &quot;&lt;/span&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="485">
          
          
          <code class="ruby">            html &lt;&lt; &quot;&lt;span  class='text_icon'&gt;&lt;/span&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="486">
          
          
          <code class="ruby">            html &lt;&lt; &quot;&lt;span class='title'&gt; #{link_to form.name, {:controller =&gt; '/forms', :action =&gt; 'edit', :id =&gt; form.id}, :target =&gt; '_blank'}&lt;/span&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="487">
          
          
          <code class="ruby">            html &lt;&lt; &quot;&lt;/li&gt;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="488">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="489">
          
          
          <code class="ruby">          page &lt;&lt; &quot;$('#quote_questionarries .questionarries .already_existed').append('#{escape_javascript html}');&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="490">
          
          
          <code class="ruby">          page &lt;&lt; &quot;close_topmost_dialog()&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="491">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="492">
          
          
          <code class="ruby">          flash.now[:notice] = I18n.t('quotes.request_form.add_quest_flash', :number =&gt; forms.size)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="493">
          
          
          <code class="ruby">          page.replace_html &quot;#flash_container.sticky&quot;, :partial =&gt; &quot;layouts/flash_container&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="494">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="495">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="496">
          
          
          <code class="ruby">        render :update do |page|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="497">
          
          
          <code class="ruby">          page &lt;&lt; &quot;$('#popup_container').html('#{escape_javascript(render :partial =&gt; 'copy_in_popup')}')&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="498">
          
          
          <code class="ruby">          page &lt;&lt; &quot;$('#popup_container').refresh_dialog_buttons();&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="499">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="500">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="501">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="502">
          
          
          <code class="ruby">      render :update do |page|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="503">
          
          
          <code class="ruby">        page &lt;&lt; &quot;close_topmost_dialog()&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="504">
          
          
          <code class="ruby">        flash.now[:notice] = &quot;Responses were added&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="505">
          
          
          <code class="ruby">        page.replace_html &quot;#flash_container.sticky&quot;, :partial =&gt; &quot;layouts/flash_container&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="506">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="507">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="508">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="509">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="510">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="511">
          
          
          <code class="ruby">  #  Remove questionnarie</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="512">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="513">
          <span class="hits">1</span>
          
          <code class="ruby">  def remove_questionarrie</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="514">
          
          
          <code class="ruby">    form = Form.find_by_id(params[:form_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="515">
          
          
          <code class="ruby">    event = QuoteRequest.find_by_id(params[:quote_request_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="516">
          
          
          <code class="ruby">    event.forms.delete form</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="517">
          
          
          <code class="ruby">    render :json =&gt; {}, :status =&gt; :ok</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="518">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="519">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="520">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="521">
          
          
          <code class="ruby">  #  Autocomplete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="522">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="523">
          <span class="hits">1</span>
          
          <code class="ruby">  def auto_complete</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="524">
          
          
          <code class="ruby">    this_quote = QuoteRequest.find(params[:quote_request_id]) unless params[:quote_request_id].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="525">
          
          
          <code class="ruby">    qr_root = params[:template]==&quot;true&quot; ? QuoteRequest.template : QuoteRequest.not_template # only show templates for the template autocomplete</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="526">
          
          
          <code class="ruby">    matched_questionnaries = qr_root.where(['lower(description) like ? OR id like ?', &quot;%#{params[:term]}%&quot;, &quot;%#{params[:term].gsub('#', '')}%&quot;]).order(&quot;state DESC&quot;).map do |q|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="527">
          
          
          <code class="ruby">      next if(q.nil? || (!params[:quote_request_id].nil? &amp;&amp; this_quote.id == q.id))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="528">
          
          
          <code class="ruby">      label = (q.description.nil? || q.description.empty?) ? &quot;Event ##{q.id} (#{q.state.capitalize if q.state})&quot; : &quot;#{q.description.truncate(30)} - ##{q.id} (#{q.state.capitalize if q.state})&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="529">
          
          
          <code class="ruby">      {:label =&gt; label, :value =&gt; label }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="530">
          
          
          <code class="ruby">    end.to_a.compact</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="531">
          
          
          <code class="ruby">    render :json =&gt; matched_questionnaries</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="532">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="533">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="534">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="535">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="536">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_quote_supplier</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="537">
          
          
          <code class="ruby">    quote_request = QuoteRequest.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="538">
          
          
          <code class="ruby">    quote_supplier = quote_request.quote_suppliers.create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="539">
          
          
          <code class="ruby">    render :json =&gt; { id: quote_supplier.id }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="540">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="541">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="542">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="543">
          
          
          <code class="ruby">  #  Copy Suppliers Popup</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="544">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="545">
          <span class="hits">1</span>
          
          <code class="ruby">  def copy_suppliers_popup</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="546">
          
          
          <code class="ruby">    @template = params[:template] == &quot;true&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="547">
          
          
          <code class="ruby">    root_qr = @template ? QuoteRequest.template : QuoteRequest.not_template</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="548">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find params[:quote_request_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="549">
          
          
          <code class="ruby">    @background_class = params[:background_class]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="550">
          
          
          <code class="ruby">    @recent_quote_requests = root_qr.recent(5, @quote_request.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="551">
          
          
          <code class="ruby">    render :partial =&gt; 'copy_suppliers_popup', :layout =&gt; false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="552">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="553">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="554">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="555">
          <span class="hits">1</span>
          
          <code class="ruby">  def copy_suppliers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="556">
          
          
          <code class="ruby">    event_id = params[:event_id] ? {id: params[:event_id]} : /#(?&lt;id&gt;\d+)/.match(params[:event_name])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="557">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="558">
          
          
          <code class="ruby">    if event_id.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="559">
          
          
          <code class="ruby">      render :update do |page|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="560">
          
          
          <code class="ruby">        flash.now[:warning] = I18n.t('quotes.request_form.no_event', :name =&gt; params[:event_name])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="561">
          
          
          <code class="ruby">        page.replace_html &quot;#flash_container.sticky&quot;, :partial =&gt; &quot;layouts/flash_container&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="562">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="563">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="564">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="565">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="566">
          
          
          <code class="ruby">    @style = params[:background_class]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="567">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find_by_id(event_id[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="568">
          
          
          <code class="ruby">    @new_quote_request  = QuoteRequest.find_by_id(params[:quote_request_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="569">
          
          
          <code class="ruby">    if @quote_request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="570">
          
          
          <code class="ruby">      @quote_suppliers = @quote_request.quote_suppliers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="571">
          
          
          <code class="ruby">      render :update do |page|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="572">
          
          
          <code class="ruby">        html = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="573">
          
          
          <code class="ruby">        @quote_suppliers.each do |quote_supplier|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="574">
          
          
          <code class="ruby">          html &lt;&lt; &quot;#{escape_javascript(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="575">
          
          
          <code class="ruby">            render :partial =&gt; &quot;supplier_line&quot;, :locals =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="576">
          
          
          <code class="ruby">              :quote_supplier =&gt; quote_supplier,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="577">
          
          
          <code class="ruby">              :zebra =&gt; @style,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="578">
          
          
          <code class="ruby">              :new_quote_supplier =&gt; true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="579">
          
          
          <code class="ruby">              :copy_from_quote_supplier =&gt; quote_supplier.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="580">
          
          
          <code class="ruby">              :copy_logo =&gt; 1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="581">
          
          
          <code class="ruby">              :event =&gt; false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="582">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="583">
          
          
          <code class="ruby">          )}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="584">
          
          
          <code class="ruby">          @style = (@style == &quot;odd&quot; ? &quot;even&quot; : &quot;odd&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="585">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="586">
          
          
          <code class="ruby">        flash.now[:notice] = I18n.t('quotes.request_form.add_suppliers_flash', :number =&gt; @quote_suppliers.size)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="587">
          
          
          <code class="ruby">        if !@new_quote_request.inactive?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="588">
          
          
          <code class="ruby">         flash.now[:notice] += I18n.t('quotes.request_form.suppliers_mail_warning')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="589">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="590">
          
          
          <code class="ruby">        page.replace_html &quot;#flash_container.sticky&quot;, :partial =&gt; &quot;layouts/flash_container&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="591">
          
          
          <code class="ruby">        page &lt;&lt; &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="592">
          
          
          <code class="ruby">          $('#suppliers .suppliers_list').append('#{raw html}');</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="593">
          
          
          <code class="ruby">          close_topmost_dialog();</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="594">
          
          
          <code class="ruby">          $('#end_suppliers_list').click();</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="595">
          
          
          <code class="ruby">          shiftCountDown();</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="596">
          
          
          <code class="ruby">        &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="597">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="598">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="599">
          
          
          <code class="ruby">      flash.now[:notice] = I18n.t('quotes.request_form.add_suppliers_flash', :number =&gt; 0)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="600">
          
          
          <code class="ruby">      render :update do |page|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="601">
          
          
          <code class="ruby">        flash.now[:warning] = I18n.t('quotes.request_form.no_event', :name =&gt; params[:event_name])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="602">
          
          
          <code class="ruby">        page.replace_html &quot;#flash_container.sticky&quot;, :partial =&gt; &quot;layouts/flash_container&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="603">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="604">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="605">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="606">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="607">
          <span class="hits">1</span>
          
          <code class="ruby">  def follow_on</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="608">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find_by_id(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="609">
          
          
          <code class="ruby">    if @quote_request.closed?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="610">
          
          
          <code class="ruby">      @follow_quote_request = @quote_request.clone_request :follow</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="611">
          
          
          <code class="ruby">      redirect_to edit_quotes_request_path @follow_quote_request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="612">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="613">
          
          
          <code class="ruby">      flash[:notice] = &quot;Event is'nt completed yet!&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="614">
          
          
          <code class="ruby">      redirect_to quotes_requests_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="615">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="616">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="617">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="618">
          <span class="hits">1</span>
          
          <code class="ruby">  def export_question_item_xls</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="619">
          
          
          <code class="ruby">    flash[:notice] = &quot;Export completed successfully.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="620">
          
          
          <code class="ruby">    render :update do |page|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="621">
          
          
          <code class="ruby">      page.reload_flash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="622">
          
          
          <code class="ruby">      page.redirect_to :action =&gt; &quot;send_xls_download&quot;, :quote_id =&gt; params[:id], :include_responses =&gt; false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="623">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="624">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="625">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="626">
          <span class="hits">1</span>
          
          <code class="ruby">  def export_rfq_responses_xls</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="627">
          
          
          <code class="ruby">    flash[:notice] = &quot;Export completed successfully.&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="628">
          
          
          <code class="ruby">    render :update do |page|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="629">
          
          
          <code class="ruby">      page.reload_flash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="630">
          
          
          <code class="ruby">      page.redirect_to :action =&gt; &quot;send_xls_download&quot;, :quote_id =&gt; params[:id], :include_responses =&gt; true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="631">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="632">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="633">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="634">
          <span class="hits">1</span>
          
          <code class="ruby">  def send_xls_download</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="635">
          
          
          <code class="ruby">    @find_opts = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="636">
          
          
          <code class="ruby">    @find_opts[:id] = params[:quote_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="637">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="638">
          
          
          <code class="ruby">    partial = (params[:include_responses] == &quot;true&quot; ? 'quotes/requests/excel_rfx_responses.xml' : 'quotes/requests/excel_rfx.xml')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="639">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="640">
          
          
          <code class="ruby">    send_data render_to_string(:partial =&gt; partial), :type =&gt; 'application/vnd.ms-excel', :filename =&gt; &quot;rfx.xls&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="641">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="642">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="643">
          <span class="hits">1</span>
          
          <code class="ruby">  def end_event_pop_up</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="644">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find params[:id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="645">
          
          
          <code class="ruby">    render :partial =&gt; 'end_event_popup', :layout =&gt; false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="646">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="647">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="648">
          <span class="hits">1</span>
          
          <code class="ruby">  def end_event</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="649">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find params[:id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="650">
          
          
          <code class="ruby">    @quote_request.timeline_changed = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="651">
          
          
          <code class="ruby">    @quote_request.complete!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="652">
          
          
          <code class="ruby">    redirect_to show_active_quotes_request_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="653">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="654">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="655">
          <span class="hits">1</span>
          
          <code class="ruby">  def flash_changes</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="656">
          
          
          <code class="ruby">    render :update do |page|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="657">
          
          
          <code class="ruby">      flash.now[:notice] = t &quot;quotes_controller.apply_changes&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="658">
          
          
          <code class="ruby">      page.replace_html &quot;#flash_container.sticky&quot;, :partial =&gt; &quot;layouts/flash_container&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="659">
          
          
          <code class="ruby">      page &lt;&lt; &quot;shiftCountDown();&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="660">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="661">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="662">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="663">
          
          
          <code class="ruby">  #Weighted Total calculation</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="664">
          <span class="hits">1</span>
          
          <code class="ruby">  def weighted_total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="665">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find params[:id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="666">
          
          
          <code class="ruby">    baseTotal = @quote_request.lines.map { |line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="667">
          
          
          <code class="ruby">      (line.price_amount * (line.quantity || 1).to_i) * (line.lot.try(:expected_quantity) || 1).to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="668">
          
          
          <code class="ruby">    }.compact.reduce(&amp;:+)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="669">
          
          
          <code class="ruby">    baseTotal ||= 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="670">
          
          
          <code class="ruby">    currency = Currency.find(@quote_request.currency_id).code</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="671">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="672">
          
          
          <code class="ruby">    render :json =&gt; { :baseTotal =&gt; baseTotal, :currency =&gt; currency}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="673">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="674">
          <span class="hits">1</span>
          
          <code class="ruby">  def feedback_popup</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="675">
          
          
          <code class="ruby">    @response_id ||= params[:response_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="676">
          
          
          <code class="ruby">    @quote_response = QuoteResponse.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="677">
          
          
          <code class="ruby">    render :layout =&gt; false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="678">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="679">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="680">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_savings</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="681">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="682">
          
          
          <code class="ruby">    [:savings, :weight_attachments, :weight_questionnaires, :weight_items].each do |attr|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="683">
          
          
          <code class="ruby">      if params[attr].empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="684">
          
          
          <code class="ruby">        params[attr] = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="685">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="686">
          
          
          <code class="ruby">      @quote_request.send(&quot;#{attr}=&quot;, params[attr])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="687">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="688">
          
          
          <code class="ruby">    @quote_request.commodity = Commodity.find(params[:commodity_id]) unless params[:commodity_id].empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="689">
          
          
          <code class="ruby">    if @quote_request.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="690">
          
          
          <code class="ruby">      flash[:notice] = I18n.translate(&quot;quotes_controller.update_savings&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="691">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="692">
          
          
          <code class="ruby">      flash[:message] = I18n.translate(&quot;quotes_controller.weights_amount&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="693">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="694">
          
          
          <code class="ruby">    render :update do |page|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="695">
          
          
          <code class="ruby">      page.reload_flash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="696">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="697">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="698">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="699">
          <span class="hits">1</span>
          
          <code class="ruby">  def request_feedback_for_responses</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="700">
          
          
          <code class="ruby">    @user_ids = (params[&quot;quote_response&quot;][&quot;feedback_user_ids&quot;] - [&quot;&quot;]).map(&amp;:to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="701">
          
          
          <code class="ruby">    @response_ids = params[&quot;feedback_response_ids&quot;].split(',').map(&amp;:to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="702">
          
          
          <code class="ruby">    @feedback_note = params[&quot;feedback_note&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="703">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="704">
          
          
          <code class="ruby">    @quote_request = QuoteResponse.find(@response_ids.first).quote_request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="705">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="706">
          
          
          <code class="ruby">    # add users to responses</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="707">
          
          
          <code class="ruby">    @response_ids.each do |response_id|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="708">
          
          
          <code class="ruby">      qr = QuoteResponse.find(response_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="709">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="710">
          
          
          <code class="ruby">      # create a new feedback user for every user that doesn't exist yet</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="711">
          
          
          <code class="ruby">      (@user_ids - qr.all_feedback_users.map(&amp;:user_id)).each do |user_id|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="712">
          
          
          <code class="ruby">        qr.feedback_users &lt;&lt; QuoteResponseFeedbackUser.new(:user_id =&gt; user_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="713">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="714">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="715">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="716">
          
          
          <code class="ruby">    # add todos to users that don't have it yet</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="717">
          
          
          <code class="ruby">    # send notifications to all users</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="718">
          
          
          <code class="ruby">    Notifier.request_rfq_feedback(@quote_request, @feedback_note, User.where(:id =&gt; @user_ids).to_a)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="719">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="720">
          
          
          <code class="ruby">    render :update do |page|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="721">
          
          
          <code class="ruby">      flash.now[:notice] = &quot;requests for response feedback sent!&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="722">
          
          
          <code class="ruby">      page.reload_flash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="723">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="724">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="725">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="726">
          <span class="hits">1</span>
          
          <code class="ruby">  def calculate_savings</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="727">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="728">
          
          
          <code class="ruby">    expected_total = @quote_request.item_total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="729">
          
          
          <code class="ruby">    awarded = @quote_request.awarded_responses</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="730">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="731">
          
          
          <code class="ruby">    if awarded.length == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="732">
          
          
          <code class="ruby">      awarded_total = awarded.first.item_total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="733">
          
          
          <code class="ruby">      render :json =&gt; {:status =&gt; :success, :amount =&gt; ((expected_total - awarded_total).amount)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="734">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="735">
          
          
          <code class="ruby">      render :json =&gt; {:status =&gt; :failure}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="736">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="737">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="738">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="739">
          <span class="hits">1</span>
          
          <code class="ruby">  def provide_feedback</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="740">
          
          
          <code class="ruby">    # TODO we can't rly need this many vars, wth</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="741">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.includes(:quote_suppliers).find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="742">
          
          
          <code class="ruby">    @sections_settings ||= sections_settings @quote_request.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="743">
          
          
          <code class="ruby">    @event_name_title = @quote_request.description.blank? ? t('quotes_controller.request_for_sourcing_event') : @quote_request.description.truncate(25).to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="744">
          
          
          <code class="ruby">    @title = t(&quot;quotes_controller.request_for_quote_number&quot;, :event_description =&gt; @event_name_title, :num =&gt; @quote_request.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="745">
          
          
          <code class="ruby">    @title_modifier =  &quot;&lt;span class='smaller'&gt;#{ @quote_request.preprebidding_period? ? t('quotes_controller.in_preprebidding') : t('quotes_controller.prebid_in_progress')}&lt;/span&gt;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="746">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="747">
          
          
          <code class="ruby">    @quote_suppliers = @quote_request.quote_suppliers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="748">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="749">
          
          
          <code class="ruby">    # caveat - we can't provide feedback, or link feedback users, to quote responses that haven't come in yet</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="750">
          
          
          <code class="ruby">    @quote_responses = @quote_suppliers.map{|qs| qs.last_quote_request_response(@quote_request)}.compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="751">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="752">
          
          
          <code class="ruby">    # now go back and scope down to only the quote responses that this user can see</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="753">
          
          
          <code class="ruby">    # this sucks too</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="754">
          
          
          <code class="ruby">    @quote_response_feedback_users = @quote_responses.map{|qr| qr.feedback_user(User.current_user)}.compact</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="755">
          
          
          <code class="ruby">    @quote_suppliers = @quote_response_feedback_users.map(&amp;:quote_response).map(&amp;:quote_supplier)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="756">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="757">
          
          
          <code class="ruby">    @quote_responses = @quote_suppliers.map{|qs| qs.last_quote_request_response(@quote_request)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="758">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="759">
          
          
          <code class="ruby">    @attachment_data     = QuoteResponse.attachment_data_lines(@quote_responses)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="760">
          
          
          <code class="ruby">    @questionnaires_data = QuoteResponse.questionnaire_data_lines(@quote_responses)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="761">
          
          
          <code class="ruby">    @lines_data          = QuoteResponse.bid_data_lines(@quote_responses)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="762">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="763">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="764">
          <span class="hits">1</span>
          
          <code class="ruby">  def submit_feedback</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="765">
          
          
          <code class="ruby">    # look for existing feedback</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="766">
          
          
          <code class="ruby">    @feedback_user = QuoteResponseFeedbackUser.find(params[:feedback_user_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="767">
          
          
          <code class="ruby">    @feedback = @feedback_user.quote_response_feedbacks.detect { |feedback| feedback.feedbackable_type == params[:feedback_type] }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="768">
          
          
          <code class="ruby">    if @feedback</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="769">
          
          
          <code class="ruby">      @feedback.update_attributes(:comment =&gt; params[:comment], :rating =&gt; params[:rating])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="770">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="771">
          
          
          <code class="ruby">      @feedback_user.quote_response_feedbacks &lt;&lt; QuoteResponseFeedback.new(:feedbackable_type =&gt; params[:feedback_type], :comment =&gt; params[:comment], :rating =&gt; params[:rating])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="772">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="773">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="774">
          
          
          <code class="ruby">    render :nothing =&gt; true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="775">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="776">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="777">
          <span class="hits">1</span>
          
          <code class="ruby">  def finish_feedback</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="778">
          
          
          <code class="ruby">    Notification.todos.where(:user_id =&gt; User.current_user.id, :key =&gt; &quot;request_rfq_feedback&quot;).each(&amp;:done!)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="779">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="780">
          
          
          <code class="ruby">    flash[:notice] = &quot;Thank you for providing feedback!&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="781">
          
          
          <code class="ruby">    redirect_to :controller =&gt; &quot;/user&quot;, :action =&gt; &quot;home&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="782">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="783">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="784">
          <span class="hits">1</span>
          
          <code class="ruby">  def compare_responses</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="785">
          
          
          <code class="ruby">    ids = params[:ids].split(',')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="786">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="787">
          
          
          <code class="ruby">    @quote_responses  = QuoteResponse.where(:id =&gt; ids)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="788">
          
          
          <code class="ruby">    @quote_suppliers = @quote_responses.map(&amp;:quote_supplier)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="789">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="790">
          
          
          <code class="ruby">    @attachment_data     = QuoteResponse.attachment_data_lines(@quote_responses)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="791">
          
          
          <code class="ruby">    @questionnaires_data = QuoteResponse.questionnaire_data_lines(@quote_responses)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="792">
          
          
          <code class="ruby">    @lines_data          = QuoteResponse.bid_data_lines(@quote_responses)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="793">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="794">
          
          
          <code class="ruby">    @feedback_users = @quote_responses.map{|qr| qr.feedback_users}.flatten.compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="795">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="796">
          
          
          <code class="ruby">    render :partial =&gt; &quot;compare_responses&quot;, :locals =&gt; {:feedback =&gt; :show}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="797">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="798">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="799">
          <span class="hits">1</span>
          
          <code class="ruby">  def show_active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="800">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="801">
          <span class="hits">1</span>
          
          <code class="ruby">    @quote_request = QuoteRequest.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="802">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="803">
          <span class="hits">1</span>
          
          <code class="ruby">    return unless check_suppliers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="804">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="805">
          
          
          <code class="ruby">    # resque checks states every 5min, we do it here in case they're actively viewing it</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="806">
          <span class="hits">1</span>
          
          <code class="ruby">    if @quote_request.finished? || @quote_request.test_complete? || @quote_request.complete?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="807">
          <span class="hits">1</span>
          
          <code class="ruby">      @quote_request.complete!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="808">
          
          
          <code class="ruby">    elsif @quote_request.bidding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="809">
          
          
          <code class="ruby">      @quote_request.start_auction! unless [:test_auction, :auction].include? @quote_request.state.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="810">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="811">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="812">
          
          
          <code class="ruby">    # order matters here, first few are more specific</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="813">
          <span class="hits">1</span>
          
          <code class="ruby">    @states = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="814">
          
          
          <code class="ruby">      :test_complete? =&gt; &quot;complete&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="815">
          
          
          <code class="ruby">      :complete? =&gt; &quot;complete&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="816">
          
          
          <code class="ruby">      :bidding? =&gt; &quot;bidding&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="817">
          
          
          <code class="ruby">      :prebidding? =&gt; &quot;prebidding&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="818">
          
          
          <code class="ruby">      :preprebidding? =&gt; &quot;prebidding&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="819">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="820">
          <span class="hits">2</span>
          
          <code class="ruby">    @state = @states.each { |method, name| break name if @quote_request.send(method) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="821">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="822">
          <span class="hits">1</span>
          
          <code class="ruby">    @sections_settings ||= sections_settings @quote_request.id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="823">
          <span class="hits">1</span>
          
          <code class="ruby">    @line_types = types</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="824">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="825">
          <span class="hits">1</span>
          
          <code class="ruby">    @event_name_title = @quote_request.description.blank? ? t('quotes_controller.request_for_sourcing_event') : @quote_request.description.truncate(25).to_s</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="826">
          <span class="hits">1</span>
          
          <code class="ruby">    @title = t(&quot;quotes_controller.request_for_quote_number&quot;, :event_description =&gt; @event_name_title, :num =&gt; @quote_request.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="827">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="828">
          <span class="hits">1</span>
          
          <code class="ruby">    @quote_attachments =  @quote_request.quote_request_attachments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="829">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="830">
          <span class="hits">1</span>
          
          <code class="ruby">    @title_modifier = case @state</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="831">
          
          
          <code class="ruby">    when &quot;prebidding&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="832">
          
          
          <code class="ruby">      if !@quote_request.competitive_bidding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="833">
          
          
          <code class="ruby">        &quot; &lt;span class='smaller'&gt;#{t('quotes_controller.in_active')}&lt;/span&gt; &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="834">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="835">
          
          
          <code class="ruby">        if @quote_request.preprebidding_period?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="836">
          
          
          <code class="ruby">          &quot; &lt;span class='smaller'&gt;#{t 'quotes_controller.in_preprebidding'}&lt;/span&gt; &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="837">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="838">
          
          
          <code class="ruby">          &quot; &lt;span class='smaller'&gt;#{t 'quotes_controller.prebid_in_progress'}&lt;/span&gt; &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="839">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="840">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="841">
          
          
          <code class="ruby">    when &quot;bidding&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="842">
          
          
          <code class="ruby">      &quot; &lt;span class='smaller'&gt;#{t 'quotes_controller.bidding_in_progress'}&lt;/span&gt; &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="843">
          
          
          <code class="ruby">    when &quot;complete&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="844">
          <span class="hits">1</span>
          
          <code class="ruby">      &quot; &lt;span class='smaller'&gt;#{t 'quotes_controller.in_completed'}&lt;/span&gt; &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="845">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="846">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="847">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="848">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="849">
          <span class="hits">1</span>
          
          <code class="ruby">  def edit_active</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="850">
          <span class="hits">7</span>
          
          <code class="ruby">    @quote_request = QuoteRequest.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="851">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="852">
          <span class="hits">7</span>
          
          <code class="ruby">    return unless check_suppliers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="853">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="854">
          <span class="hits">7</span>
          
          <code class="ruby">    if @quote_request.finished? || @quote_request.test_complete? || @quote_request.complete?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="855">
          
          
          <code class="ruby">      @quote_request.complete!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="856">
          
          
          <code class="ruby">    elsif @quote_request.bidding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="857">
          
          
          <code class="ruby">      @quote_request.start_auction! unless [:test_auction, :auction].include? @quote_request.state.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="858">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="859">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="860">
          <span class="hits">7</span>
          
          <code class="ruby">    @states = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="861">
          
          
          <code class="ruby">      :test_complete? =&gt; &quot;complete&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="862">
          
          
          <code class="ruby">      :complete? =&gt; &quot;complete&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="863">
          
          
          <code class="ruby">      :bidding? =&gt; &quot;bidding&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="864">
          
          
          <code class="ruby">      :prebidding? =&gt; &quot;prebidding&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="865">
          
          
          <code class="ruby">      :preprebidding? =&gt; &quot;prebidding&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="866">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="covered" data-hits="42" data-linenumber="867">
          <span class="hits">42</span>
          
          <code class="ruby">    @state = @states.each { |method, name| break name if @quote_request.send(method) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="868">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="869">
          <span class="hits">7</span>
          
          <code class="ruby">    @sections_settings ||= sections_settings @quote_request.id</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="870">
          <span class="hits">7</span>
          
          <code class="ruby">    @line_types = types</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="871">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="872">
          <span class="hits">7</span>
          
          <code class="ruby">    @event_type = (@quote_request.event_type || params[:type_id] || 'rfq').to_sym</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="873">
          <span class="hits">7</span>
          
          <code class="ruby">    @quote_attachments = @quote_request.quote_request_attachments</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="874">
          <span class="hits">7</span>
          
          <code class="ruby">    @quote_request.local_start_time ||= Time.zone.today</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="875">
          <span class="hits">7</span>
          
          <code class="ruby">    @event_name_title = @quote_request.description.blank? ? t('quotes_controller.request_for_sourcing_event') : @quote_request.description.truncate(25).to_s</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="876">
          <span class="hits">7</span>
          
          <code class="ruby">    @title = t(&quot;quotes_controller.request_for_quote_number&quot;, :event_description =&gt; @event_name_title, :num =&gt; @quote_request.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="877">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="878">
          <span class="hits">7</span>
          
          <code class="ruby">    @title_modifier = case @state</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="879">
          
          
          <code class="ruby">    when &quot;prebidding&quot;</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="880">
          <span class="hits">7</span>
          
          <code class="ruby">      if @quote_request.preprebidding_period?</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="881">
          <span class="hits">7</span>
          
          <code class="ruby">        &quot; &lt;span class='smaller'&gt;#{t 'defaults.edit'}&lt;/span&gt; &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="882">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="883">
          
          
          <code class="ruby">        &quot; &lt;span class='smaller'&gt;#{I18n.translate('defaults.prebid_edit')}&lt;/span&gt; &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="884">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="885">
          
          
          <code class="ruby">    when &quot;bidding&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="886">
          
          
          <code class="ruby">      &quot; &lt;span class='smaller'&gt;#{I18n.translate('defaults.bidding_edit')}&lt;/span&gt; &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="887">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="888">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="889">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="890">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="891">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="892">
          
          
          <code class="ruby">  # Determine whether timeline settings were changed</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="893">
          <span class="hits">1</span>
          
          <code class="ruby">  def timeline_changed</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="894">
          <span class="hits">22</span>
          
          <code class="ruby">    if @quote_request.prebidding?</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="895">
          <span class="hits">22</span>
          
          <code class="ruby">      params[:quote_request][:bidding_time] = DateTime.strptime(params[:quote_request][:bidding_time], &quot;%m/%d/%y %I:%M %p %z&quot;)</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="896">
          <span class="hits">22</span>
          
          <code class="ruby">      params[:quote_request][:end_time] = DateTime.strptime(params[:quote_request][:end_time], &quot;%m/%d/%y %I:%M %p %z&quot;)</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="897">
          <span class="hits">22</span>
          
          <code class="ruby">      if @quote_request.bidding_time != params[:quote_request][:bidding_time] || @quote_request.end_time != params[:quote_request][:end_time]</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="898">
          <span class="hits">21</span>
          
          <code class="ruby">        @quote_request.timeline_changed = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="899">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="900">
          <span class="hits">1</span>
          
          <code class="ruby">        @quote_request.timeline_changed = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="901">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="902">
          
          
          <code class="ruby">    elsif @quote_request.bidding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="903">
          
          
          <code class="ruby">      params[:quote_request][:end_time] = DateTime.strptime(params[:quote_request][:end_time], &quot;%m/%d/%y %I:%M %p %z&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="904">
          
          
          <code class="ruby">      @quote_request.timeline_changed = (@quote_request.end_time != params[:quote_request][:end_time]) ? true : nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="905">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="906">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="907">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="908">
          <span class="hits">1</span>
          
          <code class="ruby">  def delete_params_pairs _params, _restriction</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="909">
          <span class="hits">22</span>
          
          <code class="ruby">    if @quote_request.prebidding?</code>
        </li>
      
        <li class="covered" data-hits="88" data-linenumber="910">
          <span class="hits">88</span>
          
          <code class="ruby">      [:competitive_bidding, :event_type, :start_time ].each{ |key| _params[:quote_request].delete(key); _params[&quot;quote_request&quot;].delete(key.to_s) }</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="911">
          <span class="hits">22</span>
          
          <code class="ruby">      if _restriction</code>
        </li>
      
        <li class="covered" data-hits="36" data-linenumber="912">
          <span class="hits">36</span>
          
          <code class="ruby">        [ :description, :tag, :currency_id].each{ |key| _params[:quote_request].delete(key); _params[&quot;quote_request&quot;].delete(key.to_s) }</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="913">
          <span class="hits">27</span>
          
          <code class="ruby">        [ :quote_request_attachments, :edit_quote_request_attachments ].each{ |key| _params.delete(key); _params.delete(key.to_s) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="914">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="915">
          
          
          <code class="ruby">    elsif @quote_request.bidding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="916">
          
          
          <code class="ruby">      [:automatic_bid_extensions, :time_to_respond, :competitive_bidding,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="917">
          
          
          <code class="ruby">        :beaten_price_options, :suppliers_see, :incremental_bidding_options, :any_lot, :individual_line, :start_time, :bidding_time].each{ |key| _params[:quote_request].delete(key); _params[&quot;quote_request&quot;].delete(key.to_s) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="918">
          
          
          <code class="ruby">      if _restriction</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="919">
          
          
          <code class="ruby">        [ :description, :tag, :currency_id ].each{ |key| _params[:quote_request].delete(key); _params[&quot;quote_request&quot;].delete(key.to_s) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="920">
          
          
          <code class="ruby">        [ :quote_request_attachments, :edit_quote_request_attachments ].each{ |key| _params.delete(key); _params.delete(key.to_s) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="921">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="922">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="923">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="924">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="925">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_active</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="926">
          <span class="hits">22</span>
          
          <code class="ruby">    @quote_request = QuoteRequest.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="927">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="928">
          <span class="hits">22</span>
          
          <code class="ruby">    @states = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="929">
          
          
          <code class="ruby">      :test_complete? =&gt; &quot;complete&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="930">
          
          
          <code class="ruby">      :complete? =&gt; &quot;complete&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="931">
          
          
          <code class="ruby">      :bidding? =&gt; &quot;bidding&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="932">
          
          
          <code class="ruby">      :prebidding? =&gt; &quot;prebidding&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="933">
          
          
          <code class="ruby">      :preprebidding? =&gt; &quot;prebidding&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="934">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="covered" data-hits="110" data-linenumber="935">
          <span class="hits">110</span>
          
          <code class="ruby">    @state = @states.each { |method, name| break name if @quote_request.send(method) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="936">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="937">
          <span class="hits">22</span>
          
          <code class="ruby">    @quote_attachments = @quote_request.quote_request_attachments</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="938">
          <span class="hits">22</span>
          
          <code class="ruby">    timeline_changed</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="939">
          <span class="hits">22</span>
          
          <code class="ruby">    unless @quote_request.any_submitted_responses?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="940">
          
          
          <code class="ruby">      # no submitted responses</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="941">
          <span class="hits">13</span>
          
          <code class="ruby">      @sections_settings ||= sections_settings @quote_request.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="942">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="943">
          <span class="hits">13</span>
          
          <code class="ruby">      if @quote_request.prebidding?</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="944">
          <span class="hits">13</span>
          
          <code class="ruby">        @quote_request.automatic_bid_extensions = params[:quote_request][:automatic_bid_extensions] || false</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="945">
          <span class="hits">13</span>
          
          <code class="ruby">        params[:quote_request][:incremental_bidding_options] = @quote_request.process_incremental_bidding_options(params[:quote_request][:incremental_bidding_options])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="946">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="947">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="948">
          <span class="hits">13</span>
          
          <code class="ruby">      delete_params_pairs params, false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="949">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="950">
          <span class="hits">13</span>
          
          <code class="ruby">      if @quote_request.update_attributes params[:quote_request]</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="951">
          <span class="hits">8</span>
          
          <code class="ruby">        @quote_request.create_quote_request_attachments params[:quote_request_attachments]</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="952">
          <span class="hits">8</span>
          
          <code class="ruby">        @quote_request.update_quote_request_attachments params[:edit_quote_request_attachments]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="953">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="954">
          <span class="hits">8</span>
          
          <code class="ruby">        if @quote_request.prebidding?</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="955">
          <span class="hits">8</span>
          
          <code class="ruby">          flash[:notice] = t &quot;quotes_controller.changes_not_applied&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="956">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="957">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="958">
          <span class="hits">8</span>
          
          <code class="ruby">        redirect_to action: :show_active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="959">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="960">
          <span class="hits">5</span>
          
          <code class="ruby">        flash[:message] = @quote_request.errors.values.join(&quot;\n&quot;)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="961">
          <span class="hits">5</span>
          
          <code class="ruby">        @event_name_title = @quote_request.description.blank? ? t('quotes_controller.request_for_sourcing_event') : @quote_request.description.truncate(25).to_s</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="962">
          <span class="hits">5</span>
          
          <code class="ruby">        @title = t(&quot;quotes_controller.request_for_quote_number&quot;, :event_description =&gt; @event_name_title, :num =&gt; @quote_request.id)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="963">
          <span class="hits">5</span>
          
          <code class="ruby">        @title_modifier = &quot; &lt;span class='smaller'&gt;#{I18n.translate('defaults.prebid_edit')}&lt;/span&gt; &quot;</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="964">
          <span class="hits">5</span>
          
          <code class="ruby">        render action: :edit_active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="965">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="966">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="967">
          
          
          <code class="ruby">      # there are submitted responses</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="968">
          <span class="hits">9</span>
          
          <code class="ruby">      @sections_settings ||= sections_settings @quote_request.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="969">
          
          
          <code class="ruby">      </code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="970">
          <span class="hits">9</span>
          
          <code class="ruby">      if @quote_request.prebidding?</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="971">
          <span class="hits">9</span>
          
          <code class="ruby">        @quote_request.automatic_bid_extensions = params[:quote_request][:automatic_bid_extensions] || false</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="972">
          <span class="hits">9</span>
          
          <code class="ruby">        params[:quote_request][:incremental_bidding_options] = @quote_request.process_incremental_bidding_options(params[:quote_request][:incremental_bidding_options])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="973">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="974">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="975">
          <span class="hits">9</span>
          
          <code class="ruby">      delete_params_pairs params, true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="976">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="977">
          <span class="hits">9</span>
          
          <code class="ruby">      if @quote_request.update_attributes params[:quote_request]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="978">
          <span class="hits">3</span>
          
          <code class="ruby">        if @quote_request.prebidding?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="979">
          <span class="hits">3</span>
          
          <code class="ruby">          flash[:notice] = &quot;Updated&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="980">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="981">
          
          
          <code class="ruby">          flash[:notice] = t &quot;quotes_controller.changes_not_applied&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="982">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="983">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="984">
          <span class="hits">3</span>
          
          <code class="ruby">        redirect_to action: :show_active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="985">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="986">
          <span class="hits">6</span>
          
          <code class="ruby">        flash[:message] = @quote_request.errors.values.join(&quot;\n&quot;)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="987">
          <span class="hits">6</span>
          
          <code class="ruby">        @line_types = types</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="988">
          <span class="hits">6</span>
          
          <code class="ruby">        @event_name_title = @quote_request.description.blank? ? t('quotes_controller.request_for_sourcing_event') : @quote_request.description.truncate(25).to_s</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="989">
          <span class="hits">6</span>
          
          <code class="ruby">        @title = t(&quot;quotes_controller.request_for_quote_number&quot;, :event_description =&gt; @event_name_title, :num =&gt; @quote_request.id)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="990">
          <span class="hits">6</span>
          
          <code class="ruby">        @title_modifier = &quot; &lt;span class='smaller'&gt;#{I18n.translate('defaults.prebid_edit')}&lt;/span&gt; &quot;</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="991">
          <span class="hits">6</span>
          
          <code class="ruby">        render action: :edit_active</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="992">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="993">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="994">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="995">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="996">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="997">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="998">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="999">
          <span class="hits">1</span>
          
          <code class="ruby">  def populate_logo</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1000">
          
          
          <code class="ruby">    logo = LogoAttachmentFile.find_by_id(Setup.lookup('company logo'))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1001">
          
          
          <code class="ruby">    (@quote_request.buyers_logo = logo.file) &amp;&amp; @quote_request.save unless (logo.nil? || !logo.file?)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1002">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1003">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1004">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize_graph_variables</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1005">
          
          
          <code class="ruby">    @opportunities_for_dashboard = Opportunity.opportunities_for_dashboard</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1006">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1007">
          
          
          <code class="ruby">    @top_commodities  = QuoteRequest.top_commodities</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1008">
          
          
          <code class="ruby">    @total_savings    = QuoteRequest.total_savings.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1009">
          
          
          <code class="ruby">    @alerts           = QuoteRequest.alerts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1010">
          
          
          <code class="ruby">    @my_savings       = QuoteRequest.my_savings.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1011">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1012">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1013">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1014">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1015">
          
          
          <code class="ruby">  #  redirect to prod/test view</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1016">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1017">
          <span class="hits">1</span>
          
          <code class="ruby">  def redirect_show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1018">
          
          
          <code class="ruby">    if @quote_request.finished? || @quote_request.complete? || @quote_request.test_complete?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1019">
          
          
          <code class="ruby">      redirect_to quotes_complete_request_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1020">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1021">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1022">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1023">
          
          
          <code class="ruby">    return unless check_suppliers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1024">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1025">
          
          
          <code class="ruby">    if @quote_request.prebidding_period?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1026">
          
          
          <code class="ruby">      redirect_to quotes_prebidding_request_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1027">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1028">
          
          
          <code class="ruby">    elsif @quote_request.bidding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1029">
          
          
          <code class="ruby">      redirect_to quotes_bidding_request_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1030">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1031">
          
          
          <code class="ruby">    elsif @quote_request.preprebidding_period?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1032">
          
          
          <code class="ruby">      redirect_to quotes_prebidding_request_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1033">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1034">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1035">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1036">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1037">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1038">
          
          
          <code class="ruby">  #  Preventing empty page appearance</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1039">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1040">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_event_type_and_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1041">
          
          
          <code class="ruby">    if params[:event_id].nil? &amp;&amp; params[:type_id].nil? &amp;&amp; params[:event_name_with_id].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1042">
          
          
          <code class="ruby">      redirect_to quotes_requests_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1043">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1044">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1045">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1046">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1047">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1048">
          
          
          <code class="ruby">  #  Getting state of sections for &quot;Event Request&quot; form</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1049">
          
          
          <code class="ruby">  #    @return &lt;Hash&gt; - key-value table with settings for current User</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1050">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1051">
          <span class="hits">1</span>
          
          <code class="ruby">  def sections_settings event_id</code>
        </li>
      
        <li class="covered" data-hits="77" data-linenumber="1052">
          <span class="hits">77</span>
          
          <code class="ruby">    a = Hash[</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1053">
          
          
          <code class="ruby">      UserAttribute.where(['`key` like &quot;event_request_section_?_%&quot; and user_id = ?', event_id, User.current_user.id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1054">
          
          
          <code class="ruby">                   .map { |s| [s.key.gsub(/^event_request_section_(\d{1,})_/, '').to_sym, s.value] } ]</code>
        </li>
      
        <li class="covered" data-hits="77" data-linenumber="1055">
          <span class="hits">77</span>
          
          <code class="ruby">    logger.info(&quot;SECTION_SETTINGS: #{a}&quot;)</code>
        </li>
      
        <li class="covered" data-hits="77" data-linenumber="1056">
          <span class="hits">77</span>
          
          <code class="ruby">    a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1057">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1058">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1059">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_view_permission</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1060">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1061">
          
          
          <code class="ruby">    unless @quote_request.has_access_to_view_event?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1062">
          
          
          <code class="ruby">      flash[:warning] = t &quot;quotes_controller.permission_denied&quot;, quote_request: @quote_request.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1063">
          
          
          <code class="ruby">      redirect_to quotes_requests_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1064">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1065">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1066">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1067">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_edit_permission</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1068">
          
          
          <code class="ruby">    @quote_request = QuoteRequest.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1069">
          
          
          <code class="ruby">    unless @quote_request.has_access_to_edit_event?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1070">
          
          
          <code class="ruby">      flash[:warning] = t &quot;quotes_controller.permission_edit_denied&quot;, quote_request: @quote_request.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1071">
          
          
          <code class="ruby">      redirect_to quotes_requests_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1072">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1073">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1074">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1075">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_suppliers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1076">
          
          
          <code class="ruby">    if @quote_request.quote_suppliers.all.count == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1077">
          
          
          <code class="ruby">      if @quote_request.prebidding_period?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1078">
          
          
          <code class="ruby">        redirect_to edit_quotes_prebidding_response_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1079">
          
          
          <code class="ruby">      elsif @quote_request.bidding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1080">
          
          
          <code class="ruby">        redirect_to edit_quotes_bidding_response_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1081">
          
          
          <code class="ruby">      elsif @quote_request.preprebidding_period?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1082">
          
          
          <code class="ruby">        redirect_to edit_quotes_preprebidding_response_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1083">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1084">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1085">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1086">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1087">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1088">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1089">
          <span class="hits">1</span>
          
          <code class="ruby">  def check_suppliers_message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1090">
          
          
          <code class="ruby">    flash[:message] = I18n.translate(&quot;quotes_controller.suppliers_minimum&quot;) if @quote_request.quote_suppliers.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1091">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1092">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="bf81a295d985af7788f6bfbdf3c528e71dafa9bf">
  <div class="header">
    <h3>app/controllers/quotes/requests_lines_controller.rb</h3>
    <h4><span class="red">24.44 %</span> covered</h4>
    <div>
      <b>45</b> relevant lines. 
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>34</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># -*- coding: utf-8 -*-</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class Quotes::RequestsLinesController &lt; Quotes::BaseController</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  layout false</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  verify :xhr =&gt; true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  #  Creating new Line's instance</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    request = ::QuoteRequest.find(params[:quote_request_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    data = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      :lot_id             =&gt; params[:lot_id],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      :type               =&gt; params[:item_type],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      :description        =&gt; &quot;Unnamed #{params[:item_type]}&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      :price_amount       =&gt; 10,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      :price_currency_id  =&gt; 1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      :uom_id             =&gt; 1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      :weight             =&gt; request.lines.size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    new_item_id = request.lines.create(data).id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    # dirty hack</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    line = ::QuoteRequestLine.find(new_item_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    line.update_attribute(:type, params[:item_type])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    line.update_attribute(:quantity, 1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    render :text =&gt; new_item_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  #  Updating Line instance</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    ::QuoteRequestLine.find(params[:id]).update_attributes({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      :description        =&gt; params[:name],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      :quantity           =&gt; params[:quantity],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      :price_amount       =&gt; params[:base_price],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      :uom_id             =&gt; params[:uom_id],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      :price_currency_id  =&gt; params[:currency_id],</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      :form_id            =&gt; (Form.where(:name      =&gt; params[:form_name]).first.id rescue nil),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">      :commodity_id       =&gt; (Commodity.where(:name =&gt; params[:commodity_name]).first.id rescue nil),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      :ship_to_address_id =&gt; params[:address_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    # dirty hack</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    line = ::QuoteRequestLine.find params[:id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">    line.update_attribute(:quantity, params[:quantity].to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    render :json =&gt; params</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  #  Generating and outputting JSON for matched forms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  #    @return &lt;String&gt; - mathed form's names as JSON</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  def form_autocomplete</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">    name_conditions = ['lower(name) like ?', &quot;%#{params[:term]}%&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">    matched_forms = Form.where(name_conditions).where(:form_type =&gt; 'rfq').map do |form|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      { label: form.name, value: form.name }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">    render :json =&gt; matched_forms.compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  #  Generating and outputting JSON for matched commodities</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  #    @return &lt;String&gt; - mathed commodity's names as JSON</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">  def commodity_autocomplete</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">    name_conditions = ['lower(name) like ?', &quot;%#{params[:term]}%&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">    matched_commodities = Commodity.where(name_conditions).where(:active =&gt; true).map do |commodity|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">      { label: commodity.name, value: commodity.name }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">    render :json =&gt; matched_commodities.compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">  #  Generating and outputting JSON for matched item names</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">  #    @return &lt;String&gt; - mathed item's names as JSON</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">  def name_autocomplete</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">    name_conditions = ['lower(name) like ?', &quot;%#{params[:term]}%&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">    matched_items = Item.where(name_conditions).where(:active =&gt; true).map do |item|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">      { label: item.name, value: item.name }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">    render :json =&gt; matched_items.compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">  #  Rendering attachment form for each item</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">  def attachment_form</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">    @object = QuoteRequestLine.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">    @linked_to = &quot;quote_request_item_#{params[:id]}&quot;.to_sym</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">  #  Moving selected items</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">  def move</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">    QuoteRequestLine.where(['id in (?)', params[:selected].map(&amp;:to_i)]).each do |item|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">      item.update_attribute(:lot_id, params[:target].to_i)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">    render :nothing =&gt; true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  #  Saving drag and drop reordering results</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">  def reorder</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">    params[:data][:items].each do |item_id, weight|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">      QuoteRequestLine.find(item_id.to_i).update_attribute(:weight, weight.to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">    end unless params[:data][:items].blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">    QuoteRequestLine.where(:id =&gt; params[:data][:moved][:id]).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">                    .update_attribute(:lot_id, params[:data][:moved][:lot_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">    render :nothing =&gt; true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="7d08401f07bae00bfe8930faeac78cd9f11cc6e1">
  <div class="header">
    <h3>app/controllers/quotes/requests_lots_controller.rb</h3>
    <h4><span class="red">32.53 %</span> covered</h4>
    <div>
      <b>83</b> relevant lines. 
      <span class="green"><b>27</b> lines covered</span> and
      <span class="red"><b>56</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># -*- coding: utf-8 -*-</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class Quotes::RequestsLotsController &lt; Quotes::BaseController</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # TODO: add xhr? checking</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  layout false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  @@class_names = { :lot =&gt; &quot;QuoteRequestsLot&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">                    :line =&gt; &quot;QuoteRequestLine&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  @@lot_attributes = Proc.new do |lot|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      :id                =&gt; lot.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      :name              =&gt; lot.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      :type              =&gt; &quot;modifiable&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      :expected_quantity =&gt; lot.expected_quantity,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      :base_price_note   =&gt; lot.base_price_note,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      :quantity_note     =&gt; lot.quantity_note,</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="19">
          <span class="hits">6</span>
          
          <code class="ruby">      :currency          =&gt; (Currency.find(lot.lines.first.price_currency_id).code rescue nil),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      :is_new            =&gt; false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      :is_follow         =&gt; lot.followed_from?</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="22">
          <span class="hits">6</span>
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  @@line_attributes = Proc.new do |line|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      :id             =&gt; line.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      :name           =&gt; line.description,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      :base_price     =&gt; line.price_amount,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      :quantity       =&gt; line.quantity,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      :item_type      =&gt; line.type == &quot;QuoteRequestQuantityLine&quot; ? &quot;item&quot; : &quot;service&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      :uom_id         =&gt; line.uom_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      :currency_id    =&gt; line.price_currency_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      :currency       =&gt; Currency.find(line.price_currency_id).code,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      :form_name      =&gt; (Form.find(line.form_id).name rescue  &quot;&quot;),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      :commodity_name =&gt; (Commodity.find(line.commodity_id).name rescue &quot;&quot;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      :is_new         =&gt; false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      :address_id     =&gt; line.ship_to_address_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      :lot_id         =&gt; line.lot_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      :is_follow      =&gt; line.followed_from?,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      # Lisp-style in Ruby, awesome yeah?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      :address_name   =&gt; (Address.find(line.ship_to_address_id).attributes.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">                            (%w(name street1 street2 city state postal_code).include?(k) ?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">                              (not(v.blank?) ? v : next) : next)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">                          end.compact.join(&quot;&lt;br /&gt;&quot;) rescue &quot;&quot; )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  #  Initializing Lot's</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="55">
          <span class="hits">6</span>
          
          <code class="ruby">    lots = ::QuoteRequest.find(params[:quote_request_id]).lots.order(:weight).map(&amp;@@lot_attributes)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    render :json =&gt; lots &lt;&lt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      :id =&gt; 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      :name =&gt; &quot;%number_of_lines% items (not in lots)&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      :type =&gt; &quot;unmodifiable&quot;</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="60">
          <span class="hits">6</span>
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  #  Creating new Lot's instance</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    render :text =&gt; ::QuoteRequest</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">                      .find(params[:quote_request_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">                      .lots.create({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">                        :name             =&gt; &quot;&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">                        :base_price_note  =&gt; &quot;&quot;,</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="73">
          <span class="hits">4</span>
          
          <code class="ruby">                        :quantity_note    =&gt; &quot;&quot;}).id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  #  Updating current Lot</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="81">
          <span class="hits">3</span>
          
          <code class="ruby">    lot = ::QuoteRequestsLot.find(params[&quot;id&quot;].to_i)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="82">
          <span class="hits">2</span>
          
          <code class="ruby">    lot.update_attributes({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">      :name              =&gt; params[:name],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      :expected_quantity =&gt; params[:expected_quantity],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">      :quantity_note     =&gt; params[:quantity_note],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">      :base_price_note   =&gt; params[:base_price_note]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    })</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="88">
          <span class="hits">2</span>
          
          <code class="ruby">    render :json =&gt; lot</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  #  List of Lot's lines</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">  def lines</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">    render :json =&gt; ::QuoteRequest.find(params[:quote_request_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">                                  .lines.where(:lot_id =&gt; params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">                                  .order(:weight).map(&amp;@@line_attributes)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">  #  Removing selected Lines and Lots</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">  def destroy_selected</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">    %w(lot line).each do |key|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">      unless params[:selected][key.dup &lt;&lt; &quot;s&quot;].blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">        @@class_names[key.to_sym].constantize.where(['id in (?)', params[:selected][key.dup &lt;&lt; &quot;s&quot;].map(&amp;:to_i)]).destroy_all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">    # changing parents Lot for lines in current Event</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">    QuoteRequestLine.where(:quote_request_id =&gt; params[:quote_request_id]).each do |line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">      unless QuoteRequestsLot.exists?(line.lot_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">        line.update_attribute(:lot_id, 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">    render :text =&gt; &quot;ok&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">  #  Saving drag and drop reordering results</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="126">
          <span class="hits">1</span>
          
          <code class="ruby">  def reorder</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">    params[:data][:lots].each do |lot_id, weight|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">      QuoteRequestsLot.find(lot_id).update_attribute(:weight, weight) unless lot_id.to_i.zero?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">    end unless params[:data][:lots].blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">    render :text =&gt; &quot;ok&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">  #  Duplicating selected Lines and Lots</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="138">
          <span class="hits">1</span>
          
          <code class="ruby">  def duplicate</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">    duplicated = { :lines=&gt; {}, :lots =&gt; {} }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">    %w(lot line).each do |key|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">      unless params[key.dup &lt;&lt; &quot;s&quot;].blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">        params[key.dup &lt;&lt; &quot;s&quot;].each do |index, instance|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">          copy = @@class_names[key.to_sym].constantize.find(instance[:id]).clone</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">          if key == 'lot'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">            copy.name &lt;&lt; &quot; - copy&quot; unless copy.name =~ /-\scopy$/</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">            copy.description &lt;&lt; &quot; - copy&quot; unless copy.description =~ /-\scopy$/</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">          duplicated[(key.dup &lt;&lt; &quot;s&quot;).to_sym][instance[:id].to_i] = copy.id if copy.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">          # increasing weight and cloning attachments for item</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">          if key == 'line'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">            copy.update_attribute(:weight, ::QuoteRequest.find(params[:quote_request_id]).lines.size)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">            LineAttachments.clone(params[:quote_request_id], params[:quote_request_id], [instance[:id]], copy.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">    # updating parents for Lines</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">    duplicated[:lines].values.each do |new_line_id|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">      line = QuoteRequestLine.find(new_line_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">      if duplicated[:lots].keys.include?(line.lot_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">        line.update_attribute(:lot_id, duplicated[:lots][line.dup.lot_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">    render :json =&gt; duplicated</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">  #  Rendering importing pop-up</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="176">
          <span class="hits">1</span>
          
          <code class="ruby">  def import</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="177">
          <span class="hits">2</span>
          
          <code class="ruby">    @template = params[:template] == 'true'</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="178">
          <span class="hits">2</span>
          
          <code class="ruby">    @quote_request = QuoteRequest.find params[:quote_request]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="179">
          <span class="hits">2</span>
          
          <code class="ruby">    render :partial =&gt; 'import'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">  #  Processing import of items and lots from other event</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="186">
          <span class="hits">1</span>
          
          <code class="ruby">  def import_process</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">    cloned_event = QuoteRequest.find(params[:event_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">    duplicated = { :lots =&gt; [], :lines =&gt; [] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">    # copying lots</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">    new_lot_names = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">    cloned_event.lots.each do |lot|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">      cloned_lot = lot.clone</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">      cloned_lot.update_attribute(:quote_request_id, params[:quote_request_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">      new_lot_names[lot.id] = cloned_lot.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">      duplicated[:lots] &lt;&lt; @@lot_attributes.call(cloned_lot)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">    # copying lines</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">    update_weight_ids = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">    cloned_event.lines.each_with_index do |line, index|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">      cloned_line = line.clone</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">      # updating parenting information</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">      cloned_line.update_attribute(:quote_request_id, params[:quote_request_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">      cloned_line.update_attribute(:lot_id, new_lot_names[cloned_line.lot_id]) if new_lot_names.keys.include?(cloned_line.lot_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">      update_weight_ids &lt;&lt; cloned_line.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">      duplicated[:lines] &lt;&lt; @@line_attributes.call(cloned_line)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="213">
          
          
          <code class="ruby">    LineAttachments.clone params[:quote_request_id], params[:event_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">    # updating weight for each duplicated item</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">    update_weight_ids.each_with_index do |line_id, index|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">      ::QuoteRequestLine.find(line_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">          .update_attribute(:weight,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">            (index + ::QuoteRequestLine.where(:quote_request_id =&gt; params[:quote_request_id]).all.size))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">    render :json =&gt; duplicated</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">  #  Blank method returning nothing</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="229">
          <span class="hits">1</span>
          
          <code class="ruby">  def import_cap</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">    render :nothing =&gt; true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">  #  This is dummy example of Faye usage</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="237">
          <span class="hits">1</span>
          
          <code class="ruby">  def faye_example</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">    render :layout =&gt; &quot;application&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f43a632a658418a6764cad0efbdacd13565ddaeb">
  <div class="header">
    <h3>app/controllers/quotes/responses_lines_controller.rb</h3>
    <h4><span class="red">16.67 %</span> covered</h4>
    <div>
      <b>42</b> relevant lines. 
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>35</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># -*- coding: utf-8 -*-</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class Quotes::ResponsesLinesController &lt; Quotes::BaseController</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  skip_before_filter :authorize_action, :only =&gt; [:update, :show]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # TODO: check ?!!!!!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # before_filter :check_supplier, :only =&gt; [:index, :lines]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  @@types = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    ['Qty', 'QuoteResponseQuantityLine'], </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    ['Amt', 'QuoteResponseAmountLine']]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_reader :types</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  #  Show Line instance</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">    line = ::QuoteResponseLine.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    render :json =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      :id                 =&gt; line.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      :request_line_id    =&gt; line.quote_request_line_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      :name               =&gt; line.quote_request_line.description,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      :supplier_price     =&gt; line.price_amount || '',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      :quantity           =&gt; line.quantity,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      :item_type          =&gt; line.icon,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      :uom                =&gt; (line.quote_request_line.uom_id ? Uom.find(line.quote_request_line.uom_id).name : &quot;Each&quot;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      :currency_id        =&gt; line.quote_request_line.price_currency_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      :currency           =&gt; Currency.find(line.quote_request_line.price_currency_id).code,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      :commodity_name     =&gt; (Commodity.find(line.quote_request_line.commodity_id).name rescue &quot;&quot;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      :is_new             =&gt; false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      :address_id         =&gt; line.quote_request_line.ship_to_address_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      :lot_id             =&gt; line.quote_request_line.lot_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      :supplier_item_name =&gt; line.supplier_item_name || '',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      :item_part_number   =&gt; line.item_part_number   || '',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      :item_description   =&gt; line.item_description   || '',</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      :edit_mode          =&gt; (line.quote_response.working? ? true : false),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      :attachements       =&gt; (links_to_attachments(line) rescue ''),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      :image_url          =&gt; line.try(:image).try(:url),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      :form_name          =&gt; (FormResponse.find(line.form_response_id).form.name rescue  &quot;&quot;),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">      :form =&gt; (line.form_response_id.nil? ? '' : line.form_response_id),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      # Lisp-style in Ruby, awesome yeah?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      :address_name   =&gt; (Address.find(line.quote_request_line.ship_to_address_id).attributes.map do |k, v| </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">                            (%w(name street1 street2 city state postal_code).include?(k) ? </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">                              (not(v.blank?) ? v : next) : next) </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">                          end.compact.join(&quot;&lt;br /&gt;&quot;) rescue &quot;&quot; )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  #  Updating Line instance</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    response_line = ::QuoteResponseLine.find params[:id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">    response_line.skip_validation = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">    response_line.update_attributes!({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      :supplier_item_name =&gt; params[:supplier_item_name],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      :item_part_number   =&gt; params[:item_part_number],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      :item_description   =&gt; params[:item_description],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      :image              =&gt; params[:image]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    })</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">    response_line.update_attributes!({:price_amount =&gt; params[:supplier_price]}) unless params[:is_bidding]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    Quotes::BiddingResponsesGraphController.new.bids(params[:quote_request_id]) unless params[:quote_request_id].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    render :json =&gt; params</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">  #  Generate collection for attachements</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">  def links_to_attachments(line)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    collection = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">    line.quote_request_line.attachments.for_supplier.each do |attachment|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">      options = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">      content = case attachment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">        when AttachmentFile</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">          options[:target] = &quot;_blank&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">          options['data-url'] = &quot;#{SimpleConfig.for(:application).app_url}attachment/attachment_file/file/#{attachment.id}/#{attachment.filename_for_url}?supplier_view_key=#{@@supplier_key}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">          attachment.file_file_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">        when AttachmentUrl</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">          options[:title] = attachment.url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">          options[:target] = &quot;_blank&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">          options['data-url'] = URI.escape(attachment.url)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">          unless options['data-url'] =~ /^http:\/\/|^https:\/\//</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">            options['data-url'] = &quot;http://&quot; + options['data-url']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">          attachment.url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">        when AttachmentText</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">          attachment.text_to_html</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">      options[:class] = [options[:class], attachment.class.name.underscore.dasherize, 'attachment-list-item'].collect.to_a.join(' ')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">      options[:content] = content</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">      collection &lt;&lt; options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">    collection</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="3d71351d3207499075fd8a9e455bd551059dbb22">
  <div class="header">
    <h3>app/controllers/quotes/responses_lots_controller.rb</h3>
    <h4><span class="red">20.0 %</span> covered</h4>
    <div>
      <b>50</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>40</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># -*- coding: utf-8 -*-</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class Quotes::ResponsesLotsController &lt; Quotes::BaseController</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  skip_before_filter :authorize_action, :only =&gt; [:index, :lines, :update]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # TODO: check ?!!!!!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # before_filter :check_supplier, :only =&gt; [:index, :lines]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # TODO: add xhr? checking</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  layout false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  @@class_names = { :lot =&gt; &quot;QuoteRequestsLot&quot;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">                    :line =&gt; &quot;QuoteRequestLine&quot; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  @@lot_attributes = Proc.new do |lot|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    { </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">      :id                =&gt; lot.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      :name              =&gt; lot.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      :type              =&gt; &quot;modifiable&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      :expected_quantity =&gt; lot.expected_quantity,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      :base_price_note   =&gt; lot.base_price_note,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      :quantity_note     =&gt; lot.quantity_note,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      :currency          =&gt; (Currency.find(lot.lines.first.price_currency_id).code rescue @@def_currency),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      :is_new            =&gt; false </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  @@line_attributes = Proc.new do |line|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    { </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      :id                 =&gt; line.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      :request_line_id    =&gt; line.quote_request_line_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      :name               =&gt; line.quote_request_line.description,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      :supplier_price     =&gt; line.price_amount || '',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      :quantity           =&gt; line.quantity,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      :item_type          =&gt; line.icon,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      :uom                =&gt; (line.quote_request_line.uom_id ? Uom.find(line.quote_request_line.uom_id).name : &quot;Each&quot;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      :currency_id        =&gt; line.quote_request_line.price_currency_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      :currency           =&gt; Currency.find(line.quote_request_line.price_currency_id).code,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      :commodity_name     =&gt; (Commodity.find(line.quote_request_line.commodity_id).name rescue &quot;&quot;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      :is_new             =&gt; false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      :address_id         =&gt; line.quote_request_line.ship_to_address_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      :lot_id             =&gt; line.quote_request_line.lot_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      :supplier_item_name =&gt; line.supplier_item_name || '',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      :item_part_number   =&gt; line.item_part_number   || '',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      :item_description   =&gt; line.item_description   || '',</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">      :edit_mode          =&gt; (line.quote_response.working? ? true : false),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      :attachements       =&gt; (links_to_attachments(line) rescue ''),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      :image_url          =&gt; line.try(:image).try(:url),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      :form_name          =&gt; (FormResponse.find(line.form_response_id).form.name rescue  &quot;&quot;),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      :form =&gt; (line.form_response_id.nil? ? '' : line.form_response_id),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      # Lisp-style in Ruby, awesome yeah?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      :address_name   =&gt; (Address.find(line.quote_request_line.ship_to_address_id).attributes.map do |k, v| </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">                            (%w(name street1 street2 city state postal_code).include?(k) ? </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">                              (not(v.blank?) ? v : next) : next) </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">                          end.compact.join(&quot;&lt;br /&gt;&quot;) rescue &quot;&quot; ) </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  #  Initializing Lot's</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">    quote_request = ::QuoteRequest.find(params[:quote_request_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">    @@def_currency = Currency.find(quote_request.currency_id).code</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">    lots = quote_request.lots.order(:weight).map(&amp;@@lot_attributes)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">    render :json =&gt; lots &lt;&lt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      :id =&gt; 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      :currency =&gt; @@def_currency,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      :name =&gt; &quot;%number_of_lines% lines (not in lots)&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      :type =&gt; &quot;unmodifiable&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">    params[:_json].each do |line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">      ::QuoteResponseLine.find(line[:id]).update_attributes!({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">        :price_amount =&gt; line[:supplier_price]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    render :json =&gt; params</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">  #  List of Lot's lines</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">  def lines</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">    quote_response = ::QuoteResponse.find(params[:quote_response_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">    @@supplier_key = quote_response.quote_request.supplier_view_key</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    render :json =&gt; quote_response.lines.where(:lot_id =&gt; params[:id]).order(:weight).map(&amp;@@line_attributes)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">  #  Generate collection for attachements</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.links_to_attachments(line)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">    collection = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">    line.quote_request_line.attachments.for_supplier.each do |attachment|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">      options = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">      content = case attachment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">        when AttachmentFile</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">          options[:target] = &quot;_blank&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">          options['data-url'] = &quot;#{SimpleConfig.for(:application).app_url}attachment/attachment_file/file/#{attachment.id}/#{attachment.filename_for_url}?supplier_view_key=#{@@supplier_key}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">          attachment.file_file_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">        when AttachmentUrl</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">          options[:title] = attachment.url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">          options[:target] = &quot;_blank&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">          options['data-url'] = URI.escape(attachment.url)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">          unless options['data-url'] =~ /^http:\/\/|^https:\/\//</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">            options['data-url'] = &quot;http://&quot; + options['data-url']</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">          attachment.url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">        when AttachmentText</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">          attachment.text_to_html</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">      options[:class] = [options[:class], attachment.class.name.underscore.dasherize, 'attachment-list-item'].collect.to_a.join(' ')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">      options[:content] = content</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">      collection &lt;&lt; options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">    collection</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="42e3046b2b19609b71ea48d75e928315f2773ac2">
  <div class="header">
    <h3>app/controllers/quotes/supplier_items_controller.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>6</b> relevant lines. 
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Quotes::SupplierItemsController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="3">
          <span class="hits">4</span>
          
          <code class="ruby">    @quote_response = QuoteResponse.find(params[:response_id])</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="4">
          <span class="hits">4</span>
          
          <code class="ruby">    @quote_response.create_supplier_items</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="6">
          <span class="hits">4</span>
          
          <code class="ruby">    flash[:notice] = &quot;Catalog Items created&quot;</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="7">
          <span class="hits">4</span>
          
          <code class="ruby">    redirect_to  edit_quotes_internal_response_url(@quote_response.quote_supplier.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="3f2a758245a954e8939eeb958a05ccb88d260bd8">
  <div class="header">
    <h3>app/controllers/quotes/supplier_messages_controller.rb</h3>
    <h4><span class="red">21.43 %</span> covered</h4>
    <div>
      <b>28</b> relevant lines. 
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>22</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Quotes::SupplierMessagesController &lt; Quotes::BaseController</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  skip_before_filter :authorize_action, :only =&gt; [:index, :create]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # TODO: auth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # before_filter :auth_supplier, :only =&gt; [:index, :create, :new]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    quote_supplier = QuoteSupplier.find_by_quote_supplier_key params[:request_id][40..80] # TODO: fix this after fixing external_responses url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    quote_request = quote_supplier.quote_request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    render json: { </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">                    messages:  quote_request.quote_messages.all_messages_for_supplier(quote_supplier.id).map{ | message | render_msg_json(message) }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">                 }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    quote_supplier = QuoteSupplier.find_by_quote_supplier_key params[:request_id][40..80] # TODO: fix this after fixing external_responses url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    quote_request = quote_supplier.quote_request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    if quote_request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      msg_body = QuoteMessageBody.new(body: params[:body])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      message = SupplierMessage.new(  quote_request: quote_request,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">                                      quote_requests_user: quote_request.business_partners.creator.first,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">                                      quote_supplier: quote_supplier, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">                                      quote_message_body: msg_body </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">                                   )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      if message.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">        PushMessenger.push &quot;/quotes/messages/#{quote_request.id}&quot;, render_msg_json(message)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        PushMessenger.push &quot;/quotes/messages/#{params[:request_id]}&quot;, render_msg_json(message) # TODO: fix this after fixing external_responses url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">        </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">        # Deliver mail to creator and owners</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">        to_buyer = quote_request.business_partners.creator.first.user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        quote_request.business_partners.select { |u| %w(creator owner).include? u.attitude }.each do |quote_user|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">          MessageBoardMailer.new_supplier_message quote_supplier, quote_user.user, quote_request,  message.quote_message_body.formatted_body</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      render text: &quot;true&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    render text: &quot;false&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">    def render_msg_json message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">        msg_id: message.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">        body: message.quote_message_body.body,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">        type: message.type,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">        buyer: message.quote_requests_user.user.name, </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">        supplier_name: (message.quote_supplier.name rescue ''),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">        supplier_logo: (message.quote_supplier.try(:logo).try(:url) rescue ''),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">        supplier_id: message.quote_supplier.id,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">        time: (message.created_at || Time.now).strftime(&quot;%m/%d/%y, %I:%M%p&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="be16c9293a588f85ed59e1f49c1e67ac4ecc6b6c">
  <div class="header">
    <h3>app/controllers/quotes/suppliers_controller.rb</h3>
    <h4><span class="red">48.28 %</span> covered</h4>
    <div>
      <b>58</b> relevant lines. 
      <span class="green"><b>28</b> lines covered</span> and
      <span class="red"><b>30</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># -*- coding: utf-8 -*-</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class Quotes::SuppliersController &lt; Quotes::BaseController</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  skip_before_filter :authorize_action, :only =&gt; [:view]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  verify :xhr =&gt; true, :method =&gt; :post, :only =&gt; [:add_quote_supplier]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  verify :method =&gt; :get, :only =&gt; [:activate, :view]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  verify :method =&gt; :post, :only =&gt; [:create]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def invited</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    if quote_supplier = QuoteSupplier.find_by_id(params[:value].to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      render :update do |page|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">        page &lt;&lt; &quot;$('.quote_supplier_email_wrapper :input').val('#{quote_supplier.email}');&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">        page &lt;&lt; &quot;$('.quote_supplier_name_wrapper :input').val('#{quote_supplier.name}');&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        page &lt;&lt; &quot;$('.quote_supplier_name_wrapper').hide();&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">        # page &lt;&lt; &quot;$('#quote_supplier_email').attr('disabled',true)&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">      render :update do |page|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">        page &lt;&lt; &quot;$('.quote_supplier_name_wrapper :input,.quote_supplier_email_wrapper :input').val('');&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">        page &lt;&lt; &quot;$('.quote_supplier_name_wrapper').show();&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">        # page &lt;&lt; &quot;$('#quote_supplier_email').attr('disabled',false)&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  def activate</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="35">
          <span class="hits">8</span>
          
          <code class="ruby">    @quote_response ||= QuoteResponse.find(params[:id])</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="36">
          <span class="hits">8</span>
          
          <code class="ruby">    @contact ||= Contact.new(:email =&gt; @quote_response.quote_supplier.email)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="37">
          <span class="hits">8</span>
          
          <code class="ruby">    @address ||= Address.new</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="38">
          <span class="hits">8</span>
          
          <code class="ruby">    @supplier ||= Supplier.new(:name =&gt; @quote_response.quote_supplier.name)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="39">
          <span class="hits">8</span>
          
          <code class="ruby">    @title = translate('quotes_controller.activate_supplier')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="47">
          <span class="hits">6</span>
          
          <code class="ruby">    @quote_response = QuoteResponse.find(params[:id])</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="48">
          <span class="hits">6</span>
          
          <code class="ruby">    @supplier = Supplier.new(params[:supplier])</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="49">
          <span class="hits">6</span>
          
          <code class="ruby">    @contact = @supplier.build_primary_contact(params[:contact])</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="50">
          <span class="hits">6</span>
          
          <code class="ruby">    @address = @supplier.build_primary_address(params[:address])</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="51">
          <span class="hits">6</span>
          
          <code class="ruby">    address_valid = Address.empty_address?(params[:address]) ? true : @address.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    if @contact.save(:validate=&gt;false) &amp;&amp;</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="54">
          <span class="hits">6</span>
          
          <code class="ruby">       address_valid &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">       @supplier.save &amp;&amp; @supplier.publish!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">       </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">       if coupa_connect_enabled? &amp;&amp; params[:coupa_checkout] != nil &amp;&amp; params[:coupa_checkout][:invite] == '1' &amp;&amp; @supplier.connect_invitable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">         company_name = Setup.where( 'setup.key = ?', 'company name' ).first().value</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">         @email_text = &quot;&lt;p&gt;#{translate('quotes_controller.company_name_would_like_to', :company_name =&gt; company_name)}&lt;/p&gt;&lt;p&gt;#{current_user.fullname}&lt;br /&gt;#{company_name}&lt;/p&gt;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">         invite_to_coupa_connect(@supplier, current_user.email, @email_text)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">         @supplier.coupa_connect_status = 'Invited'</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">         @supplier.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">       end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">      @quote_response.promote_quote_supplier(@supplier)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">      @quote_response.award!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">      flash[:notice] = translate('quotes_controller.rfq_quote_request_was_awarded', :quote_request =&gt; @quote_response.quote_request.id, :position =&gt; @quote_response.position)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">      redirect_to :action =&gt; 'view', :id =&gt; @quote_response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="70">
          <span class="hits">6</span>
          
          <code class="ruby">      activate</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="71">
          <span class="hits">6</span>
          
          <code class="ruby">      render :action =&gt; 'activate'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">  def view</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="80">
          <span class="hits">3</span>
          
          <code class="ruby">    @quote_request = QuoteRequest.find_by_id_and_supplier_view_key_and_state(params[:id], params[:supplier_view_key], 'active')</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="81">
          <span class="hits">3</span>
          
          <code class="ruby">    if @quote_request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">      @title = translate('quotes_controller.attachments_to_rfq_id', :id =&gt; @quote_request.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="84">
          <span class="hits">3</span>
          
          <code class="ruby">      flash[:warning] = translate('quotes_controller.invalid_supplier_view_request')</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="85">
          <span class="hits">3</span>
          
          <code class="ruby">      redirect_to quotes_requests_path</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">  def attachment_save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">    quote_supplier = QuoteSupplier.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">    quote_supplier.update_attribute(:logo, params[:logo])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">    render :json =&gt; { id: quote_supplier.id }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">  #  NOTE: this functionality isn't used in SS's scope</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">  #  NOTE: previous name - `auto_complete_for_quote_supplier_name`</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">  def autocomplete</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">    root = params[:term]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">    name = params[:name]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">    @suppliers = Supplier.where(:status =&gt; 'active').includes(:primary_contact).where(['lower(name) like ?',&quot;%#{root}%&quot;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">    @suppliers += QuoteNewSupplier.where('lower(name) like ?', &quot;%#{root}%&quot; )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">    @suppliers = @suppliers.sort { |x, y| x.name &lt;=&gt; y.name }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">    result_array = @suppliers.collect do |supplier|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">      {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">        :label =&gt; supplier.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">        :value =&gt; supplier.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">        :id =&gt; supplier.quote_email,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">    render :json =&gt; result_array</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="94af28d525a074966fc3f55dc6cffcc7ed651cbd">
  <div class="header">
    <h3>app/models/bid.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (C) 2007  Coupa Software Incorporated http://www.coupa.com</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class Bid &lt; QuoteResponse</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="78668c3b184544aaabe70811f383eb9d02899d16">
  <div class="header">
    <h3>app/models/bid_amount_line.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (C) 2007  Coupa Software Incorporated http://www.coupa.com</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class BidAmountLine &lt; QuoteResponseAmountLine</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="17f669229bed678ae92155e5fa2d609beba245b4">
  <div class="header">
    <h3>app/models/bid_quantity_line.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (C) 2007  Coupa Software Incorporated http://www.coupa.com</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class BidQuantityLine &lt; QuoteResponseQuantityLine</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="f68b4032435d81283bf318fcf9a2a2b1a216ce20">
  <div class="header">
    <h3>app/models/buyer_message.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>2</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class BuyerMessage &lt; QuoteMessage</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :recipients, lambda{ |message_body_id| where(:quote_message_body_id =&gt; message_body_id ) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="2bcb4dae50305d873e0e19060ed9f1d9bcc05d9a">
  <div class="header">
    <h3>app/models/pre_bid.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (C) 2007  Coupa Software Incorporated http://www.coupa.com</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class PreBid &lt; QuoteResponse</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="1f9c6ed91ba38514c3c393bb0d7036f227ed08cc">
  <div class="header">
    <h3>app/models/pre_bid_amount_line.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (C) 2007  Coupa Software Incorporated http://www.coupa.com</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class PreBidAmountLine &lt; QuoteResponseAmountLine</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="abce4b4a61d1dc318d6ad97a00d0d65f06a1ad5b">
  <div class="header">
    <h3>app/models/pre_bid_quantity_line.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (C) 2007  Coupa Software Incorporated http://www.coupa.com</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class PreBidQuantityLine &lt; QuoteResponseQuantityLine</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="1f311080e81461ef182f855ba7a02398fbad4c29">
  <div class="header">
    <h3>app/models/quote_message.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>7</b> relevant lines. 
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class QuoteMessage &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :quote_request</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :quote_message_body</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :quote_supplier</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :quote_requests_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :all_messages, joins(:quote_message_body).group(&quot;quote_message_body_id&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :all_messages_for_supplier, lambda{ |supplier_id| where(:quote_supplier_id =&gt; supplier_id ) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="0d91401fd9ef356fb9cef98887f3987236cfab7f">
  <div class="header">
    <h3>app/models/quote_message_body.rb</h3>
    <h4><span class="red">75.0 %</span> covered</h4>
    <div>
      <b>4</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class QuoteMessageBody &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :quote_messages</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def formatted_body</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">  	self.body.gsub(/\n/, '&lt;br/&gt;')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="51f910ebc7e579ba8d5a4ab407bca18c7f6ad04e">
  <div class="header">
    <h3>app/models/quote_request.rb</h3>
    <h4><span class="red">65.36 %</span> covered</h4>
    <div>
      <b>459</b> relevant lines. 
      <span class="green"><b>300</b> lines covered</span> and
      <span class="red"><b>159</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"> # Copyright (C) 2007  Coupa Software Incorporated http://www.coupa.com</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">class QuoteRequest &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  class Inactive &lt; StandardError; end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  stampable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  has_custom_fields</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  acts_as_taggable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  EVENT_TYPES                 = [:rfi, :rfq, :rfp, :auction]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  BIDDING_RULES_TYPES         = [:total_event, :any_lot, :individual_line]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  INCREMENTAL_BIDDING_RULES   = [:allow_tie_for_first_place, :require_to_improve_by]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  VIEW_SETTINGS_FOR_SUPPLIERS = [:competitive_ranking, :anonymous_best_price]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  INCREMENTAL_SIZE_TYPES      = {:percents =&gt; &quot;%&quot;, :currency =&gt; &quot;%currency%&quot;}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  LOGO_VALIDATION_EXPRESSION  = /\.jpg$|\.png$|\.jpeg$/</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  serialize :beaten_price_options</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  serialize :incremental_bidding_options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  include Attachable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  include AASM</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  before_create :initialize_supplier_view_key</code>
        </li>
      
        <li class="covered" data-hits="113" data-linenumber="21">
          <span class="hits">113</span>
          
          <code class="ruby">  after_update :notify_about_timeline_changes, :unless =&gt; Proc.new { |request| request.timeline_changed.nil? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :created_by, :class_name =&gt; &quot;User&quot;, :foreign_key =&gt; &quot;created_by&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :updated_by, :class_name =&gt; &quot;User&quot;, :foreign_key =&gt; &quot;updated_by&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  has_and_belongs_to_many :forms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :requisition_header, :counter_cache =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :commodity</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :currency</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :quote_suppliers, :order =&gt; 'name', :autosave =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :quote_existing_suppliers, :class_name =&gt; 'QuoteSupplier', :conditions =&gt; ['type = ?', 'QuoteExistingSupplier'], :order =&gt; 'name'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :quote_new_suppliers, :class_name =&gt; 'QuoteSupplier', :conditions =&gt; ['type = ?', 'QuoteNewSupplier'], :order =&gt; 'name'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :responses, :class_name =&gt; 'QuoteResponse', :dependent =&gt; :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :following_data, :class_name =&gt; 'QuoteRequestFollowOnData'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :business_partners, :class_name =&gt; 'QuoteRequestsUser', :dependent =&gt; :destroy, :order =&gt; 'attitude'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :lots, :class_name =&gt; 'QuoteRequestsLot', :dependent =&gt; :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :lines, :class_name =&gt; 'QuoteRequestLine', :dependent =&gt; :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :quote_request_lines</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :quote_request_attachments, :dependent =&gt; :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :quote_messages</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :buyer_messages</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :supplier_messages</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :quote_award, :foreign_key =&gt; :awardable_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">  has_attached_file :buyers_logo, :styles =&gt; { :normal =&gt; '150x50&gt;' }, :whiny_thumbnails =&gt; false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_protected :state</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :related_persons</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :supplier_commodity</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :timeline_changed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :event_type, presence: true</code>
        </li>
      
        <li class="covered" data-hits="359" data-linenumber="55">
          <span class="hits">359</span>
          
          <code class="ruby">  validates :quote_suppliers, :presence =&gt; {:message =&gt; I18n.translate(&quot;quotes.request_form.suppliers_minimum&quot;)}, :if =&gt; Proc.new{ |f| f.bidding? || f.prebidding_period? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :validate_buyers_logo_type</code>
        </li>
      
        <li class="covered" data-hits="122" data-linenumber="58">
          <span class="hits">122</span>
          
          <code class="ruby">  validate :validate_event_timeline_active, :on =&gt; :update, :unless =&gt; Proc.new { |q| q.inactive? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  validate :validate_weights_are_correct</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="63">
          <span class="hits">3</span>
          
          <code class="ruby">  scope :recent, lambda{|amount,exclude_id| where(&quot;id &lt;&gt; ?&quot;, exclude_id ||=0 ).order(&quot;id DESC&quot;).limit(amount)}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :mine,   lambda{where(:created_by =&gt; User.current_user.id)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">  acts_as_local_date_range :start_time, :end_time</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">  acts_as_local_date :created_at, :updated_at</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  # Problem attributes: tags</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">  acts_as_revisionable :include =&gt; [ {:key =&gt; :tags, :always_show =&gt; [:name]} ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_column :state</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_initial_state :draft</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_state :draft</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_state :test, :enter =&gt; [:update_dates, :deliver_mails]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_state :prod, :enter =&gt; [:update_dates, :deliver_mails]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_state :auction</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_state :complete, :enter =&gt; Proc.new {|r| r.set_end_times_to_now }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_state :template</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_state :test_auction</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_state :test_complete, :enter =&gt; Proc.new {|r| r.set_end_times_to_now }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_event :set_test do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">    transitions :from =&gt; :draft, :to =&gt; :test</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_event :set_prod do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">    transitions :from =&gt; :draft, :to =&gt; :prod</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_event :templatify do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="91">
          <span class="hits">3</span>
          
          <code class="ruby">    transitions :from =&gt; :draft, :to =&gt; :template, :guard =&gt; Proc.new{ User.current_user.authorized?(&quot;quotes/requests&quot;, &quot;templatify&quot;) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_event :set_draft do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">    transitions :from =&gt; :test,          :to =&gt; :draft</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">    transitions :from =&gt; :prod,          :to =&gt; :draft</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">    transitions :from =&gt; :auction,       :to =&gt; :draft</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">    transitions :from =&gt; :complete,      :to =&gt; :draft</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">    transitions :from =&gt; :test_auction,  :to =&gt; :draft</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">    transitions :from =&gt; :test_complete, :to =&gt; :draft</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_event :start_auction do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">    transitions :from =&gt; :test, :to =&gt; :test_auction</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">    transitions :from =&gt; :prod, :to =&gt; :auction</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_event :complete do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">    transitions :from =&gt; :prod,         :to =&gt; :complete,      :on_transition =&gt; :set_end_time_to_now</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">    transitions :from =&gt; :auction,      :to =&gt; :complete,      :on_transition =&gt; :set_end_time_to_now</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">    transitions :from =&gt; :test,         :to =&gt; :test_complete, :on_transition =&gt; :set_end_time_to_now</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">    transitions :from =&gt; :test_auction, :to =&gt; :test_complete, :on_transition =&gt; :set_end_time_to_now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">  def inactive?</code>
        </li>
      
        <li class="covered" data-hits="1342" data-linenumber="116">
          <span class="hits">1342</span>
          
          <code class="ruby">    draft? || template?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">  def notify_about_timeline_changes</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="120">
          <span class="hits">10</span>
          
          <code class="ruby">    PushMessenger.push(BiddingTriggers.channel_name(self, 'timeline_buyer'),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">                       {end_time: end_time.strftime(&quot;%m/%d/%Y %I:%M:%S %P %z&quot;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">                        start_time: start_time.strftime(&quot;%m/%d/%Y %I:%M:%S %P %z&quot;),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">                        bidding_time: bidding_time.strftime(&quot;%m/%d/%Y %I:%M:%S %P %z&quot;)})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="126">
          <span class="hits">1</span>
          
          <code class="ruby">  def set_end_time_to_now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">    self.closed_at_state = if self.prebidding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">      'prebidding'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">    elsif self.bidding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">      'bidding'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">    elsif !self.started?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">      'not_started'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">      self.closed_at_state</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">    self.end_time = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">    self.start_time = Time.now unless self.started?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">    self.bidding_time = Time.now if self.bidding_time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="141">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :prod,          where(state: 'prod'          )</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="142">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :test,          where(state: 'test'          )</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :auction,       where(state: 'auction'       )</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="144">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :complete,      where(state: 'complete'      )</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="145">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :test_auction,  where(state: 'test_auction'  )</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="146">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :test_complete, where(state: 'test_complete' )</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :template,      where(state: 'template'      )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :not_draft,     where(&quot;quote_requests.state &lt;&gt; 'draft'&quot;    )</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :not_template,  where(&quot;quote_requests.state &lt;&gt; 'template'&quot; )</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="151">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :not_inactive,  not_draft.not_template   # note: double negative because 'active' may mean something else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :not_complete,  where(&quot;quote_requests.state &lt;&gt; 'complete' and quote_requests.state &lt;&gt; 'test_complete'&quot; )</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :not_auction,   where(&quot;quote_requests.state &lt;&gt; 'auction' and quote_requests.state &lt;&gt; 'test_auction'&quot;   )</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :not_test,      where(&quot;quote_requests.state &lt;&gt; 'test' and quote_requests.state &lt;&gt; 'test_auction' and quote_requests.state &lt;&gt; 'test_complete'&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="156">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :end_time_before_now,     lambda { where(&quot;end_time &lt; ?&quot;,     Time.now.utc) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="157">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :bidding_time_before_now, lambda { where(&quot;bidding_time &lt; ?&quot;, Time.now.utc) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="158">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :start_time_before_now,   lambda { where(&quot;start_time &lt; ?&quot;,   Time.now.utc) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="160">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :only_partners, lambda { joins(:business_partners).where(:business_partners =&gt; {:user_id =&gt; User.current_user}) }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="161">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :alerts_event_start, lambda { select('quote_requests.id, quote_requests.description, quote_requests.state, quote_requests.start_time, DATEDIFF(NOW(), start_time) as date_diff, start_time as alert_date, &quot;event_start&quot; as alert_type').</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">    not_test.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">    not_inactive.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">    only_partners.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    where([&quot;start_time &gt; ?&quot;, Time.zone.now.utc]).order('start_time ASC').limit(18)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="168">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :alerts_event_end,   lambda { select('quote_requests.id, quote_requests.description, quote_requests.state, quote_requests.end_time, DATEDIFF(NOW(), end_time) as date_diff, end_time as alert_date, &quot;event_end&quot; as alert_type').</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">    not_test.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">    not_inactive.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">    only_partners.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">    where([&quot;end_time &gt; ?&quot;, Time.zone.now.utc]).order('end_time ASC').limit(18)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="175">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :alerts_auction_start, lambda { select('quote_requests.id, quote_requests.description, quote_requests.state, quote_requests.bidding_time, DATEDIFF(NOW(), bidding_time) as date_diff, bidding_time as alert_date, &quot;auction_start&quot; as alert_type').</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">    not_test.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">    not_inactive.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">    only_partners.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">    where([&quot;bidding_time &gt; ?&quot;, Time.zone.now.utc]).order('bidding_time ASC').limit(18)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="182">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :alerts_event_end_past, lambda { select('quote_requests.id, quote_requests.description, quote_requests.state, quote_requests.end_time, DATEDIFF(NOW(), end_time) as date_diff, end_time as alert_date, &quot;event_end&quot; as alert_type').</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">    not_test.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">    not_inactive.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">    only_partners.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">    where([&quot;end_time &lt;= ?&quot;, Time.zone.now.utc]).order('end_time DESC').limit(18)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">  # TODO: Use a real RTF renderer.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="190">
          <span class="hits">1</span>
          
          <code class="ruby">  class RandomCrapRenderer</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="191">
          <span class="hits">1</span>
          
          <code class="ruby">    def initialize(from_object)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">      from_object.instance_variables.each do |var|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">        self.instance_variable_set(var, from_object.instance_variable_get(var))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="196">
          <span class="hits">1</span>
          
          <code class="ruby">    def render_to_string(path)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">      eval(File.read(path))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="201">
          <span class="hits">1</span>
          
          <code class="ruby">  class &lt;&lt; self</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="202">
          <span class="hits">1</span>
          
          <code class="ruby">    def alerts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">      (alerts_event_start + alerts_event_end + alerts_auction_start + alerts_event_end_past).sort do |a, b|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">        a.date_diff.abs &lt;=&gt; b.date_diff.abs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">      end[0..17]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="208">
          <span class="hits">1</span>
          
          <code class="ruby">    def top_commodities</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">      complete.select(&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">        commodities.name                           AS commodity_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">        quote_requests.commodity_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">        quote_requests.commodity_id                AS header_commodity_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">        Sum(Coalesce(quote_requests.`savings`, 0)) AS savings,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">        (SELECT Sum(Coalesce(quote_request_lines.reporting_price_amount, 0) *</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">                    Coalesce(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">                            quote_request_lines.`quantity`, 0))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">          FROM   quote_requests</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">                INNER JOIN `quote_request_lines`</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">                        ON `quote_request_lines`.`quote_request_id` =</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">                           `quote_requests`.`id`</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">          where quote_requests.commodity_id = header_commodity_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">          GROUP  BY quote_requests.commodity_id)    AS base_amount&quot;).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">      joins([:commodity]).group(&quot;commodity_id&quot;).order(&quot;savings DESC&quot;).limit(3)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="226">
          <span class="hits">1</span>
          
          <code class="ruby">    def total_savings</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">     complete.select(&quot;Sum(Coalesce(quote_requests.`savings`, 0)) AS savings&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="230">
          <span class="hits">1</span>
          
          <code class="ruby">    def savings_project_count #I told you not to ask</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="231">
          
          
          <code class="ruby">      complete.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="234">
          <span class="hits">1</span>
          
          <code class="ruby">    def savings_event_count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="235">
          
          
          <code class="ruby">      complete.joins( &quot; LEFT OUTER JOIN taggings ON quote_requests.id = taggings.taggable_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">                           AND taggings.taggable_type = 'QuoteRequest'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">                           AND taggings.is_private = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">                            OR taggings.created_by = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">                        LEFT OUTER JOIN tags ON tags.id = taggings.tag_id&quot; ).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">              select(&quot;Count(DISTINCT tags.id) AS events_count&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="243">
          <span class="hits">1</span>
          
          <code class="ruby">    def my_savings</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="244">
          
          
          <code class="ruby">      total_savings.mine</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">   #  total_savings.where(&quot;quote_requests.created_by = #{User.current_user.id}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="248">
          <span class="hits">1</span>
          
          <code class="ruby">    def my_savings_project_count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">      complete.mine.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="252">
          <span class="hits">1</span>
          
          <code class="ruby">    def my_savings_event_count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">      savings_event_count.mine</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="257">
          <span class="hits">1</span>
          
          <code class="ruby">  def deliver_mails</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="258">
          <span class="hits">1</span>
          
          <code class="ruby">    p &quot;----------------&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="259">
          <span class="hits">1</span>
          
          <code class="ruby">    p &quot;sending mail...&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="260">
          <span class="hits">1</span>
          
          <code class="ruby">    self.quote_suppliers.each do |quote_supplier|</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="261">
          <span class="hits">3</span>
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="262">
          <span class="hits">3</span>
          
          <code class="ruby">        QuotesMailer.request_for_quotes(self, quote_supplier)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">      rescue Exception =&gt; err</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="264">
          
          
          <code class="ruby">        logger.error(err)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="265">
          
          
          <code class="ruby">        logger.error(err.backtrace.join(&quot;\n&quot;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="270">
          <span class="hits">1</span>
          
          <code class="ruby">  def suppliers_which_responded</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="271">
          
          
          <code class="ruby">    self.quote_suppliers.joins(:quote_responses).where('quote_responses.state' =&gt; 'submitted').group(&quot;quote_supplier_id&quot;).all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">  #Business partners</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="275">
          <span class="hits">1</span>
          
          <code class="ruby">  def find_or_create_creator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">    #CREATOR TO OWNER ON CLONE</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="277">
          <span class="hits">3</span>
          
          <code class="ruby">    business_partners.each do |bpid|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="278">
          
          
          <code class="ruby">      if bpid.user_id != User.current_user.id &amp;&amp; bpid.creator?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="279">
          
          
          <code class="ruby">        bpid.update_attribute(:attitude , QuoteRequestsUser::OWNER)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">    #SEARCH CURRENT USER IN BP AND SET HIM TO CREATOR</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="283">
          <span class="hits">3</span>
          
          <code class="ruby">    bp = business_partners.find_or_initialize_by_user_id(User.current_user.id)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="284">
          <span class="hits">3</span>
          
          <code class="ruby">    bp.attitude = QuoteRequestsUser::CREATOR</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="285">
          <span class="hits">3</span>
          
          <code class="ruby">    bp.quote_request_id = self.id</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="286">
          <span class="hits">3</span>
          
          <code class="ruby">    bp.save</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="287">
          <span class="hits">3</span>
          
          <code class="ruby">    self.reload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">  # Check Submitted responses</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="293">
          <span class="hits">1</span>
          
          <code class="ruby">  def any_submitted_responses?</code>
        </li>
      
        <li class="covered" data-hits="148" data-linenumber="294">
          <span class="hits">148</span>
          
          <code class="ruby">    quote_suppliers.any? { |suppl| suppl.quote_responses.any? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="297">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_follow_on_data new_element, old_element</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">    QuoteRequestFollowOnData.create(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">      :model_name =&gt; new_element.class.name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">      :followed_from_id =&gt; old_element.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">      :follower_id =&gt; new_element.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">      :quote_request_id =&gt; self.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="306">
          <span class="hits">1</span>
          
          <code class="ruby">  def clone_request clonning_type = nil</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="307">
          <span class="hits">3</span>
          
          <code class="ruby">    new_model = self.clone</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="308">
          <span class="hits">3</span>
          
          <code class="ruby">    new_model.save(:validate =&gt; false) if clonning_type == :follow</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="309">
          <span class="hits">3</span>
          
          <code class="ruby">    new_model.buyers_logo = self.buyers_logo</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="310">
          <span class="hits">3</span>
          
          <code class="ruby">    [:tags, :attachments, :business_partners, :lots].each do |method|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="311">
          <span class="hits">12</span>
          
          <code class="ruby">      self.send(method).each do |old_element|</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="312">
          <span class="hits">12</span>
          
          <code class="ruby">        new_element = old_element.clone</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="313">
          <span class="hits">12</span>
          
          <code class="ruby">        if clonning_type == :follow &amp;&amp; method == :lots</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">          new_element.save(:validate =&gt; false)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="315">
          
          
          <code class="ruby">          new_model.add_follow_on_data new_element, old_element</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="317">
          <span class="hits">12</span>
          
          <code class="ruby">        new_model.send(method) &lt;&lt; new_element</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="320">
          <span class="hits">3</span>
          
          <code class="ruby">    new_model = clone_qoute_request_attachments new_model, clonning_type</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="321">
          <span class="hits">3</span>
          
          <code class="ruby">    new_model = clone_lots new_model, clonning_type</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="322">
          <span class="hits">3</span>
          
          <code class="ruby">    new_model = clone_suppliers new_model, clonning_type</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="323">
          <span class="hits">3</span>
          
          <code class="ruby">    self.forms.each do |old_form|</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="324">
          <span class="hits">6</span>
          
          <code class="ruby">      new_model.forms &lt;&lt; old_form</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="325">
          <span class="hits">6</span>
          
          <code class="ruby">      if clonning_type == :follow</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="326">
          
          
          <code class="ruby">        new_model.add_follow_on_data old_form, old_form</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="329">
          <span class="hits">3</span>
          
          <code class="ruby">    new_model.set_draft!</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="330">
          <span class="hits">3</span>
          
          <code class="ruby">    new_model.supplier_view_key = generate_supplier_view_key</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="331">
          <span class="hits">3</span>
          
          <code class="ruby">    new_model.save(:validate =&gt; false)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="332">
          <span class="hits">3</span>
          
          <code class="ruby">    new_model.find_or_create_creator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="334">
          <span class="hits">3</span>
          
          <code class="ruby">    LineAttachments.clone new_model.id, self.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="336">
          <span class="hits">3</span>
          
          <code class="ruby">    new_model</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="339">
          <span class="hits">1</span>
          
          <code class="ruby">  def clone_qoute_request_attachments new_model, clonning_type = nil</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="340">
          <span class="hits">3</span>
          
          <code class="ruby">    self.quote_request_attachments.each do |q_r_att|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="341">
          
          
          <code class="ruby">      new_model.quote_request_attachments &lt;&lt; q_r_att.clone</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="342">
          
          
          <code class="ruby">      new_model.quote_request_attachments.last.file = q_r_att.file.clone</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="343">
          
          
          <code class="ruby">      new_model.quote_request_attachments.last.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="344">
          
          
          <code class="ruby">      if clonning_type == :follow</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="345">
          
          
          <code class="ruby">        new_model.add_follow_on_data new_model.quote_request_attachments.last, q_r_att</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="348">
          <span class="hits">3</span>
          
          <code class="ruby">    new_model</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="349">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="350">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="351">
          <span class="hits">1</span>
          
          <code class="ruby">  def clone_lots new_model, clonning_type = nil</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="352">
          <span class="hits">3</span>
          
          <code class="ruby">    new_model.lots.each_with_index do |lot, i|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="353">
          
          
          <code class="ruby">      self.lots[i].lines.each do |item|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="354">
          
          
          <code class="ruby">        line = item.clone</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="355">
          
          
          <code class="ruby">        line.quote_request = new_model</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="356">
          
          
          <code class="ruby">        if clonning_type == :follow</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="357">
          
          
          <code class="ruby">          line.save(:validate =&gt; false)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="358">
          
          
          <code class="ruby">          new_model.add_follow_on_data line, item</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="360">
          
          
          <code class="ruby">        new_model.lots[i].lines &lt;&lt; line</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby">    # in case if line are not in lot</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="364">
          <span class="hits">3</span>
          
          <code class="ruby">    self.lines.where(&quot;quote_request_lines.lot_id = 0&quot;).all.each do |old_line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="365">
          
          
          <code class="ruby">      new_line = old_line.clone</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="366">
          
          
          <code class="ruby">      if clonning_type == :follow</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="367">
          
          
          <code class="ruby">        new_line.save(:validate =&gt; false)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="368">
          
          
          <code class="ruby">        new_model.add_follow_on_data new_line, old_line</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="370">
          
          
          <code class="ruby">      new_model.lines &lt;&lt; new_line</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="372">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="373">
          <span class="hits">3</span>
          
          <code class="ruby">    new_model</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="376">
          <span class="hits">1</span>
          
          <code class="ruby">  def clone_suppliers new_model, clonning_type = nil</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="377">
          <span class="hits">3</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="378">
          <span class="hits">3</span>
          
          <code class="ruby">      self.quote_suppliers.each do |supp|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="379">
          
          
          <code class="ruby">        _supp = supp.clone</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="380">
          
          
          <code class="ruby">        _supp.logo = supp.logo</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="381">
          
          
          <code class="ruby">        _supp.quote_supplier_key = _supp.generate_quote_supplier_key</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="382">
          
          
          <code class="ruby">        if clonning_type == :follow</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="383">
          
          
          <code class="ruby">          _supp.save(:validate =&gt; false)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="384">
          
          
          <code class="ruby">          new_model.add_follow_on_data _supp, supp</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="385">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="386">
          
          
          <code class="ruby">        new_model.quote_suppliers &lt;&lt; _supp</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="388">
          <span class="hits">3</span>
          
          <code class="ruby">      new_model</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="389">
          
          
          <code class="ruby">    rescue Errno::ECONNRESET, Errno::ECONNABORTED, Errno::ETIMEDOUT, Errno::ECONNREFUSED</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="390">
          
          
          <code class="ruby">      logger.error(I18n.translate('quotes.request_form.amazon_connection_problem', :class =&gt; &quot;#{self.class.name}#clone_suppliers&quot;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="391">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="392">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="393">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="394">
          <span class="hits">1</span>
          
          <code class="ruby">  def can_be_saved_as_test_prod?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="395">
          <span class="hits">1</span>
          
          <code class="ruby">    self.validate_supplier_count &amp; self.validate_lots_lines_count &amp; self.validate_event_timeline</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="397">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="398">
          <span class="hits">1</span>
          
          <code class="ruby">  def validate_weights_are_correct</code>
        </li>
      
        <li class="covered" data-hits="358" data-linenumber="399">
          <span class="hits">358</span>
          
          <code class="ruby">    if self.weight_attachments &amp;&amp; self.weight_questionnaires &amp;&amp; self.weight_items</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="400">
          
          
          <code class="ruby">      if self.weight_attachments &lt; 0 || self.weight_attachments &gt; 100 ||</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="401">
          
          
          <code class="ruby">        self.weight_questionnaires &lt; 0 || self.weight_questionnaires &gt; 100 ||</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="402">
          
          
          <code class="ruby">        self.weight_items &lt; 0 || self.weight_items &gt; 100</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="403">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="404">
          
          
          <code class="ruby">        self.errors.add(:base, &quot;Section score weights must be integers greater than 0 and less than 100.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="405">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="407">
          
          
          <code class="ruby">      if self.weight_attachments + self.weight_questionnaires + self.weight_items != 100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="408">
          
          
          <code class="ruby">        self.errors.add(:base, &quot;Section score weights must add to 100%&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="409">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="410">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="411">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="412">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="413">
          <span class="hits">1</span>
          
          <code class="ruby">  def validate_supplier_count</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="414">
          <span class="hits">2</span>
          
          <code class="ruby">    if self.quote_suppliers.empty?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="415">
          <span class="hits">1</span>
          
          <code class="ruby">      self.errors.add(:base, I18n.translate(&quot;quotes.request_form.you_havent_added_any&quot;))</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="416">
          <span class="hits">1</span>
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="418">
          <span class="hits">1</span>
          
          <code class="ruby">      true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="419">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="420">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="421">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="422">
          <span class="hits">1</span>
          
          <code class="ruby">  def validate_lots_lines_count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="423">
          
          
          <code class="ruby">    if lines.empty? &amp;&amp; competitive_bidding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="424">
          
          
          <code class="ruby">      self.errors.add(:base, I18n.translate(&quot;quotes.request_form.you_havent_added_any_items&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="425">
          
          
          <code class="ruby">      return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="426">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="427">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="428">
          
          
          <code class="ruby">    if lots.any?{|l| l.lines.blank?}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="429">
          
          
          <code class="ruby">        self.errors.add(:base, I18n.translate(&quot;quotes.request_form.you_added_empty_lots&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="430">
          
          
          <code class="ruby">        return false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="431">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="432">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="433">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="434">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="435">
          <span class="hits">1</span>
          
          <code class="ruby">  def validate_buyers_logo_type</code>
        </li>
      
        <li class="covered" data-hits="357" data-linenumber="436">
          <span class="hits">357</span>
          
          <code class="ruby">    if (self.buyers_logo_content_type_changed? || self.new_record?) and !self.buyers_logo_file_name.blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="437">
          
          
          <code class="ruby">      unless self.buyers_logo_file_name.downcase =~ LOGO_VALIDATION_EXPRESSION</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="438">
          
          
          <code class="ruby">        self.errors.delete(:buyers_logo)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="439">
          
          
          <code class="ruby">        self.errors.add(:base, I18n.translate(&quot;quotes.request_form.buyers_logo_filetype_validation_error&quot;))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="440">
          
          
          <code class="ruby">        self.destroy_attached_files</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="441">
          
          
          <code class="ruby">        self.buyers_logo = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="442">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="443">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="444">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="445">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="446">
          <span class="hits">1</span>
          
          <code class="ruby">  def validate_event_timeline</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="447">
          
          
          <code class="ruby">    self.errors.add(:base, I18n.translate(&quot;quotes.request_form.timeline_end_time_future_validation_error&quot;)) if self.end_time.in_time_zone &lt;= Time.zone.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="448">
          
          
          <code class="ruby">    self.errors.add(:base, I18n.translate(&quot;quotes.request_form.timeline_start_time_future_validation_error&quot;)) if self.start_time.in_time_zone &lt;= Time.zone.now &amp;&amp; !self.start_on_submit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="449">
          
          
          <code class="ruby">    unless self.competitive_bidding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="450">
          
          
          <code class="ruby">      unless self.start_on_submit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="451">
          
          
          <code class="ruby">        self.errors.add(:base, I18n.translate(&quot;quotes.request_form.timeline_start_end_validation_error&quot;)) if self.start_time &gt;= self.end_time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="452">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="453">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="454">
          
          
          <code class="ruby">        self.errors.add(:base, I18n.translate(&quot;quotes.request_form.timeline_bid_time_future_validation_error&quot;)) if((self.bidding_time.in_time_zone &lt;= Time.zone.now) &amp;&amp; !self.bid_on_start)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="455">
          
          
          <code class="ruby">      if self.start_on_submit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="456">
          
          
          <code class="ruby">        self.errors.add(:base, I18n.translate(&quot;quotes.request_form.timeline_bid_end_validation_error&quot;)) if((self.bidding_time &gt;= self.end_time) &amp;&amp; !self.bid_on_start)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="457">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="458">
          
          
          <code class="ruby">        self.errors.add(:base, I18n.translate(&quot;quotes.request_form.timeline_start_bid_validation_error&quot;)) if((self.start_time &gt;= self.bidding_time) &amp;&amp; !self.bid_on_start)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="459">
          
          
          <code class="ruby">        self.errors.add(:base, I18n.translate(&quot;quotes.request_form.timeline_start_end_validation_error&quot;)) if((self.start_time &gt;= self.end_time) &amp;&amp; self.bid_on_start)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="460">
          
          
          <code class="ruby">        self.errors.add(:base, I18n.translate(&quot;quotes.request_form.timeline_bid_end_validation_error&quot;)) if((self.bidding_time &gt;= self.end_time) &amp;&amp; !self.bid_on_start)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="461">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="462">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="463">
          
          
          <code class="ruby">    !self.errors[:base].any?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="464">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="465">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="466">
          <span class="hits">1</span>
          
          <code class="ruby">  def validate_event_timeline_active</code>
        </li>
      
        <li class="covered" data-hits="39" data-linenumber="467">
          <span class="hits">39</span>
          
          <code class="ruby">    if self.competitive_bidding?</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="468">
          <span class="hits">8</span>
          
          <code class="ruby">      self.errors.add(:base, I18n.translate(&quot;quotes.request_form.timeline_bid_end_validation_error&quot;)) if self.bidding_time &gt; self.end_time</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="469">
          <span class="hits">8</span>
          
          <code class="ruby">      self.errors.add(:base, I18n.translate(&quot;quotes.request_form.timeline_bid_time_future_validation_error&quot;)) if (self.preprebidding_period? || self.prebidding_period?) &amp;&amp; (self.bidding_time &lt; Time.zone.now)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="470">
          <span class="hits">8</span>
          
          <code class="ruby">      self.errors.add(:base, I18n.translate(&quot;quotes.request_form.timeline_end_time_future_validation_error&quot;)) if self.end_time &lt; Time.zone.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="471">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="31" data-linenumber="472">
          <span class="hits">31</span>
          
          <code class="ruby">      self.errors.add(:base, I18n.translate(&quot;quotes.request_form.timeline_end_time_future_validation_error&quot;)) if self.end_time &lt; Time.zone.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="473">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="474">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="475">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="476">
          <span class="hits">1</span>
          
          <code class="ruby">  def competitive_bidding?</code>
        </li>
      
        <li class="covered" data-hits="956" data-linenumber="477">
          <span class="hits">956</span>
          
          <code class="ruby">    (self.event_type &amp;&amp; self.event_type.to_sym == :auction) || self.competitive_bidding</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="478">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="479">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="480">
          <span class="hits">1</span>
          
          <code class="ruby">  def start_time</code>
        </li>
      
        <li class="covered" data-hits="885" data-linenumber="481">
          <span class="hits">885</span>
          
          <code class="ruby">    super.try(:in_time_zone) || self.created_at.beginning_of_day + 17.hours</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="482">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="483">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="484">
          <span class="hits">1</span>
          
          <code class="ruby">  def bidding_time</code>
        </li>
      
        <li class="covered" data-hits="436" data-linenumber="485">
          <span class="hits">436</span>
          
          <code class="ruby">    super.try(:in_time_zone) || (self.created_at + 14.days).beginning_of_day + 16.hours</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="486">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="487">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="488">
          <span class="hits">1</span>
          
          <code class="ruby">  def end_time</code>
        </li>
      
        <li class="covered" data-hits="602" data-linenumber="489">
          <span class="hits">602</span>
          
          <code class="ruby">    super.try(:in_time_zone) || (self.created_at + 14.days).beginning_of_day + 17.hours</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="490">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="491">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="492">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_dates</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="493">
          
          
          <code class="ruby">    self.start_time= Time.zone.now if self.start_on_submit</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="494">
          
          
          <code class="ruby">    self.bidding_time= self.start_time if competitive_bidding? &amp;&amp; self.bid_on_start</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="495">
          
          
          <code class="ruby">    save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="496">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="497">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="498">
          <span class="hits">1</span>
          
          <code class="ruby">  def started?</code>
        </li>
      
        <li class="covered" data-hits="488" data-linenumber="499">
          <span class="hits">488</span>
          
          <code class="ruby">    self.start_time &lt;= Time.zone.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="500">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="501">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="502">
          <span class="hits">1</span>
          
          <code class="ruby">  def finished?</code>
        </li>
      
        <li class="covered" data-hits="255" data-linenumber="503">
          <span class="hits">255</span>
          
          <code class="ruby">    (self.end_time_was || self.end_time) &lt; Time.zone.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="504">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="505">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="506">
          <span class="hits">1</span>
          
          <code class="ruby">  def bidding?</code>
        </li>
      
        <li class="covered" data-hits="521" data-linenumber="507">
          <span class="hits">521</span>
          
          <code class="ruby">    !inactive? &amp;&amp; competitive_bidding? &amp;&amp; started? &amp;&amp; (bidding_time_was || bidding_time) &lt; Time.zone.now &amp;&amp; !finished?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="508">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="509">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="510">
          <span class="hits">1</span>
          
          <code class="ruby">  def item_total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="511">
          
          
          <code class="ruby">    lines.map{|line| line.total * (line.lot.try(:expected_quantity) or 1)}.sum</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="512">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="513">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="514">
          <span class="hits">1</span>
          
          <code class="ruby">  def awarded_responses</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="515">
          
          
          <code class="ruby">    responses.select{|qr| qr.quote_award.present?}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="516">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="517">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="518">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="519">
          
          
          <code class="ruby">  #  Checks if event in prebidding period</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="520">
          <span class="hits">1</span>
          
          <code class="ruby">  def prebidding_period?</code>
        </li>
      
        <li class="covered" data-hits="547" data-linenumber="521">
          <span class="hits">547</span>
          
          <code class="ruby">    unless competitive_bidding?</code>
        </li>
      
        <li class="covered" data-hits="417" data-linenumber="522">
          <span class="hits">417</span>
          
          <code class="ruby">      !inactive? &amp;&amp; started? &amp;&amp; !finished?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="523">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="130" data-linenumber="524">
          <span class="hits">130</span>
          
          <code class="ruby">      !inactive? &amp;&amp; started? &amp;&amp; !bidding? &amp;&amp; !finished?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="525">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="526">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="527">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="528">
          <span class="hits">1</span>
          
          <code class="ruby">  alias :prebidding? :prebidding_period?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="529">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="530">
          <span class="hits">1</span>
          
          <code class="ruby">  def preprebidding_period?</code>
        </li>
      
        <li class="covered" data-hits="29" data-linenumber="531">
          <span class="hits">29</span>
          
          <code class="ruby">    !inactive? &amp;&amp; !started?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="532">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="533">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="534">
          <span class="hits">1</span>
          
          <code class="ruby">  alias :preprebidding? :preprebidding_period?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="535">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="536">
          <span class="hits">1</span>
          
          <code class="ruby">  def remote_path</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="537">
          
          
          <code class="ruby">    &quot;/enter_quote_response/#{supplier_view_key}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="538">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="539">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="540">
          <span class="hits">1</span>
          
          <code class="ruby">  def remote_url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="541">
          
          
          <code class="ruby">    &quot;#{SimpleConfig.for(:application).app_url}enter_quote_response/#{supplier_view_key}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="542">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="543">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="544">
          <span class="hits">1</span>
          
          <code class="ruby">  def render_rtf_to_string(filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="545">
          
          
          <code class="ruby">    RandomCrapRenderer.new(self).render_to_string(File.join(Rails.root, 'app/views/quotes', filename + '.rrtf'))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="546">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="547">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="548">
          <span class="hits">1</span>
          
          <code class="ruby">  def to_rtf(quote_supplier = QuoteNewSupplier.new)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="549">
          
          
          <code class="ruby">    @quote_supplier = quote_supplier</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="550">
          
          
          <code class="ruby">    @quote_request = self</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="551">
          
          
          <code class="ruby">    @company_logo = Setup.lookup('company logo') || ''</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="552">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="553">
          
          
          <code class="ruby">    rtf_body = render_rtf_to_string 'quote'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="554">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="555">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="556">
          <span class="hits">1</span>
          
          <code class="ruby">  def destroyable?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="557">
          <span class="hits">1</span>
          
          <code class="ruby">    inactive?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="558">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="559">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="560">
          <span class="hits">1</span>
          
          <code class="ruby">  def award(requisition_lines = [])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="561">
          
          
          <code class="ruby">    if requisition_lines.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="562">
          
          
          <code class="ruby">      requestion_lines.each do |requisition_line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="563">
          
          
          <code class="ruby">        requisition_line.create_quote_award</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="564">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="565">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="566">
          
          
          <code class="ruby">      self.create_quote_award</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="567">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="568">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="569">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="570">
          <span class="hits">1</span>
          
          <code class="ruby">  def edit_quote_suppliers _params</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="571">
          <span class="hits">2</span>
          
          <code class="ruby">    self.remove_quote_suppliers(_params[:quote_suppliers])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="572">
          <span class="hits">2</span>
          
          <code class="ruby">    self.update_quote_suppliers(_params[:quote_suppliers])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="573">
          <span class="hits">2</span>
          
          <code class="ruby">    self.create_quote_suppliers(_params[:new_quote_suppliers])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="574">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="575">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="576">
          <span class="hits">1</span>
          
          <code class="ruby">  def remove_quote_suppliers _quote_suppliers</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="577">
          <span class="hits">2</span>
          
          <code class="ruby">    keys = _quote_suppliers.nil? ? 0 : _quote_suppliers.try(:keys)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="578">
          <span class="hits">4</span>
          
          <code class="ruby">    ids = self.quote_suppliers.where([&quot;id NOT IN (?)&quot;, keys]).map{ |qs| qs.id }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="579">
          <span class="hits">2</span>
          
          <code class="ruby">    self.quote_suppliers.where([&quot;id IN (?)&quot;, ids]).destroy_all</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="580">
          <span class="hits">2</span>
          
          <code class="ruby">    self.quote_suppliers.reload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="581">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="582">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="583">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_quote_suppliers _quote_suppliers</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="584">
          <span class="hits">2</span>
          
          <code class="ruby">    ids = _quote_suppliers.nil? ? [] : _quote_suppliers.try(:keys).collect{|id| id.to_i}</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="585">
          <span class="hits">2</span>
          
          <code class="ruby">    self.quote_suppliers.select{ |qs| ids.include? qs.id }.try(:each) do |qs|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="586">
          
          
          <code class="ruby">      _quote_supplier = _quote_suppliers[qs.id.to_s]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="587">
          
          
          <code class="ruby">      _attributes = _quote_supplier.select{ |key, val| [:name, :contact_name, :email].include? key.to_sym }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="588">
          
          
          <code class="ruby">      qs.update_attributes(_attributes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="589">
          
          
          <code class="ruby">      qs.update_logo(_quote_supplier)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="590">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="591">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="592">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="593">
          <span class="hits">1</span>
          
          <code class="ruby">  def create_quote_suppliers  _new_quote_suppliers</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="594">
          <span class="hits">2</span>
          
          <code class="ruby">    _new_quote_suppliers.try(:each) do |nqs|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="595">
          
          
          <code class="ruby">      _attributes = nqs.select{|key, val| [:supplier_id, :name, :contact_name, :email].include? key.to_sym}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="596">
          
          
          <code class="ruby">      quote_supplier = self.quote_suppliers.create(_attributes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="597">
          
          
          <code class="ruby">      if quote_supplier.errors.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="598">
          
          
          <code class="ruby">        self.quote_suppliers.select{ |qs| qs.id == quote_supplier.id }.first.update_logo(nqs)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="599">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="600">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="601">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="602">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="603">
          <span class="hits">1</span>
          
          <code class="ruby">  def fill_suppliiers_responses suppliers_ids</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="604">
          
          
          <code class="ruby">    self.quote_suppliers.select{ |s| suppliers_ids.include? s.id }.each do |supplier|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="605">
          
          
          <code class="ruby">      following_data = self.following_data.quote_suppliers.select{ |s| s.follower_id == supplier.id }.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="606">
          
          
          <code class="ruby">      if following_data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="607">
          
          
          <code class="ruby">        followed_from_supplier = following_data.model_name.constantize.find(following_data.followed_from_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="608">
          
          
          <code class="ruby">        old_quote_response = followed_from_supplier.quote_responses.submitted.last</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="609">
          
          
          <code class="ruby">        old_quote_response.clone_response(supplier, self) if old_quote_response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="610">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="611">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="612">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="613">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="614">
          <span class="hits">1</span>
          
          <code class="ruby">  def editable?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="615">
          <span class="hits">1</span>
          
          <code class="ruby">    inactive?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="616">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="617">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="618">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_rank_mode?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="619">
          
          
          <code class="ruby">    self.suppliers_see == &quot;competitive_ranking&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="620">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="621">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="622">
          
          
          <code class="ruby">  # TODO: refactor - move to attachments model</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="623">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="624">
          <span class="hits">1</span>
          
          <code class="ruby">  def create_quote_request_attachments _params</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="625">
          <span class="hits">8</span>
          
          <code class="ruby">    return if _params.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="626">
          
          
          <code class="ruby">      _params.reject { |p| p[&quot;file&quot;].nil? &amp;&amp; p[&quot;name&quot;].empty? &amp;&amp; p[&quot;instruction&quot;].empty? &amp;&amp; p[&quot;response_required&quot;].nil? }.each do |quote_request_attachment|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="627">
          
          
          <code class="ruby">      att = self.quote_request_attachments.build</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="628">
          
          
          <code class="ruby">      att.update_attributes quote_request_attachment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="629">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="630">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="631">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="632">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_quote_request_attachments _params</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="633">
          <span class="hits">8</span>
          
          <code class="ruby">    return if _params.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="634">
          
          
          <code class="ruby">      _params.each do |quote_request_attachment|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="635">
          
          
          <code class="ruby">      _qra = quote_request_attachments.find_by_id quote_request_attachment.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="636">
          
          
          <code class="ruby">      if quote_request_attachment.last[:mark_delete] == &quot;1&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="637">
          
          
          <code class="ruby">        _qra.file.destroy if _qra.file.exists?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="638">
          
          
          <code class="ruby">        _qra.delete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="639">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="640">
          
          
          <code class="ruby">      _qra.update_attributes quote_request_attachment.last unless _qra.nil? || _qra.frozen?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="641">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="642">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="643">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="644">
          <span class="hits">1</span>
          
          <code class="ruby">  def validate?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="645">
          
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="646">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="647">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="648">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_attachments?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="649">
          
          
          <code class="ruby">    !attachments.empty? # || lines.any? { |line| line.has_attachments? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="650">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="651">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="652">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.create_from_req(req)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="653">
          
          
          <code class="ruby">    quote_request = QuoteRequest.new(:requisition_header =&gt; req, :event_type =&gt; :rfq, :currency =&gt; User.current_user.try(:default_currency) || Currency.reporting_currency )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="654">
          
          
          <code class="ruby">    quote_request.description = &quot;Spot Bid from Req ##{req.id}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="655">
          
          
          <code class="ruby">#    req.attachable_copy_attachments_to(quote_request)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="656">
          
          
          <code class="ruby">    unless quote_request.save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="657">
          
          
          <code class="ruby">      logger.debug(&quot;QuoteRequest not saved: #{quote_request.state} #{quote_request.errors.full_messages.join(',')}}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="658">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="659">
          
          
          <code class="ruby">    for line in req.requisition_lines.find(:all, :include =&gt; :item)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="660">
          
          
          <code class="ruby">      QuoteRequestLine.create_from_req_line(line,quote_request)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="661">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="662">
          
          
          <code class="ruby">    quote_request.business_partners &lt;&lt; quote_request.business_partners.build(:attitude =&gt; &quot;creator&quot;, :user =&gt; User.current_user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="663">
          
          
          <code class="ruby">    quote_request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="664">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="665">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="666">
          <span class="hits">1</span>
          
          <code class="ruby">  def related_users</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="667">
          <span class="hits">8</span>
          
          <code class="ruby">    self.business_partners.map{ |bp| bp.user }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="668">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="669">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="670">
          <span class="hits">1</span>
          
          <code class="ruby">  def set_end_times_to_now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="671">
          
          
          <code class="ruby">    to_update = {:end_time =&gt; Time.now}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="672">
          
          
          <code class="ruby">    to_update[:bidding_time] = Time.zone.now if bidding_time &amp;&amp; bidding_time.in_time_zone &gt; Time.zone.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="673">
          
          
          <code class="ruby">    self.update_attributes(to_update)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="674">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="675">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="676">
          
          
          <code class="ruby">  # ----- Default values for &quot;Event types&quot; form -----</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="677">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="678">
          <span class="hits">1</span>
          
          <code class="ruby">  def automatic_bid_extensions</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="679">
          <span class="hits">7</span>
          
          <code class="ruby">    super.nil? ? true : super</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="680">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="681">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="682">
          <span class="hits">1</span>
          
          <code class="ruby">  def time_to_respond</code>
        </li>
      
        <li class="covered" data-hits="20" data-linenumber="683">
          <span class="hits">20</span>
          
          <code class="ruby">    super || 5</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="684">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="685">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="686">
          <span class="hits">1</span>
          
          <code class="ruby">  def beaten_price_options</code>
        </li>
      
        <li class="covered" data-hits="240" data-linenumber="687">
          <span class="hits">240</span>
          
          <code class="ruby">    super || Hash[BIDDING_RULES_TYPES.map { |type| [type, true] }]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="688">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="689">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="690">
          <span class="hits">1</span>
          
          <code class="ruby">  def suppliers_see</code>
        </li>
      
        <li class="covered" data-hits="40" data-linenumber="691">
          <span class="hits">40</span>
          
          <code class="ruby">    super || :competitive_ranking</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="692">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="693">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="694">
          <span class="hits">1</span>
          
          <code class="ruby">  def event_type</code>
        </li>
      
        <li class="covered" data-hits="2653" data-linenumber="695">
          <span class="hits">2653</span>
          
          <code class="ruby">    super.to_sym if super</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="696">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="697">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="698">
          <span class="hits">1</span>
          
          <code class="ruby">  def incremental_bidding_options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="699">
          
          
          <code class="ruby">    super || Hash[BIDDING_RULES_TYPES.map { |type|</code>
        </li>
      
        <li class="covered" data-hits="516" data-linenumber="700">
          <span class="hits">516</span>
          
          <code class="ruby">                  [type, {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="701">
          
          
          <code class="ruby">                           :allow_tie_for_first_place =&gt; 'false',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="702">
          
          
          <code class="ruby">                           :require_to_improve_by =&gt; 'true',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="703">
          
          
          <code class="ruby">                           :size =&gt; &quot;1.00&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="704">
          
          
          <code class="ruby">                           :size_type =&gt; :percents</code>
        </li>
      
        <li class="covered" data-hits="381" data-linenumber="705">
          <span class="hits">381</span>
          
          <code class="ruby">                         } ] } ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="706">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="707">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="708">
          
          
          <code class="ruby">  # ///// Default values for &quot;Event types&quot; form /////</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="709">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="710">
          <span class="hits">1</span>
          
          <code class="ruby">  def fill_banner_with_defaults</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="711">
          
          
          <code class="ruby">    # this is to avoid broken validations during dev</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="712">
          
          
          <code class="ruby">    self.update_attribute(:banner_title, I18n.translate(&quot;quote_request.default_banner_title&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="713">
          
          
          <code class="ruby">      :company_name =&gt; Setup.lookup(&quot;company name&quot;), :event_desc =&gt; self.description))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="714">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="715">
          
          
          <code class="ruby">    if self.competitive_bidding</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="716">
          
          
          <code class="ruby">      self.update_attribute(:banner_text, I18n.translate(&quot;quote_request.default_banner_text&quot;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="717">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="718">
          
          
          <code class="ruby">      self.update_attribute(:banner_text, I18n.translate(&quot;quote_request.default_nonbidding_banner_text&quot;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="719">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="720">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="721">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="722">
          
          
          <code class="ruby">  # finds the most recent responses for each supplier</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="723">
          
          
          <code class="ruby">  # TODO once QuoteResponse history is moved to another table, this won't be needed</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="724">
          <span class="hits">1</span>
          
          <code class="ruby">  def current_responses</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="725">
          <span class="hits">9</span>
          
          <code class="ruby">    supplier_responses = self.responses.order(&quot;updated_at desc&quot;).inject([]) { |memo, response| memo.map(&amp;:quote_supplier_id).include?(response.quote_supplier_id) ? memo : memo &lt;&lt; response }</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="726">
          <span class="hits">9</span>
          
          <code class="ruby">    supplier_responses.select { |r| r.submitted? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="727">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="728">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="729">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_only_feedback_user?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="730">
          
          
          <code class="ruby">    # suppliers providing responses won't be logged in as a User.current_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="731">
          
          
          <code class="ruby">    User.current_user.present? &amp;&amp; !business_partners.map{ |u| u.user }.include?(User.current_user) &amp;&amp;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="732">
          
          
          <code class="ruby">      responses.map(&amp;:feedback_users).flatten.map(&amp;:user_id).include?(User.current_user.id) # allow feedback users to see rfq...all of it...</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="733">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="734">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="735">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_access_to_view_event?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="736">
          
          
          <code class="ruby">    business_partners.map{ |u| u.user }.include?(User.current_user) || User.current_user.support_user? || is_only_feedback_user?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="737">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="738">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="739">
          <span class="hits">1</span>
          
          <code class="ruby">  def has_access_to_edit_event?</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="740">
          <span class="hits">38</span>
          
          <code class="ruby">    business_partners.select { |u| %w(creator owner).include? u.attitude }.map{ |u| u.user }.include?(User.current_user) || User.current_user.support_user? rescue false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="741">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="742">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="743">
          <span class="hits">1</span>
          
          <code class="ruby">  def can_edit_prebidding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="744">
          
          
          <code class="ruby">    ( inactive? || prebidding_period? || preprebidding_period? ) &amp;&amp; has_access_to_edit_event?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="745">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="746">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="747">
          <span class="hits">1</span>
          
          <code class="ruby">  def can_edit_bidding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="748">
          
          
          <code class="ruby">    ( inactive? || bidding? ) &amp;&amp; has_access_to_edit_event?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="749">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="750">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="751">
          <span class="hits">1</span>
          
          <code class="ruby">  def can_edit_complete?</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="752">
          <span class="hits">6</span>
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="753">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="754">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="755">
          <span class="hits">1</span>
          
          <code class="ruby">  def can_edit_responses?</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="756">
          <span class="hits">27</span>
          
          <code class="ruby">    (self.closed? || !self.has_access_to_edit_event?) ? false : true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="757">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="758">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="759">
          <span class="hits">1</span>
          
          <code class="ruby">  def closed?</code>
        </li>
      
        <li class="covered" data-hits="57" data-linenumber="760">
          <span class="hits">57</span>
          
          <code class="ruby">    self.complete? || self.test_complete? || self.finished?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="761">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="762">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="763">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="764">
          
          
          <code class="ruby">  #  Checking of any bids existence</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="765">
          
          
          <code class="ruby">  #    @return &lt;Bolean&gt; - `true` if bids for current request exists</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="766">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="767">
          <span class="hits">1</span>
          
          <code class="ruby">  def bids?</code>
        </li>
      
        <li class="covered" data-hits="18" data-linenumber="768">
          <span class="hits">18</span>
          
          <code class="ruby">    not self.responses.length.zero?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="769">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="770">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="771">
          <span class="hits">1</span>
          
          <code class="ruby">  def awarded?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="772">
          
          
          <code class="ruby">    quote_award.present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="773">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="774">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="775">
          <span class="hits">1</span>
          
          <code class="ruby">  def bidding_or_prebidding</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="776">
          
          
          <code class="ruby">    if bidding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="777">
          
          
          <code class="ruby">      :bidding</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="778">
          
          
          <code class="ruby">    elsif prebidding_period? || preprebidding_period?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="779">
          
          
          <code class="ruby">      :prebidding</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="780">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="781">
          
          
          <code class="ruby">      :you_should_be_ignoring_this_here_symbol</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="782">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="783">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="784">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="785">
          <span class="hits">1</span>
          
          <code class="ruby">  def process_incremental_bidding_options inc_bid_options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="786">
          
          
          <code class="ruby">    # Section: incremental_bidding_options</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="787">
          <span class="hits">22</span>
          
          <code class="ruby">    if inc_bid_options</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="788">
          
          
          <code class="ruby">      self.incremental_bidding_options.keys.each do |key|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="789">
          
          
          <code class="ruby">        if inc_bid_options[key]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="790">
          
          
          <code class="ruby">          inc_bid_options[key][:require_to_improve_by] ||= &quot;false&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="791">
          
          
          <code class="ruby">          inc_bid_options[key][:allow_tie_for_first_place] ||= &quot;false&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="792">
          
          
          <code class="ruby">          inc_bid_options[key] = self.incremental_bidding_options[key].merge(inc_bid_options[key])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="793">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="794">
          
          
          <code class="ruby">          inc_bid_options[key] = self.incremental_bidding_options[key]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="795">
          
          
          <code class="ruby">          inc_bid_options[key][:require_to_improve_by] = &quot;false&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="796">
          
          
          <code class="ruby">          inc_bid_options[key][:allow_tie_for_first_place] = &quot;false&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="797">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="798">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="799">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="800">
          <span class="hits">22</span>
          
          <code class="ruby">      inc_bid_options = self.incremental_bidding_options</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="801">
          <span class="hits">22</span>
          
          <code class="ruby">      inc_bid_options.keys.each do |key|</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="802">
          <span class="hits">66</span>
          
          <code class="ruby">        inc_bid_options[key][:require_to_improve_by] = &quot;false&quot;</code>
        </li>
      
        <li class="covered" data-hits="66" data-linenumber="803">
          <span class="hits">66</span>
          
          <code class="ruby">        inc_bid_options[key][:allow_tie_for_first_place] = &quot;false&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="804">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="805">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="806">
          <span class="hits">22</span>
          
          <code class="ruby">    inc_bid_options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="807">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="808">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="809">
          
          
          <code class="ruby">  # Right now the only criteria for calculating savings is that there is one</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="810">
          
          
          <code class="ruby">  # and only one response awarded. Later, this will have to be changed to account</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="811">
          
          
          <code class="ruby">  # for partial awarding.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="812">
          <span class="hits">1</span>
          
          <code class="ruby">  def savings_calculable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="813">
          
          
          <code class="ruby">    self.awarded_responses.try(:length) == 1 rescue false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="814">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="815">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="816">
          <span class="hits">1</span>
          
          <code class="ruby">  def currency_options</code>
        </li>
      
        <li class="covered" data-hits="60" data-linenumber="817">
          <span class="hits">60</span>
          
          <code class="ruby">    result = {}</code>
        </li>
      
        <li class="covered" data-hits="60" data-linenumber="818">
          <span class="hits">60</span>
          
          <code class="ruby">    INCREMENTAL_SIZE_TYPES.each do |k, v|</code>
        </li>
      
        <li class="covered" data-hits="120" data-linenumber="819">
          <span class="hits">120</span>
          
          <code class="ruby">      result[k] = k == :currency ? self.currency.code : v</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="820">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="60" data-linenumber="821">
          <span class="hits">60</span>
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="822">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="823">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="824">
          <span class="hits">1</span>
          
          <code class="ruby">  protected</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="825">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="826">
          <span class="hits">1</span>
          
          <code class="ruby">  def generate_supplier_view_key</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="827">
          <span class="hits">3</span>
          
          <code class="ruby">    Digest::SHA1.hexdigest(&quot;#{id}#{description}#{comments}#{Time.now.to_f}#{created_at}#{requisition_header_id}&quot;)[0..99]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="828">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="829">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="830">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize_supplier_view_key</code>
        </li>
      
        <li class="covered" data-hits="238" data-linenumber="831">
          <span class="hits">238</span>
          
          <code class="ruby">    self.supplier_view_key ||= generate_supplier_view_key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="832">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="833">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="834">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="ec6007caaf4fcb5392f50e5af7651012f2097bac">
  <div class="header">
    <h3>app/models/quote_request_amount_line.rb</h3>
    <h4><span class="red">45.45 %</span> covered</h4>
    <div>
      <b>22</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>12</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (C) 2007  Coupa Software Incorporated http://www.coupa.com</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class QuoteRequestAmountLine &lt; QuoteRequestLine</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.create_from_req_line(req_line)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    QuoteRequestAmountLine.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">      :description =&gt; req_line.description,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">      :price =&gt; req_line.unit_price,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      :price_currency_id =&gt; req_line.currency_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      :ship_to_address_id =&gt; req_line.requisition_header.ship_to_address_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.type_icon</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    'money'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  def attributes=(new_attributes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    new_attributes.stringify_keys!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    %w(quantity uom).each do |key|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      new_attributes[key] = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    super</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  def total(currency = price.currency)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    currency ? price.convert_to(currency) : price</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  def quantity_editable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  def quantity_based?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  def amount_based?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">  def uom_editable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  def icon</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    'service'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="a3579a1dfc1b506f257e801eea6af3ba786a323e">
  <div class="header">
    <h3>app/models/quote_request_attachment.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>10</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class QuoteRequestAttachment &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  stampable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :created_by, :class_name =&gt; &quot;User&quot;, :foreign_key =&gt; &quot;created_by&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :updated_by, :class_name =&gt; &quot;User&quot;, :foreign_key =&gt; &quot;updated_by&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :quote_request</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :quote_request_attachment_responses</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  has_attached_file :file</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :mark_delete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  def followed_from?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    QuoteRequestFollowOnData::followed_data?(self, self.quote_request).count &gt; 0 ? true : false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="5c6f8b6339ea5c1eb81aba4a9bb16a74a01a5611">
  <div class="header">
    <h3>app/models/quote_request_attachment_response.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>7</b> relevant lines. 
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class QuoteRequestAttachmentResponse &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  stampable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :quote_request_attachment</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :quote_response</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :quote_supplier</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="6">
          <span class="hits">3</span>
          
          <code class="ruby">  validates_presence_of :file_file_size, :if =&gt; Proc.new{|f| f.quote_request_attachment.response_required }, :message =&gt; I18n.translate(&quot;quote_request_attachment_response.add_required_attachment&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  has_attached_file :file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="395924abfc4454d50032491208c5ad3a8154ba06">
  <div class="header">
    <h3>app/models/quote_request_line.rb</h3>
    <h4><span class="red">66.67 %</span> covered</h4>
    <div>
      <b>54</b> relevant lines. 
      <span class="green"><b>36</b> lines covered</span> and
      <span class="red"><b>18</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (C) 2007  Coupa Software Incorporated http://www.coupa.com</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class QuoteRequestLine &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :quote_request</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :requisition_line</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :form</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :ship_to_address, :class_name =&gt; 'Address', :foreign_key =&gt; 'ship_to_address_id'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :uom</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :price_currency, :class_name =&gt; 'Currency'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :lot, :class_name =&gt; 'QuoteRequestsLot', :foreign_key =&gt; 'lot_id'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  composed_of :price, :class_name =&gt; 'Money', :mapping =&gt; [%w(price_amount amount), %w(price_currency_id currency_id)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  acts_as_list :scope =&gt; :quote_request</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_numericality_of :price_amount, :allow_blank =&gt; true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  include Attachable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  acts_as_loadable [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">    &quot;type&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    &quot;quantity&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    {'uom.code' =&gt; {:title =&gt; &quot;UOM code&quot;, :required =&gt; true, :reflection =&gt; {:lookup =&gt; true}}},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    &quot;position&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    {'price_amount' =&gt; {:title =&gt; 'Price'}},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    {'price_currency.code' =&gt; {:title =&gt; 'Currency', :reflection =&gt; {:lookup =&gt; true}}},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  # &quot;item_id&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    &quot;description&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  #  &quot;ship_to_address_id&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">    &quot;reporting_price_amount&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  ], :nested_under =&gt; &quot;quote_request&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  converts_reporting_field_for :price, :sets =&gt; :reporting_price_amount</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :update_price_currency</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_price_currency</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="35">
          <span class="hits">6</span>
          
          <code class="ruby">    self.price_currency_id = quote_request.currency_id if price_currency_id.blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :update_reporting_total</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :set_lot_id_if_blank</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">  def followed_from?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    QuoteRequestFollowOnData::followed_data?(self, self.quote_request).count &gt; 0 ? true : false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  def set_lot_id_if_blank</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="47">
          <span class="hits">6</span>
          
          <code class="ruby">    self.lot_id = 0 if lot_id.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">  def type=(short_type)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="51">
          <span class="hits">3</span>
          
          <code class="ruby">    if ['quoterequestamountline', 'amount', 'service'].include?(short_type.downcase)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      super('QuoteRequestAmountLine')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="54">
          <span class="hits">3</span>
          
          <code class="ruby">      super('QuoteRequestQuantityLine')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_reporting_total</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="59">
          <span class="hits">6</span>
          
          <code class="ruby">    if reporting_price_amount &amp;&amp; reporting_price_amount.zero?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">      self.reporting_price_amount = nil</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="61">
          <span class="hits">6</span>
          
          <code class="ruby">    elsif price_amount.present?</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="62">
          <span class="hits">6</span>
          
          <code class="ruby">      self.reporting_price_amount = price.convert_to(Currency.reporting_currency)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">  def editable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    quote_request.editable?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">  def type_editable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">    editable?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">  def description_editable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    editable? &amp;&amp; item_id.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.create_from_req_line(req_line,quote_request)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">    nqrl = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">    if req_line.kind_of?(RequisitionQuantityLine)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">      nqrl = QuoteRequestQuantityLine.create_from_req_line(req_line)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">    elsif req_line.kind_of?(RequisitionAmountLine)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">      nqrl = QuoteRequestAmountLine.create_from_req_line(req_line)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">    nqrl.quote_request = quote_request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">    nqrl.requisition_line = req_line</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">    # req_line.attachable_copy_attachments_to(nqrl)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    # If the line has a form_response, then add it as a supplier-intended</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">    # text attachment on the quote request line.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">    if response = req_line.deep_send('form_response.public_labels')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">      at = AttachmentText.new(:text =&gt; '', :intent =&gt; 'Supplier')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">      response.each { |id, qa| at.text += &quot;#{qa[0]}\n* #{qa[1]}\n&quot; }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">      nqrl.attachment_links &lt;&lt; AttachmentLink.new(:attachment =&gt; at)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">    nqrl.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">  def method_missing(meth, *args, &amp;block)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="101">
          <span class="hits">3</span>
          
          <code class="ruby">    case meth.id2name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">    when /^([a-z_]+)_editable\?/</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">      respond_to?($1) &amp;&amp; quote_request.editable?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="105">
          <span class="hits">3</span>
          
          <code class="ruby">      super</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="0beb5a0addc9c34ea87ff49f37cc88ea41cf825f">
  <div class="header">
    <h3>app/models/quote_request_quantity_line.rb</h3>
    <h4><span class="red">50.0 %</span> covered</h4>
    <div>
      <b>14</b> relevant lines. 
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (C) 2007  Coupa Software Incorporated http://www.coupa.com</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class QuoteRequestQuantityLine &lt; QuoteRequestLine</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.create_from_req_line(req_line)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    QuoteRequestQuantityLine.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">      :item_id =&gt; req_line.item_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">      :description =&gt; req_line.description,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">      :quantity =&gt; req_line.quantity,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      :uom_id =&gt; req_line.uom_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      :price =&gt; req_line.unit_price,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      :price_currency_id =&gt; req_line.currency_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      :ship_to_address_id =&gt; req_line.requisition_header.ship_to_address_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.type_icon</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    'basket'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  def quantity_based?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  def amount_based?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  def total(currency = price.currency)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    tot = (price * (quantity || 0.0))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    currency ? tot.convert_to(currency) : tot</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  def icon</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    'item'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="220ac86663a72f30dcb35041b7791b513a181ce1">
  <div class="header">
    <h3>app/models/quote_requests_lot.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>5</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class QuoteRequestsLot &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :lines, :class_name =&gt; 'QuoteRequestLine', :foreign_key =&gt; 'lot_id'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :quote_request</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def followed_from?</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="5">
          <span class="hits">6</span>
          
          <code class="ruby">    QuoteRequestFollowOnData::followed_data?(self, self.quote_request).count &gt; 0 ? true : false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="5dae0fd76a6bcc2af7f8017b3dfac9b5238050cc">
  <div class="header">
    <h3>app/models/quote_requests_user.rb</h3>
    <h4><span class="yellow">85.71 %</span> covered</h4>
    <div>
      <b>14</b> relevant lines. 
      <span class="green"><b>12</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class QuoteRequestsUser &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :quote_messages, :dependent =&gt; :destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :quote_request</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :creator, where(attitude: 'creator')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  ATTITUDES = [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    CREATOR = 'creator',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    OWNER = 'owner',</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    WATCHER = 'watcher'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  ATTITUDES.each do |a|</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="16">
          <span class="hits">3</span>
          
          <code class="ruby">    define_method &quot;#{a}?&quot; do</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="17">
          <span class="hits">9</span>
          
          <code class="ruby">      self.attitude == a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="19">
          <span class="hits">3</span>
          
          <code class="ruby">    scope a.pluralize, lambda{ where(attitude: a) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def first_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    self.user.firstname</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  def last_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    self.user.lastname</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="bcfff50cf2f37f68ccb70a76e529cf50735e4784">
  <div class="header">
    <h3>app/models/quote_response.rb</h3>
    <h4><span class="red">44.03 %</span> covered</h4>
    <div>
      <b>318</b> relevant lines. 
      <span class="green"><b>140</b> lines covered</span> and
      <span class="red"><b>178</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (C) 2007  Coupa Software Incorporated http://www.coupa.com</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class QuoteResponse &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  stampable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  include AASM</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  include Attachable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  include ComparableMatrix</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :created_by, :class_name =&gt; &quot;User&quot;, :foreign_key =&gt; &quot;created_by&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :updated_by, :class_name =&gt; &quot;User&quot;, :foreign_key =&gt; &quot;updated_by&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :quote_request</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :quote_supplier, :autosave =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :form_responses, :autosave =&gt; true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :lines, :class_name =&gt; 'QuoteResponseLine', :dependent =&gt; :destroy</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :quote_request_attachment_responses, :autosave =&gt; true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :quote_response_lines</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :quote_award, :as =&gt; :awardable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :supplier, :through =&gt; :quote_supplier</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :contract</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :feedback_users, :class_name =&gt; 'QuoteResponseFeedbackUser', :dependent =&gt; :destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  # Shitty function to get feedback_users attached to all versions of this quote response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  # TODO get rid of this and all references once QuoteResponse history gets stored in another table</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  def all_feedback_users</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    QuoteResponseFeedbackUser.joins(:quote_response).where(:quote_response =&gt; {:quote_request_id =&gt; self.quote_request_id, :quote_supplier_id =&gt; self.quote_supplier_id})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  def feedback_user(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">    QuoteResponseFeedbackUser.joins(:quote_response).where(:quote_response =&gt; {:quote_request_id =&gt; self.quote_request_id, :quote_supplier_id =&gt; self.quote_supplier_id}, :user_id =&gt; user.id).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  # validates_presence_of :lines, :on =&gt; :update    # TODO: neded?!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  before_validation :set_soft_submit_on_lines</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_associated :lines</code>
        </li>
      
        <li class="covered" data-hits="88" data-linenumber="37">
          <span class="hits">88</span>
          
          <code class="ruby">  validates_presence_of :submitted_at, :if =&gt; Proc.new { |r| !r.working? || r.soft_submitted }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  # this is a tricky validation because we also want it to be checked</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  # when we transition from states 'working' to 'submitted'.</code>
        </li>
      
        <li class="covered" data-hits="88" data-linenumber="41">
          <span class="hits">88</span>
          
          <code class="ruby">  validates_presence_of :quote_supplier, :if =&gt; Proc.new { |r| !r.working? || r.soft_submitted }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  # TODO: NEEDED !!!!!! (temporary removed)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  # validates_each :form_responses,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  #                :allow_nil =&gt; true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  #                :if =&gt; Proc.new { |r| !r.working? || r.soft_submitted } do |r,a,v|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  #   if r.quote_request &amp;&amp; r.quote_request.forms.any?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  #     if r.form_responses</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  #       r.form_responses.each do |f|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  #         r.errors.add(:base, &quot;Error in Questionnaire '#{f.form.name}'. Response is invalid. Please fix.&quot;) unless f.valid?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  #       end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  #     else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  #       r.errors.add(:base, 'must be responded to if one exists')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  #     end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">  after_update  :save_lines</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">  after_save    :submit_after_soft_submitted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  def save_lines</code>
        </li>
      
        <li class="covered" data-hits="26" data-linenumber="62">
          <span class="hits">26</span>
          
          <code class="ruby">    if lines.any?</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="63">
          <span class="hits">15</span>
          
          <code class="ruby">      lines.each do |l|</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="64">
          <span class="hits">15</span>
          
          <code class="ruby">        if l.should_delete?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">          lines.delete(l) unless l.new_record?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="67">
          <span class="hits">15</span>
          
          <code class="ruby">          l.save(:validate =&gt; false) if l.new_record? || l.changed?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  # attr_human_name 'submitted_at' =&gt; 'Quote date'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">  acts_as_local_date :submitted_at</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">  acts_as_list :scope =&gt; :quote_request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_column :state</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_initial_state :working</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_state :working</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_state :submitted</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_state :archived</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_state :awarded, :enter =&gt; Proc.new { |r| r.quote_request.award! }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_event :submit do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">    transitions :from =&gt; :working, :to =&gt; :submitted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_event :archive do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">    transitions :from =&gt; :submitted, :to =&gt; :archived</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_event :set_working do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">    transitions :from =&gt; :submitted, :to =&gt; :working</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">  # aasm_event :revise do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">  #   transitions :from =&gt; :submitted, :to =&gt; :working</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">  # end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">  aasm_event :award do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">    transitions :from =&gt; :submitted, :to =&gt; :awarded</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="101">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :working,    where(state: 'working')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :submitted,  where(state: 'submitted')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :archived,   where(state: 'archived')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :bids,       where(type:  'Bid')</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">  scope :submitted_bids_by_supplier, lambda{ |supplier, request| where(quote_supplier_id: supplier.id, quote_request_id: request.id, type: 'Bid', state: 'submitted') }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="107">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :soft_submitted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">  def deliver_mails</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="110">
          <span class="hits">6</span>
          
          <code class="ruby">    self.quote_request.business_partners.each do |quote_requests_user|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">      QuotesMailer.rfq_bid_entered(self, quote_requests_user.user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">  def extend_timeline?</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="116">
          <span class="hits">5</span>
          
          <code class="ruby">    result = quote_request.automatic_bid_extensions &amp;&amp; quote_request.bidding? &amp;&amp; is_time_to_respond_left? &amp;&amp; best_price?</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="117">
          <span class="hits">5</span>
          
          <code class="ruby">    if result</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">      quote_request.update_attribute(:end_time,submitted_at + (quote_request.time_to_respond * 60).seconds)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">      PushMessenger.push(BiddingTriggers.channel_name(self.quote_request, 'timeline'), {end_time: quote_request.end_time.strftime(&quot;%m/%d/%Y %I:%M:%S %P %z&quot;)})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="121">
          <span class="hits">5</span>
          
          <code class="ruby">    result</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">  # Check is end time needed to be extended? Checks time only</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="126">
          <span class="hits">1</span>
          
          <code class="ruby">  def is_time_to_respond_left?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">    return false unless quote_request.automatic_bid_extensions</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">    (quote_request.end_time - submitted_at) &lt; (quote_request.time_to_respond * 60)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">  # Check all presets</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="133">
          <span class="hits">1</span>
          
          <code class="ruby">  def best_price?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">    price = calculate_prices</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">    (best_individual_line?(price) || best_any_lot?(price) || best_total_event?(price)) &amp;&amp; !bid_same?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">  ##</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">  # Generate obj with old and new prices to_comparable_matrix - method from comparable_matrix.rb</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">  def calculate_prices</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">    all_events_responses = self.quote_request.quote_suppliers.reject{|s| s.id == self.quote_supplier_id}.map{|s| s.quote_responses.submitted.order(:submitted_at).last}.compact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">    # add previous from current supplier</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">    all_events_responses &lt;&lt; self.quote_supplier.quote_responses[-2]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">    all_events_responses.compact!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">    old_lots, old_items = to_comparable_matrix all_events_responses</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">    new_lots, new_items = to_comparable_matrix [self]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">    { old_lots: old_lots,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">      old_items: old_items,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">      old_best_total: (old_lots+old_items).compact.sum,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">      new_lots: new_lots,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">      new_items: new_items,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">      new_best_total: (new_lots+new_items).compact.sum</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="158">
          <span class="hits">1</span>
          
          <code class="ruby">  def best_individual_line? price</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">    if quote_request.beaten_price_options[:individual_line] == &quot;true&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">      if price[:old_items].empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">        true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">        ([price[:old_items]] + [price[:new_items]]).transpose.any? do |prc|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">          if prc[1].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">            false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">          elsif prc[0].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">            true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">            prc[1] &lt; prc[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="179">
          <span class="hits">1</span>
          
          <code class="ruby">  def best_any_lot? price</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">    if quote_request.beaten_price_options[:any_lot] == &quot;true&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">      if price[:old_lots].empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">        true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">        ([price[:old_lots]] + [price[:new_lots]]).transpose.any? do |prc|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">          if prc[1].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">            false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">          elsif prc[0].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">            true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">            prc[1] &lt; prc[0]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="199">
          <span class="hits">1</span>
          
          <code class="ruby">  def best_total_event? price</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">    if quote_request.beaten_price_options[:total_event] == &quot;true&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">      if price[:old_lots].empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">        true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">        if price[:new_lots].any?{|a| a.nil?} || price[:new_items].any?{|a| a.nil?}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">          false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">          price[:old_best_total] &gt; price[:new_best_total]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="211">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby"># Check is bid the same as previous</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="216">
          <span class="hits">1</span>
          
          <code class="ruby">  def bid_same?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">    if self.quote_supplier.quote_responses.submitted.size &gt; 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">      self.quote_supplier.quote_responses.submitted[-2].lines.map(&amp;:price_amount) == self.quote_supplier.quote_responses.submitted[-1].lines.map(&amp;:price_amount)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="224">
          <span class="hits">1</span>
          
          <code class="ruby">  def push_bids</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="225">
          <span class="hits">6</span>
          
          <code class="ruby">    PushMessenger.push(BiddingTriggers.channel_name(self.quote_request, 'suppliers'), &quot;{}&quot;)</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="226">
          <span class="hits">6</span>
          
          <code class="ruby">    Quotes::BiddingResponsesGraphController.new.bids(self.quote_request.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="228">
          <span class="hits">6</span>
          
          <code class="ruby">    PushMessenger.push(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">      BiddingTriggers.channel_name(self.quote_request, 'suppliers_graph'),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">      Quotes::ExternalResponsesGraphController.new.push(self.quote_request)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">    # notification about first bid done</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="234">
          <span class="hits">6</span>
          
          <code class="ruby">    PushMessenger.push(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">      BiddingTriggers.channel_name(self.quote_request, &quot;first_bid_trigger&quot;), true</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="236">
          <span class="hits">6</span>
          
          <code class="ruby">    ) if self.quote_request.responses.length == 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="239">
          <span class="hits">1</span>
          
          <code class="ruby">  def soft_submit</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="240">
          <span class="hits">2</span>
          
          <code class="ruby">    self.soft_submitted = true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="241">
          <span class="hits">2</span>
          
          <code class="ruby">    set_soft_submit_on_lines # This is done now and before_validation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="244">
          <span class="hits">1</span>
          
          <code class="ruby">  def set_soft_submit_on_lines</code>
        </li>
      
        <li class="covered" data-hits="104" data-linenumber="245">
          <span class="hits">104</span>
          
          <code class="ruby">    self.lines.each{|l|l.soft_submitted = self.soft_submitted} # So they can do more validations against this</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="248">
          <span class="hits">1</span>
          
          <code class="ruby">  def editable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">    working? || submitted?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">  # like regular total but it factors in the counts on lots</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="253">
          <span class="hits">1</span>
          
          <code class="ruby">  def item_total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="254">
          
          
          <code class="ruby">    self.lines.map{|line| line.total * (line.try(:quote_request_line).try(:lot).try(:expected_quantity) or 1)}.sum</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="256">
          <span class="hits">1</span>
          
          <code class="ruby">  def total(currency = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">    self.lines.find(:all).sum(nil) { |line| line.total(currency) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="260">
          <span class="hits">1</span>
          
          <code class="ruby">  def requisition_header</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">    quote_request.requisition_header</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="264">
          <span class="hits">1</span>
          
          <code class="ruby">  def build_form_response_from_form</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="265">
          <span class="hits">15</span>
          
          <code class="ruby">    if quote_request &amp;&amp; quote_request.forms.any? # We have a backing form</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="266">
          <span class="hits">15</span>
          
          <code class="ruby">      quote_request.forms.each do |f|</code>
        </li>
      
        <li class="covered" data-hits="30" data-linenumber="267">
          <span class="hits">30</span>
          
          <code class="ruby">        self.form_responses &lt;&lt; f.form_responses.build</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="272">
          <span class="hits">1</span>
          
          <code class="ruby">  def form_response_attributes=(new_form_response_attributes)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">    # build_form_response_from_form  # NEEEDDD ?????</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">    # if self.form_responses</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">    #   self.form_responses.each do |f|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">    #     f.attributes = new_form_response_attributes  # TODO: FIXXXX !!!!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">    #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="281">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize_form_responses(do_save = false)</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="282">
          <span class="hits">10</span>
          
          <code class="ruby">    build_form_response_from_form</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="283">
          <span class="hits">10</span>
          
          <code class="ruby">    self.lines.each do |line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="284">
          
          
          <code class="ruby">      line.initialize_form_response(do_save)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="288">
          <span class="hits">1</span>
          
          <code class="ruby">  def promote_quote_supplier(supplier)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="289">
          
          
          <code class="ruby">    self.quote_supplier.update_attribute(:type, 'QuoteExistingSupplier')</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="290">
          
          
          <code class="ruby">    self.quote_supplier.attributes = { :supplier_id =&gt; supplier.id }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="291">
          
          
          <code class="ruby">    self.quote_supplier.save(:validate =&gt; false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="294">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_quote_response_lines(options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">    self.quote_request.lines.each do |request_line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="296">
          
          
          <code class="ruby">      response_line = request_line.class.name.sub('Request', 'Response').constantize.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="297">
          
          
          <code class="ruby">      attributes_to_copy = ['quantity', 'uom_id', 'item_id', 'description', 'fob', 'lead_time', 'lot_id', 'weight', 'ship_to_address_id', 'price_currency_id']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">      attributes_to_copy += ['price_amount'] unless options[:for_supplier]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">      response_line.attributes = request_line.attributes.only(*attributes_to_copy).merge(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">          'quote_request_line_id' =&gt; request_line.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">          'quote_response' =&gt; self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="303">
          
          
          <code class="ruby">      self.lines &lt;&lt; response_line</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="304">
          
          
          <code class="ruby">    end if self.quote_request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="307">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_quote_response_lines_by_copy(copy_from_response_id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="308">
          <span class="hits">1</span>
          
          <code class="ruby">    QuoteResponse.find(copy_from_response_id).lines.each do |old_response_line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="309">
          
          
          <code class="ruby">      old_quote_request_line = old_response_line.quote_request_line</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="310">
          
          
          <code class="ruby">      new_response_line = old_response_line.clone</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="312">
          
          
          <code class="ruby">      followed_from_data = QuoteRequestFollowOnData.followed_from_data? old_quote_request_line, self.quote_request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="313">
          
          
          <code class="ruby">      unless followed_from_data.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">        follower = followed_from_data.first.model_name.constantize.find_by_id(followed_from_data.first.follower_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="315">
          
          
          <code class="ruby">        next if follower.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="316">
          
          
          <code class="ruby">        new_response_line.quote_request_line_id = followed_from_data.first.follower_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="317">
          
          
          <code class="ruby">        old_lot = QuoteRequestsLot.find_by_id new_response_line.lot_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="318">
          
          
          <code class="ruby">        lots_followed_from_data = QuoteRequestFollowOnData.followed_from_data? old_lot, self.quote_request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="319">
          
          
          <code class="ruby">        new_response_line.lot_id = lots_followed_from_data.first.follower_id unless lots_followed_from_data.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="322">
          
          
          <code class="ruby">      self.lines &lt;&lt; new_response_line</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="323">
          
          
          <code class="ruby">      self.lines.last.image = old_response_line.image</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="325">
          
          
          <code class="ruby">      if self.instance_of? Bid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="326">
          
          
          <code class="ruby">        self.lines.last.type = old_response_line.type.sub('PreBid', 'Bid')</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="332">
          <span class="hits">1</span>
          
          <code class="ruby">  def add_quote_response_lines(options = {})</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="333">
          <span class="hits">8</span>
          
          <code class="ruby">    self.quote_request.lines.each do |request_line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="334">
          
          
          <code class="ruby">      response_line = request_line.class.name.sub('QuoteRequest', self.class.name).constantize.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="335">
          
          
          <code class="ruby">      attributes_to_copy = ['quantity', 'lot_id', 'weight']</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="336">
          
          
          <code class="ruby">      response_line.attributes = request_line.attributes.only(*attributes_to_copy).merge(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">        'quote_request_line_id' =&gt; request_line.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby">        'quote_response' =&gt; self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="340">
          
          
          <code class="ruby">      self.lines &lt;&lt; response_line</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="341">
          <span class="hits">8</span>
          
          <code class="ruby">    end if self.quote_request</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="344">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.create_from_quote_request(quote_request, options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="345">
          
          
          <code class="ruby">    created_response = quote_request.responses.create</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="346">
          
          
          <code class="ruby">    created_response.quote_request = quote_request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="347">
          
          
          <code class="ruby">    created_response.save(:validate =&gt; false)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="348">
          
          
          <code class="ruby">    created_response.add_quote_response_lines(:for_supplier =&gt; options[:for_supplier])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="349">
          
          
          <code class="ruby">    created_response.lines(true)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="350">
          
          
          <code class="ruby">    created_response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="353">
          <span class="hits">1</span>
          
          <code class="ruby">  def can_add_and_remove_lines?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="354">
          
          
          <code class="ruby">    User.current_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="355">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="356">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="357">
          <span class="hits">1</span>
          
          <code class="ruby">  def response_line_attributes=(new_response_line_attributes)</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="358">
          <span class="hits">17</span>
          
          <code class="ruby">    (new_response_line_attributes || {}).each do |pair_or_params|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="359">
          
          
          <code class="ruby">      if pair_or_params.is_a?(Hash)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="360">
          
          
          <code class="ruby">        response_line_params = pair_or_params</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby">      elsif pair_or_params.is_a?(Array)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="362">
          
          
          <code class="ruby">        response_line_params = pair_or_params.last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="364">
          
          
          <code class="ruby">      if response_line_params.delete(:new_record)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="365">
          
          
          <code class="ruby">        form_response_attributes = response_line_params.delete(:form_response_attributes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="366">
          
          
          <code class="ruby">        response_line = response_line_params[:type].classify.constantize.new(response_line_params.merge(:quote_response =&gt; self))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="367">
          
          
          <code class="ruby">        response_line.form_response_attributes = form_response_attributes</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="368">
          
          
          <code class="ruby">        lines &lt;&lt; response_line</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby">#        response_line = response_lines.build(response_line_params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="370">
          
          
          <code class="ruby">      elsif response_line = lines.detect{|p| p.id.to_s == response_line_params[:id].to_s}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="371">
          
          
          <code class="ruby">        if response_line.class.to_s != response_line_params[:type].classify.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="372">
          
          
          <code class="ruby">          raise &quot;We don't support changing line types anymore. sorry.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="373">
          
          
          <code class="ruby">          # TODO: support this again. sorry</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby">          # response_line.update_attribute(:type, response_line_params[:type])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby">          # line = self.lines.find(line_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="376">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="377">
          
          
          <code class="ruby">        response_line.attributes = response_line_params</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="378">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="379">
          
          
          <code class="ruby">        logger.error(&quot;No response_line exists with id=#{response_line_params[:id]}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="381">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="382">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="383">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="384">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_quote_request_attachments_by_user params, user</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="385">
          <span class="hits">17</span>
          
          <code class="ruby">    quote_request_attachments = self.quote_request.quote_request_attachments.reject { |qra| !qra.allow_to_respond }</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="386">
          <span class="hits">17</span>
          
          <code class="ruby">    quote_request_attachments.each do |qra|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="387">
          
          
          <code class="ruby">      quote_request_attachment_response = self.quote_request_attachment_responses.find_by_quote_request_attachment_id qra.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="388">
          
          
          <code class="ruby">      file = (params &amp;&amp; params[qra.id.to_s] &amp;&amp; params[qra.id.to_s][:response]) ? params[qra.id.to_s][:response] : nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="389">
          
          
          <code class="ruby">      if quote_request_attachment_response &amp;&amp; params &amp;&amp; params[qra.id.to_s] &amp;&amp; params[qra.id.to_s][:delete].to_i == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="390">
          
          
          <code class="ruby">        if quote_request_attachment_response.file.exists?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="391">
          
          
          <code class="ruby">          quote_request_attachment_response.file.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="392">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="393">
          
          
          <code class="ruby">        quote_request_attachment_response.delete</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="394">
          
          
          <code class="ruby">        quote_request_attachment_response = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">      elsif quote_request_attachment_response &amp;&amp; !file.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="396">
          
          
          <code class="ruby">        quote_request_attachment_response.update_attribute(:file, file)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="397">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="398">
          
          
          <code class="ruby">      if !quote_request_attachment_response</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="399">
          
          
          <code class="ruby">        self.quote_request_attachment_responses.create(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="400">
          
          
          <code class="ruby">          :quote_request_attachment_id =&gt; qra.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="401">
          
          
          <code class="ruby">          :quote_supplier_id =&gt; user.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="402">
          
          
          <code class="ruby">          :file =&gt; file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="403">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="405">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="407">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="408">
          
          
          <code class="ruby">  # warning: big scary block of crazycode</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="409">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.bid_data_lines(responses)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="410">
          
          
          <code class="ruby">    response_lines = responses.compact.map(&amp;:lines)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="411">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="412">
          
          
          <code class="ruby">    lines_data = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="413">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="414">
          
          
          <code class="ruby">    #converts a list of response_lines into the data format I need.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby">    # that format is:</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="416">
          
          
          <code class="ruby">    # [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby">    #   [item name, supplier0's price, supplier1's price, ... , supplier_n's price],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="418">
          
          
          <code class="ruby">    #   [item name, supplier0's price, supplier1's price, ..., supplier_n's price],  ....</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="419">
          
          
          <code class="ruby">    # ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="420">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="421">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="422">
          
          
          <code class="ruby">    response_lines.first.each_index do |j| # only works because all response lines are the same size</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="423">
          
          
          <code class="ruby">      line_row = [ response_lines[0][j].quote_request_line.description ] # only works because all the response lines should be in the same order</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="424">
          
          
          <code class="ruby">      response_lines.each_index do |i|                                   # ie have the same descriptionn</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="425">
          
          
          <code class="ruby">        line_row &lt;&lt; response_lines[i][j].total</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="426">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="427">
          
          
          <code class="ruby">      lines_data &lt;&lt; line_row</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="428">
          
          
          <code class="ruby">    end if response_lines.any?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="429">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="430">
          
          
          <code class="ruby">    lines_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="431">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="432">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="433">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.attachment_data_lines(responses)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="434">
          
          
          <code class="ruby">    attachment_data_lines = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="435">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="436">
          
          
          <code class="ruby">    attachment_data = responses.map(&amp;:quote_request_attachment_responses)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="437">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="438">
          
          
          <code class="ruby">    # seed with request data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="439">
          
          
          <code class="ruby">    attachment_data.first.each do |attdat|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="440">
          
          
          <code class="ruby">     attachment_data_lines &lt;&lt; [attdat.quote_request_attachment]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="441">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="442">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="443">
          
          
          <code class="ruby">    attachment_data.each_index do |i|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="444">
          
          
          <code class="ruby">      attachment_data[i].each_index do |j|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="445">
          
          
          <code class="ruby">        attachment_data_lines[j] &lt;&lt; attachment_data[i][j]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="446">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="447">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="448">
          
          
          <code class="ruby">    attachment_data_lines</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="449">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="450">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="451">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="452">
          
          
          <code class="ruby">  # ABANDON HOPE, ALL YE WHO ENTER</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="453">
          
          
          <code class="ruby">  # Warning: bigger, scarrier block of craziercode</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="454">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="455">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.questionnaire_data_lines(responses)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="456">
          
          
          <code class="ruby">    form_data = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="457">
          
          
          <code class="ruby">    forms     = responses.compact.map(&amp;:form_responses)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="458">
          
          
          <code class="ruby">    by_form   = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="459">
          
          
          <code class="ruby">    questionnaires_data = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="460">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="461">
          
          
          <code class="ruby">    # the database stores each response grouped by supplier. I want it grouped by questionnaire instead</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="462">
          
          
          <code class="ruby">    forms.each_index do |i|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="463">
          
          
          <code class="ruby">      forms[i].each_index do |j|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="464">
          
          
          <code class="ruby">        by_form[j] ||= []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="465">
          
          
          <code class="ruby">        by_form[j] &lt;&lt; forms[i][j]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="466">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="467">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="468">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="469">
          
          
          <code class="ruby">    # first, save the title of the questionnaire, since we otherwise won't be able to get this data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="470">
          
          
          <code class="ruby">    # second, convert each line of by_form from a form_responses object into an array of their actual response data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="471">
          
          
          <code class="ruby">    by_form.map! { |form| {:title =&gt; form.first.form.name, :responses =&gt; form.map(&amp;:responses)} }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="472">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="473">
          
          
          <code class="ruby">    by_form.each do |form|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="474">
          
          
          <code class="ruby">      questionnaire = ({:title =&gt; form[:title]} ) #save the title to the questionnaires_data varible, since that's what we're returning</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="475">
          
          
          <code class="ruby">      questionnaire_data = []  #this is going to be the collection of response lines for this specific questionnaire</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="476">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="477">
          
          
          <code class="ruby">      form[:responses].first.each do |ea|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="478">
          
          
          <code class="ruby">        questionnaire_data &lt;&lt; [ea[:prompt]] # save the field names for each line</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="479">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="480">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="481">
          
          
          <code class="ruby">      # more data shuffling</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="482">
          
          
          <code class="ruby">      form[:responses].each_index do |i|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="483">
          
          
          <code class="ruby">        form[:responses][i].each_index do |j|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="484">
          
          
          <code class="ruby">          questionnaire_data[j] &lt;&lt; form[:responses][i][j][:responses]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="485">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="486">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="487">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="488">
          
          
          <code class="ruby">      questionnaire[:response_lines] = questionnaire_data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="489">
          
          
          <code class="ruby">      questionnaires_data &lt;&lt; questionnaire</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="490">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="491">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="492">
          
          
          <code class="ruby">    questionnaires_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="493">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="494">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="495">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="496">
          <span class="hits">1</span>
          
          <code class="ruby">  api_out [:quote_request_id,:comments,:submitted_at,:quote_supplier,:state,:position]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="497">
          <span class="hits">1</span>
          
          <code class="ruby">  def award(response_lines = [])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="498">
          <span class="hits">1</span>
          
          <code class="ruby">    if response_lines.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="499">
          
          
          <code class="ruby">      Array(response_lines).each do |line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="500">
          
          
          <code class="ruby">        line = QuoteResponseLine.find(line) if !line.is_a?(QuoteResponseLine)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="501">
          
          
          <code class="ruby">        line.create_quote_award</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="502">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="503">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="504">
          <span class="hits">1</span>
          
          <code class="ruby">      self.create_quote_award</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="505">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="506">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="507">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="508">
          <span class="hits">1</span>
          
          <code class="ruby">  def create_supplier_items(contract = nil)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="509">
          <span class="hits">3</span>
          
          <code class="ruby">    lines_to_flip =[]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="510">
          <span class="hits">3</span>
          
          <code class="ruby">    if quote_award.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="511">
          
          
          <code class="ruby">      lines_to_flip = quote_response_lines</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="512">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="513">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="514">
          <span class="hits">3</span>
          
          <code class="ruby">    lines_to_flip.each do |line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="515">
          
          
          <code class="ruby">      line.flip_to_supplier_item(supplier, contract)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="516">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="517">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="518">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="519">
          <span class="hits">1</span>
          
          <code class="ruby">  def all_supplier_items_added?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="520">
          
          
          <code class="ruby">    quote_response_lines.all?{ |line| line.supplier_item.present? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="521">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="522">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="523">
          <span class="hits">1</span>
          
          <code class="ruby">  def all_supplier_items_and_on_contract?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="524">
          
          
          <code class="ruby">    quote_response_lines.all?{ |line| line.supplier_item.present? &amp;&amp; line.supplier_item.contract.present? }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="525">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="526">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="527">
          <span class="hits">1</span>
          
          <code class="ruby">  def calculate_savings</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="528">
          
          
          <code class="ruby">    (quote_request.item_total || Money.zero) - (total || Money.zero)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="529">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="530">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="531">
          <span class="hits">1</span>
          
          <code class="ruby">  def savings_pct</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="532">
          
          
          <code class="ruby">    decimal_percent = (quote_request.savings || calculate_savings.amount) /</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="533">
          
          
          <code class="ruby">    (quote_request.item_total.convert_to(Currency.reporting_currency).amount || 1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="534">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="535">
          
          
          <code class="ruby">    (decimal_percent * 100).round(2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="536">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="537">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="538">
          <span class="hits">1</span>
          
          <code class="ruby">  def clone_response quote_supplier, _quote_request = nil</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="539">
          <span class="hits">1</span>
          
          <code class="ruby">    new_quote_request =  _quote_request.nil? ? self.quote_request : _quote_request</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="540">
          <span class="hits">1</span>
          
          <code class="ruby">    if new_quote_request.bidding?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="541">
          
          
          <code class="ruby">      new_quote_response = Bid.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="542">
          
          
          <code class="ruby">      new_quote_response.type = 'Bid'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="543">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="544">
          <span class="hits">1</span>
          
          <code class="ruby">      new_quote_response = PreBid.new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="545">
          <span class="hits">1</span>
          
          <code class="ruby">      new_quote_response.type = 'PreBid'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="546">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="547">
          <span class="hits">1</span>
          
          <code class="ruby">    new_quote_response.attributes = self.attributes</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="548">
          <span class="hits">1</span>
          
          <code class="ruby">    new_quote_response.state = 'working'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="549">
          <span class="hits">1</span>
          
          <code class="ruby">    new_quote_response.created_by = User.current_user.present? ? User.current_user.id : nil</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="550">
          <span class="hits">1</span>
          
          <code class="ruby">    new_quote_response.quote_request = new_quote_request</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="551">
          <span class="hits">1</span>
          
          <code class="ruby">    new_quote_response.quote_supplier = quote_supplier</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="552">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="553">
          <span class="hits">1</span>
          
          <code class="ruby">    new_quote_response.add_quote_response_lines_by_copy self.id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="554">
          <span class="hits">1</span>
          
          <code class="ruby">    new_quote_response.initialize_form_responses</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="555">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="556">
          <span class="hits">1</span>
          
          <code class="ruby">    new_quote_response.form_responses.each do |f|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="557">
          <span class="hits">2</span>
          
          <code class="ruby">      q = self.form_responses.select{|form| form.form_id == f.form_id}.first</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="558">
          <span class="hits">2</span>
          
          <code class="ruby">      f.update_attributes(:response =&gt; q.response, :form_id =&gt; q.form_id, :quote_response_id =&gt; q.quote_response_id) unless q.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="559">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="560">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="561">
          <span class="hits">1</span>
          
          <code class="ruby">    self.quote_request_attachment_responses.each do |qrar|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="562">
          
          
          <code class="ruby">      followed_from_data = QuoteRequestFollowOnData.followed_from_data? qrar.quote_request_attachment, new_quote_response.quote_request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="563">
          
          
          <code class="ruby">      unless followed_from_data.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="564">
          
          
          <code class="ruby">        follower = followed_from_data.first.model_name.constantize.find_by_id(followed_from_data.first.follower_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="565">
          
          
          <code class="ruby">        next if follower.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="566">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="567">
          
          
          <code class="ruby">      quote_request_attachment_id = followed_from_data.empty? ? qrar.quote_request_attachment_id : followed_from_data.first.follower_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="568">
          
          
          <code class="ruby">      new_quote_response.quote_request_attachment_responses.build(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="569">
          
          
          <code class="ruby">        :quote_request_attachment_id =&gt; quote_request_attachment_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="570">
          
          
          <code class="ruby">        :quote_supplier_id =&gt; qrar.quote_supplier_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="571">
          
          
          <code class="ruby">        :file =&gt; qrar.file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="572">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="573">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="574">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="575">
          <span class="hits">1</span>
          
          <code class="ruby">    new_quote_response.save(:validate =&gt; false)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="576">
          <span class="hits">1</span>
          
          <code class="ruby">    new_quote_response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="577">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="578">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="579">
          <span class="hits">1</span>
          
          <code class="ruby">  def calculate_total_feedback_score</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="580">
          
          
          <code class="ruby">    all_feedbacks = self.all_feedback_users.map(&amp;:quote_response_feedbacks).flatten</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="581">
          
          
          <code class="ruby">    attachments_ratings = all_feedbacks.select { |f| f.feedbackable_type == &quot;attachments&quot; }.map(&amp;:rating)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="582">
          
          
          <code class="ruby">    attachments_score = attachments_ratings.present? ? attachments_ratings.sum.to_f / attachments_ratings.count * (self.quote_request.weight_attachments.to_f / 100) : 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="583">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="584">
          
          
          <code class="ruby">    questionnaires_ratings = all_feedbacks.select { |f| f.feedbackable_type == &quot;questionnaires&quot; }.map(&amp;:rating)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="585">
          
          
          <code class="ruby">    questionnaires_score = questionnaires_ratings.present? ? questionnaires_ratings.sum.to_f / questionnaires_ratings.count * (self.quote_request.weight_questionnaires.to_f / 100) : 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="586">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="587">
          
          
          <code class="ruby">    items_ratings = all_feedbacks.select { |f| f.feedbackable_type == &quot;items&quot; }.map(&amp;:rating)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="588">
          
          
          <code class="ruby">    items_score = items_ratings.present? ? items_ratings.sum.to_f / items_ratings.count * (self.quote_request.weight_items.to_f / 100) : 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="589">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="590">
          
          
          <code class="ruby">    return attachments_score + questionnaires_score + items_score</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="591">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="592">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="593">
          <span class="hits">1</span>
          
          <code class="ruby">  def copy_attachments_to(other_attachable)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="594">
          
          
          <code class="ruby">    if other_attachable</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="595">
          
          
          <code class="ruby">      quote_request_attachment_responses.each do |original|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="596">
          
          
          <code class="ruby">        new_a = AttachmentFile.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="597">
          
          
          <code class="ruby">        new_a.file = original.file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="598">
          
          
          <code class="ruby">        new_a.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="599">
          
          
          <code class="ruby">        other_attachable.attachment_links.build(:attachment =&gt; new_a)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="600">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="601">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="602">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="603">
          <span class="hits">1</span>
          
          <code class="ruby">  protected</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="604">
          <span class="hits">1</span>
          
          <code class="ruby">  def submit_after_soft_submitted</code>
        </li>
      
        <li class="covered" data-hits="102" data-linenumber="605">
          <span class="hits">102</span>
          
          <code class="ruby">    self.submit! if self.soft_submitted</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="606">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="607">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="32b141e6594075511222309aa9d915cb1a06b7fe">
  <div class="header">
    <h3>app/models/quote_response_amount_line.rb</h3>
    <h4><span class="red">52.63 %</span> covered</h4>
    <div>
      <b>19</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (C) 2007  Coupa Software Incorporated http://www.coupa.com</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class QuoteResponseAmountLine &lt; QuoteResponseLine</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :clear_non_amount_fields</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  def clear_non_amount_fields</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    self.quantity = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    self.uom = nil;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  def total(convert_to_currency = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    convert_to_currency ? price.convert_to(convert_to_currency) : price</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.type_icon</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    'money'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  def quantity_based?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  def amount_based?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  def quantity_editable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  def uom_editable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  def icon</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">    'service'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="24c371991cc6b919505cc2fe3e76daaed924b6b7">
  <div class="header">
    <h3>app/models/quote_response_line.rb</h3>
    <h4><span class="red">52.88 %</span> covered</h4>
    <div>
      <b>104</b> relevant lines. 
      <span class="green"><b>55</b> lines covered</span> and
      <span class="red"><b>49</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (C) 2007  Coupa Software Incorporated http://www.coupa.com</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class QuoteResponseLine &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  stampable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :created_by, :class_name =&gt; &quot;User&quot;, :foreign_key =&gt; &quot;created_by&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :updated_by, :class_name =&gt; &quot;User&quot;, :foreign_key =&gt; &quot;updated_by&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :quote_response</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :quote_request_line</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  delegate :quote_request, :to =&gt; :quote_response</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :form_response, :autosave =&gt; true, :validate =&gt; false</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :uom  # NEED ??!! we've removed UOM from this table!</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :quote_award, :as =&gt; :awardable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  has_one :supplier_item</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :requisition_lines</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  composed_of :price, :class_name =&gt; 'Money', :mapping =&gt; [%w(price_amount amount), %w(price_currency_id currency_id)]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :update_price_currency</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_price_currency</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="20">
          <span class="hits">23</span>
          
          <code class="ruby">    self.price_currency_id = quote_request_line.price_currency_id if price_currency_id.blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">  before_save :update_uom_id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_uom_id</code>
        </li>
      
        <li class="covered" data-hits="23" data-linenumber="25">
          <span class="hits">23</span>
          
          <code class="ruby">    self.uom_id = quote_request_line.uom_id if uom_id.blank?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  acts_as_list :scope =&gt; :quote_response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  include Attachable</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :_delete</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :soft_submitted</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :skip_validation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  def should_delete?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    @_delete == 'true' || @_delete == true || @_delete == '1'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  converts_reporting_field_for :price, :sets =&gt; :reporting_price_amount</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  # before_create :default_price</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  before_validation :initialize_form_response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  has_attached_file :image,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">                    :styles =&gt; { :normal =&gt; '200x150&gt;' },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">                    :default_style =&gt; :normal,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">                    :whiny_thumbnails =&gt; false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">                    :content_type =&gt; { :content_type =&gt; [&quot;image/jpg&quot;, &quot;image/png&quot;, &quot;image/jpeg&quot;] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  # FIXME: doesnt work ((</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_each :form_response,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">                  :allow_nil =&gt; true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">                  :if =&gt; :validate? do |r,a,v|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">    v.form.widgets.each do |w|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      # if Widget is_internal re-define method respondable? and terurn false to slip validation</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      w.define_singleton_method(:respondable?){ false } if w.is_internal</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">    if r.form_response</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">      r.errors.add(:questionnaire, 'response is invalid') unless r.form_response.valid?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">  def validate?</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="66">
          <span class="hits">38</span>
          
          <code class="ruby">    self.skip_validation != true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">  attr_accessor :_delete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">  def should_delete?</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="72">
          <span class="hits">15</span>
          
          <code class="ruby">    @_delete == 'true' || @_delete == true || @_delete == '1'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">  # def default_price</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  #   self.price_amount ||= 0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  #   self.price_currency_id ||= User.current_user.default_currency.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">  def editable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">    quote_response.editable?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">  def type_editable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">    editable?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">  def description_editable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">    editable? &amp;&amp; item_id.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.type_icon</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    ''</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">  def total(currency = nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">    nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">  def requisition_line</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">    quote_request_line.requisition_line if quote_request_line</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize_form_response(do_save = false)</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="105">
          <span class="hits">38</span>
          
          <code class="ruby">    build_form_response_from_form</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="106">
          <span class="hits">38</span>
          
          <code class="ruby">    if self.form_response &amp;&amp; do_save</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">      self.skip_validation = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">      self.form_response.save(:validate =&gt; false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">  def form_response_attributes=(new_form_response_attributes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">    build_form_response_from_form</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">    if self.form_response</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">      self.form_response.attributes = new_form_response_attributes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">  def build_form_response_from_form</code>
        </li>
      
        <li class="covered" data-hits="38" data-linenumber="120">
          <span class="hits">38</span>
          
          <code class="ruby">    if quote_request_line &amp;&amp; quote_request_line.form # We have a backing form</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">      if !self.form_response || (quote_request_line.form != self.form_response.form) # Our current form is gone or wrong</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">        self.form_response = quote_request_line.form.form_responses.build</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">  def method_missing(meth, *args, &amp;block)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="129">
          <span class="hits">1</span>
          
          <code class="ruby">    case meth.id2name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">    when /^([a-z_]+)_editable\?/</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">      respond_to?($1) &amp;&amp; quote_response.editable?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="133">
          <span class="hits">1</span>
          
          <code class="ruby">      super</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">  # stub for subclass</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="138">
          <span class="hits">1</span>
          
          <code class="ruby">  def quantity_editable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">  # stub for subclass</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">  def uom_editable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.update_image lines = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">    lines.each do |id, data|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">      line = self.find(id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">      line.update_attribute(:image, data)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.update_price lines</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">    lines.each do |e|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">      e[1].each { |line| self.find(line[0]).update_attributes!({:price_amount =&gt; line[1]})}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="160">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.remove_image lines = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">    lines.each do |id, data|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">      next unless data == &quot;remove&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">      line = self.find(id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">      line.update_attribute(:image, nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="168">
          <span class="hits">1</span>
          
          <code class="ruby">  def flip_to_supplier_item(supplier, contract = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">    if supplier_item.blank? or supplier_item.new_record?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">      item_attributes = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">      item_attributes[:name]        = supplier_item_name.presence || quote_request_line.description</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">      item_attributes[:uom]         = quote_request_line.uom</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">      item_attributes[:description] = item_description.presence || quote_request_line.description</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">      item_attributes[:image]       = image</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">      supplier_item_attributes = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">      supplier_item_attributes[:supplier]               = supplier</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">      supplier_item_attributes[:price]                  = Money.new(price_amount, Currency.reporting_currency)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">      supplier_item_attributes[:preferred_flag]         = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">      supplier_item_attributes[:supplier_part_num]      = item_part_number</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">      supplier_item_attributes[:contract_id]            = contract.try(:id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">      supplier_item_attributes[:quote_response_line_id] = id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">      item = Item.create(item_attributes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">      item = Item.find_by_name(item_attributes[:name]) if item.new_record?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">   </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">      item.supplier_items.create(supplier_item_attributes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">      item.send :index_delta</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">    elsif supplier_item &amp;&amp; contract &amp;&amp; supplier_item.contract.blank?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">      supplier_item.contract = contract</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">      supplier_item.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="e195501446d1d182b8ed8504af7a0c5909a92efa">
  <div class="header">
    <h3>app/models/quote_response_lot.rb</h3>
    <h4><span class="red">12.5 %</span> covered</h4>
    <div>
      <b>16</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>14</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class QuoteResponseLot &lt; QuoteRequestsLot</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">	def self.check_lines quote_response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">		# TODO: move to VALIDATIONS</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">		message = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">		lots = self.where(:quote_request_id =&gt; quote_response.quote_request_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">		lots.each do |lot|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">			lines = quote_response.lines.where(:lot_id =&gt; lot.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">			sum = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">			invalid = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">			lines.each do |line|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">				if (line.price_amount.nil? || line.price_amount &lt; 0)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">					invalid = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">				else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">					sum += line.price_amount</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">				end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">			end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">			if invalid &amp;&amp; sum != 0 </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">				message ||= &quot;You cannot submit response with lot that has item without price. Please check Lots: &quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">				message &lt;&lt; &quot;#{lot.name}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">			end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">		end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">		message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="e063ac2c26295640ae27ff9675d8c6a579e3d8e7">
  <div class="header">
    <h3>app/models/quote_response_quantity_line.rb</h3>
    <h4><span class="red">53.85 %</span> covered</h4>
    <div>
      <b>13</b> relevant lines. 
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>6</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (C) 2007  Coupa Software Incorporated http://www.coupa.com</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class QuoteResponseQuantityLine &lt; QuoteResponseLine</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_numericality_of :quantity, :greater_than =&gt; 0,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">                            :message =&gt; 'is not a valid number'</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def quantity_based?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  def amount_based?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.type_icon</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    'basket'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def total(convert_to_currency = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    calculated_total = price * (quantity || 0.0)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    convert_to_currency ? calculated_total.convert_to(convert_to_currency) : calculated_total</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  def icon</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">    'item'</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="4f94c8e7088807404067fe2b179cc409d1da545a">
  <div class="header">
    <h3>app/models/quote_supplier.rb</h3>
    <h4><span class="red">66.67 %</span> covered</h4>
    <div>
      <b>54</b> relevant lines. 
      <span class="green"><b>36</b> lines covered</span> and
      <span class="red"><b>18</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="never" data-hits="" data-linenumber="1">
          
          
          <code class="ruby"># Copyright (C) 2007  Coupa Software Incorporated http://www.coupa.com</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class QuoteSupplier &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  stampable</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :created_by, :class_name =&gt; &quot;User&quot;, :foreign_key =&gt; &quot;created_by&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :updated_by, :class_name =&gt; &quot;User&quot;, :foreign_key =&gt; &quot;updated_by&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :quote_request</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :quote_responses</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :quote_request_attachment_responses</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  has_many :quote_messages, :dependent =&gt; :destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :supplier, :validate =&gt; true, :autosave =&gt; true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  before_create :initialize_quote_supplier_key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  has_attached_file :logo,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">                    :styles =&gt; { :normal =&gt; '180x80&gt;', :small =&gt; ['123x24',:png] },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">                    :default_style =&gt; :normal,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">                    :whiny_thumbnails =&gt; false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">                    :convert_options =&gt; {:small =&gt; &quot;-bordercolor transparent -border 50 -gravity center -crop 123x24+0+0 +repage&quot;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">                    :content_type =&gt; { :content_type =&gt; [&quot;image/jpg&quot;, &quot;image/png&quot;, &quot;image/jpeg&quot;] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">  EMAIL_VALIDATION_EXPRESSION = /^([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})$/i</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  LOGO_VALIDATION_EXPRESSION  = /\.jpg$|\.png$|\.jpeg$/</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :email, :presence =&gt; {:message =&gt; I18n.translate(&quot;quotes.request_form.suppliers_email_empty_error&quot;)}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :name, :presence =&gt; {:message =&gt; I18n.translate(&quot;quotes.request_form.suppliers_name_empty_error&quot;)}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_attachment_content_type :logo, :content_type =&gt; [&quot;image/jpg&quot;, &quot;image/png&quot;, &quot;image/jpeg&quot;], :message =&gt; I18n.translate(&quot;quotes.request_form.suppliers_logo_filetype_validation_error&quot;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">  validates_format_of :email, :with  =&gt; /^([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})$/i, :message =&gt; I18n.translate(&quot;quotes.request_form.suppliers_email_validation_error&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">  def name_editable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  def contact_name_editable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">  def email_editable?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  def destroy_if_orphaned</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    destroy if quote_request(true).empty? &amp;&amp; quote_responses(true).empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.destroy_orphans(list = find(:all))</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    list.each(&amp;:destroy_if_orphaned)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  def followed_from?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    QuoteRequestFollowOnData::followed_data?(self, self.quote_request).count &gt; 0 ? true : false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">  def generate_quote_supplier_key</code>
        </li>
      
        <li class="covered" data-hits="130" data-linenumber="57">
          <span class="hits">130</span>
          
          <code class="ruby">    Digest::SHA1.hexdigest(&quot;#{id}#{name}#{email}#{contact_name}#{Time.now.to_f}#{created_at}&quot;)[0..99]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">  def initialize_quote_supplier_key</code>
        </li>
      
        <li class="covered" data-hits="130" data-linenumber="61">
          <span class="hits">130</span>
          
          <code class="ruby">    self.quote_supplier_key ||= generate_quote_supplier_key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_logo _params</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="65">
          <span class="hits">17</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="66">
          <span class="hits">17</span>
          
          <code class="ruby">      file = false</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="67">
          <span class="hits">17</span>
          
          <code class="ruby">      if _params[:copy_logo].to_i &gt;= 1 &amp;&amp; _params[:copy_from_quote_supplier].to_i == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">        file = Supplier.find_by_id(_params[:copy_logo]).try(:logo)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      elsif _params[:copy_logo].to_i &gt;= 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">        file = QuoteSupplier.find_by_id(_params[:copy_from_quote_supplier]).try(:logo)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      elsif !_params[:logo].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">        file = _params[:logo]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      elsif _params[:clear_logo].to_i == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">        file = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="76">
          <span class="hits">17</span>
          
          <code class="ruby">      self.update_attributes(:logo =&gt; file) if file || file.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">    rescue Errno::ECONNRESET, Errno::ECONNABORTED, Errno::ETIMEDOUT, Errno::ECONNREFUSED</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">      logger.error(I18n.translate('quotes.request_form.amazon_connection_problem', :class =&gt; self.class.name))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">  def last_quote_request_response quote_request</code>
        </li>
      
        <li class="covered" data-hits="9" data-linenumber="83">
          <span class="hits">9</span>
          
          <code class="ruby">    self.quote_responses.submitted.where(:quote_request_id, quote_request).last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">  def deliver_mail</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">      QuotesMailer.request_for_quotes(self.quote_request, self)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">    rescue Exception =&gt; err</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">      logger.error(err)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">      logger.error(err.backtrace.join(&quot;\n&quot;))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">  def external_responses_key quote_request</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">    &quot;#{quote_request.supplier_view_key}#{self.quote_supplier_key}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
        <div class="source_table" id="b24902708fee803d50fddb92c02ef188b4c7a786">
  <div class="header">
    <h3>app/models/supplier_message.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>1</b> relevant lines. 
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class SupplierMessage &lt; QuoteMessage</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">	</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>
      
      </div>
    </div>
  </body>
</html>
